<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dead Letter Queue (DLQ) - Prodigy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="AI-powered workflow orchestration for development teams">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prodigy Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy/edit/main/book/src/mapreduce/dead-letter-queue-dlq.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="dead-letter-queue-dlq"><a class="header" href="#dead-letter-queue-dlq">Dead Letter Queue (DLQ)</a></h2>
<p>The Dead Letter Queue (DLQ) captures persistently failing work items for analysis and retry while allowing MapReduce jobs to continue processing other items. Instead of blocking the entire workflow when individual items fail, the DLQ provides fault tolerance and enables debugging of failure patterns.</p>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<p>When a map agent fails to process a work item after exhausting retry attempts, the item is automatically sent to the DLQ. This allows the MapReduce job to complete successfully while preserving all failure information for later investigation and reprocessing.</p>
<p>The DLQ integrates with MapReduce through the <code>on_item_failure</code> policy, which defaults to <code>dlq</code> for MapReduce workflows. Alternative policies include <code>retry</code> (immediate retry), <code>skip</code> (ignore failures), <code>stop</code> (halt workflow), and <code>custom</code> (user-defined handling).</p>
<h3 id="storage-structure"><a class="header" href="#storage-structure">Storage Structure</a></h3>
<p>DLQ data is stored in the global Prodigy directory using this structure:</p>
<pre><code>~/.prodigy/dlq/{repo_name}/{job_id}/mapreduce/dlq/{job_id}/
├── items/                  # Individual item files
│   ├── item-123.json      # DeadLetteredItem for item-123
│   ├── item-456.json      # DeadLetteredItem for item-456
│   └── ...
└── index.json             # DLQ index metadata
</code></pre>
<p>For example:</p>
<pre><code>~/.prodigy/dlq/prodigy/mapreduce-1234567890/mapreduce/dlq/mapreduce-1234567890/
├── items/
│   └── item-123.json
└── index.json
</code></pre>
<p><strong>Storage Implementation</strong>:</p>
<ul>
<li><code>GlobalStorage</code> provides the base path: <code>~/.prodigy/dlq/{repo_name}/{job_id}</code> (src/storage/global.rs:47)</li>
<li><code>DLQStorage</code> adds subdirectories: <code>mapreduce/dlq/{job_id}</code> for backward compatibility (src/cook/execution/dlq.rs:529)</li>
<li>Each failed item is stored as a separate JSON file in the <code>items/</code> directory (src/cook/execution/dlq.rs:536)</li>
<li>File naming: <code>{item_id}.json</code> (e.g., <code>item-123.json</code>)</li>
<li><code>index.json</code> maintains a list of all item IDs and metadata for fast lookups (src/cook/execution/dlq.rs:608-637)</li>
<li>Items are loaded into memory on-demand for operations</li>
</ul>
<p>This global storage architecture enables:</p>
<ul>
<li><strong>Cross-worktree access</strong>: Multiple worktrees working on the same job share DLQ data</li>
<li><strong>Persistent state</strong>: DLQ survives worktree cleanup</li>
<li><strong>Centralized monitoring</strong>: All failures accessible from a single location</li>
<li><strong>Scalability</strong>: Individual item files prevent loading entire DLQ into memory</li>
</ul>
<h3 id="dlq-item-structure"><a class="header" href="#dlq-item-structure">DLQ Item Structure</a></h3>
<p>Each failed item in the DLQ is stored as a <code>DeadLetteredItem</code> with comprehensive failure information:</p>
<pre><code class="language-json">{
  "item_id": "item-123",
  "item_data": { "file": "src/main.rs", "priority": 5 },
  "first_attempt": "2025-01-11T10:25:00Z",
  "last_attempt": "2025-01-11T10:30:00Z",
  "failure_count": 3,
  "failure_history": [
    {
      "attempt_number": 1,
      "timestamp": "2025-01-11T10:30:00Z",
      "error_type": { "CommandFailed": { "exit_code": 101 } },
      "error_message": "cargo test failed with exit code 101",
      "stack_trace": "thread 'main' panicked at src/main.rs:42...",
      "agent_id": "agent-1",
      "step_failed": "shell: cargo test",
      "duration_ms": 45000,
      "json_log_location": "/Users/user/.local/state/claude/logs/session-abc123.json"
    }
  ],
  "error_signature": "CommandFailed::cargo test failed with exit",
  "reprocess_eligible": true,
  "manual_review_required": false,
  "worktree_artifacts": {
    "worktree_path": "/Users/user/.prodigy/worktrees/prodigy/agent-1",
    "branch_name": "agent-1",
    "uncommitted_changes": "src/main.rs modified",
    "error_logs": "error.log contents..."
  }
}
</code></pre>
<h4 id="key-fields"><a class="header" href="#key-fields">Key Fields</a></h4>
<p><strong>Source</strong>: <code>DeadLetteredItem</code> struct (src/cook/execution/dlq.rs:32-43)</p>
<ul>
<li><code>item_id</code>: Unique identifier for the work item</li>
<li><code>item_data</code>: Original work item data from input JSON</li>
<li><code>first_attempt</code>: Timestamp of first failure attempt (DateTime<Utc>)</li>
<li><code>last_attempt</code>: Timestamp of most recent failure attempt (DateTime<Utc>)</li>
<li><code>failure_count</code>: Number of failed attempts (u32)</li>
<li><code>failure_history</code>: Array of <code>FailureDetail</code> objects capturing each attempt</li>
<li><code>error_signature</code>: Simplified error pattern for grouping similar failures</li>
<li><code>reprocess_eligible</code>: Whether item can be retried automatically</li>
<li><code>manual_review_required</code>: Whether item needs human intervention</li>
<li><code>worktree_artifacts</code>: Captured state from failed agent’s worktree (Optional)</li>
</ul>
<h3 id="failure-detail-fields"><a class="header" href="#failure-detail-fields">Failure Detail Fields</a></h3>
<p>Each attempt in <code>failure_history</code> is a <code>FailureDetail</code> object (src/cook/execution/dlq.rs:46-59):</p>
<pre><code class="language-json">{
  "attempt_number": 1,
  "timestamp": "2025-01-11T10:30:00Z",
  "error_type": { "CommandFailed": { "exit_code": 101 } },
  "error_message": "cargo test failed with exit code 101",
  "stack_trace": "thread 'main' panicked at src/main.rs:42...",
  "agent_id": "agent-1",
  "step_failed": "claude: /process '${item}'",
  "duration_ms": 45000,
  "json_log_location": "/path/to/claude-session.json"
}
</code></pre>
<p><strong>Field Details</strong>:</p>
<ul>
<li><code>attempt_number</code>: Sequential attempt counter (u32)</li>
<li><code>timestamp</code>: When this attempt occurred (DateTime<Utc>)</li>
<li><code>error_type</code>: Error classification (see Error Types below)</li>
<li><code>error_message</code>: Human-readable error description</li>
<li><code>stack_trace</code>: Optional detailed stack trace</li>
<li><code>agent_id</code>: ID of the agent that failed</li>
<li><code>step_failed</code>: Command string that failed (e.g., “shell: cargo test”)</li>
<li><code>duration_ms</code>: How long the attempt ran before failing (u64)</li>
<li><code>json_log_location</code>: Path to Claude JSON log for debugging (Optional, see <a href="../troubleshooting/best-practices-for-debugging.html">Best Practices for Debugging</a>)</li>
</ul>
<h4 id="error-types"><a class="header" href="#error-types">Error Types</a></h4>
<p>The <code>error_type</code> field uses the <code>ErrorType</code> enum (src/cook/execution/dlq.rs:62-71):</p>
<ul>
<li><code>Timeout</code>: Agent execution exceeded timeout</li>
<li><code>CommandFailed { exit_code: i32 }</code>: Shell or Claude command returned non-zero exit code (includes exit code for diagnostics)</li>
<li><code>WorktreeError</code>: Git worktree operation failed</li>
<li><code>MergeConflict</code>: Merge back to parent worktree failed</li>
<li><code>ValidationFailed</code>: Validation command failed</li>
<li><code>ResourceExhausted</code>: System resources (memory, disk) exhausted</li>
<li><code>Unknown</code>: Unclassified error</li>
</ul>
<p><strong>Example from tests</strong> (tests/dlq_agent_integration_test.rs:69):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>error_type: ErrorType::CommandFailed { exit_code: 1 }
<span class="boring">}</span></code></pre></pre>
<h3 id="worktree-artifacts"><a class="header" href="#worktree-artifacts">Worktree Artifacts</a></h3>
<p>The <code>WorktreeArtifacts</code> structure captures the agent’s execution environment (src/cook/execution/dlq.rs:74-80):</p>
<ul>
<li><code>worktree_path</code>: Path to agent’s isolated worktree (PathBuf)</li>
<li><code>branch_name</code>: Git branch created for agent (String)</li>
<li><code>uncommitted_changes</code>: Files modified but not committed (Option<String>)</li>
<li><code>error_logs</code>: Captured error output (Option<String>)</li>
</ul>
<p><strong>Note</strong>: Both <code>uncommitted_changes</code> and <code>error_logs</code> are stored as optional strings, not arrays. If present, they contain descriptive text about the changes/logs rather than file lists.</p>
<p>These artifacts are preserved for debugging and can be accessed after failure.</p>
<h2 id="dlq-commands"><a class="header" href="#dlq-commands">DLQ Commands</a></h2>
<blockquote>
<p><strong>⚠️ PLANNED FEATURE</strong>: The DLQ CLI commands are currently implemented as stubs that only print status messages. Full functionality is planned for a future release.</p>
<p><strong>Current Status</strong> (as of implementation):</p>
<ul>
<li>Command definitions exist in src/cli/args.rs:577-677</li>
<li>Stub implementations in src/cli/commands/dlq.rs:1-74</li>
<li>Commands will print confirmation messages but do not execute actual operations</li>
</ul>
<p>See <a href="#integration-with-mapreduce">DLQ Integration</a> for current workflow-level DLQ functionality.</p>
</blockquote>
<p>Prodigy provides comprehensive CLI commands for managing the DLQ. The following sections describe the planned command interface.</p>
<h3 id="list-command"><a class="header" href="#list-command">List Command</a></h3>
<p>View DLQ items across jobs:</p>
<pre><code class="language-bash"># List all DLQ items
prodigy dlq list

# List items for specific job
prodigy dlq list --job-id mapreduce-1234567890

# List only retry-eligible items
prodigy dlq list --eligible

# Limit results
prodigy dlq list --limit 10
</code></pre>
<h3 id="inspect-command"><a class="header" href="#inspect-command">Inspect Command</a></h3>
<p>Examine detailed information for a specific item:</p>
<pre><code class="language-bash"># Inspect item by ID
prodigy dlq inspect item-123

# Inspect item in specific job
prodigy dlq inspect item-123 --job-id mapreduce-1234567890
</code></pre>
<p>Output includes:</p>
<ul>
<li>Full item data</li>
<li>Complete failure history with all attempts</li>
<li>Error messages and stack traces</li>
<li>JSON log locations for debugging</li>
<li>Worktree artifacts</li>
</ul>
<h3 id="analyze-command"><a class="header" href="#analyze-command">Analyze Command</a></h3>
<p>Analyze failure patterns across items:</p>
<pre><code class="language-bash"># Analyze all failures
prodigy dlq analyze

# Analyze specific job
prodigy dlq analyze --job-id mapreduce-1234567890

# Export analysis results
prodigy dlq analyze --export analysis.json
</code></pre>
<p>Analysis output includes:</p>
<ul>
<li><code>pattern_groups</code>: Failures grouped by error type and message similarity</li>
<li><code>error_distribution</code>: Histogram of error types</li>
<li><code>temporal_distribution</code>: Failures over time</li>
</ul>
<h3 id="retry-command"><a class="header" href="#retry-command">Retry Command</a></h3>
<blockquote>
<p><strong>⚠️ STUB</strong>: This command is not yet implemented. Description below shows planned interface.</p>
</blockquote>
<p>Reprocess failed items (src/cli/args.rs:640-654):</p>
<pre><code class="language-bash"># Retry all failed items for a workflow
prodigy dlq retry &lt;workflow_id&gt;

# Control parallelism (default: 10)
prodigy dlq retry &lt;workflow_id&gt; --parallel 10

# Filter items to retry
prodigy dlq retry &lt;workflow_id&gt; --filter 'item.priority &gt;= 5'

# Limit retry attempts per item (default: 3)
prodigy dlq retry &lt;workflow_id&gt; --max-retries 2

# Force retry even if not eligible
prodigy dlq retry &lt;workflow_id&gt; --force
</code></pre>
<p><strong>Command Parameters</strong>:</p>
<ul>
<li><code>&lt;workflow_id&gt;</code>: The workflow/job identifier to retry items from (e.g., “mapreduce-1234567890”)</li>
<li><code>--parallel</code>: Number of concurrent retry workers (default: 10, src/cli/args.rs:653)</li>
<li><code>--max-retries</code>: Maximum retry attempts per item (default: 3, src/cli/args.rs:648)</li>
<li><code>--filter</code>: Expression to filter which items to retry (default: all eligible items, src/cli/args.rs:644)</li>
<li><code>--force</code>: Force retry of items marked as not eligible (default: false, src/cli/args.rs:650)</li>
</ul>
<h4 id="retry-behavior"><a class="header" href="#retry-behavior">Retry Behavior</a></h4>
<p>The retry functionality is designed to handle large-scale DLQ reprocessing:</p>
<ul>
<li><strong>Streaming support</strong>: Items are processed incrementally to avoid memory issues with large DLQs</li>
<li><strong>Parallel execution</strong>: Uses <code>--parallel</code> flag (default: 10) to control concurrent workers</li>
<li><strong>State updates</strong>:
<ul>
<li>Successful items are removed from DLQ</li>
<li>Failed items remain with updated <code>failure_history</code></li>
<li><code>failure_count</code> is incremented</li>
</ul>
</li>
<li><strong>Correlation tracking</strong>: Maintains original item IDs and correlation metadata</li>
<li><strong>Interruption safe</strong>: Supports stopping and resuming retry operations</li>
</ul>
<p><strong>Implementation Note</strong>: The DLQ reprocessing logic uses the <code>DeadLetterQueue::reprocess</code> method (src/cook/execution/dlq.rs:202-233) which filters for <code>reprocess_eligible</code> items before attempting retry.</p>
<h3 id="export-command"><a class="header" href="#export-command">Export Command</a></h3>
<p>Export DLQ items for external analysis:</p>
<pre><code class="language-bash"># Export to JSON (default)
prodigy dlq export dlq-items.json

# Export to CSV
prodigy dlq export dlq-items.csv --format csv

# Export specific job
prodigy dlq export output.json --job-id mapreduce-1234567890
</code></pre>
<h3 id="stats-command"><a class="header" href="#stats-command">Stats Command</a></h3>
<p>View DLQ statistics:</p>
<pre><code class="language-bash"># Overall DLQ statistics
prodigy dlq stats

# Stats for specific workflow
prodigy dlq stats --workflow-id my-workflow
</code></pre>
<p>Output includes:</p>
<ul>
<li>Total items in DLQ</li>
<li>Items by error type</li>
<li>Average retry count</li>
<li>Retry-eligible vs manual review required</li>
<li>Temporal distribution</li>
</ul>
<h3 id="clear-command"><a class="header" href="#clear-command">Clear Command</a></h3>
<p>Remove items from DLQ:</p>
<pre><code class="language-bash"># Clear all items for a workflow (prompts for confirmation)
prodigy dlq clear my-workflow

# Skip confirmation prompt
prodigy dlq clear my-workflow --yes
</code></pre>
<h3 id="purge-command"><a class="header" href="#purge-command">Purge Command</a></h3>
<p>Clean up old DLQ items:</p>
<pre><code class="language-bash"># Purge items older than 30 days
prodigy dlq purge --older-than-days 30

# Purge for specific job
prodigy dlq purge --older-than-days 30 --job-id mapreduce-1234567890

# Skip confirmation
prodigy dlq purge --older-than-days 30 --yes
</code></pre>
<h2 id="debugging-with-dlq"><a class="header" href="#debugging-with-dlq">Debugging with DLQ</a></h2>
<h3 id="accessing-claude-json-logs"><a class="header" href="#accessing-claude-json-logs">Accessing Claude JSON Logs</a></h3>
<p>Each <code>FailureDetail</code> includes a <code>json_log_location</code> field pointing to the Claude Code JSON log for that execution. This log contains:</p>
<ul>
<li>Complete conversation history</li>
<li>All tool invocations and results</li>
<li>Error details and stack traces</li>
<li>Token usage statistics</li>
</ul>
<pre><code class="language-bash"># View JSON log from DLQ item
cat $(prodigy dlq inspect item-123 | jq -r '.failure_history[0].json_log_location')

# Pretty-print with jq
cat /path/to/session.json | jq '.'
</code></pre>
<p>For more details on Claude JSON logs, see <a href="../troubleshooting/best-practices-for-debugging.html">Best Practices for Debugging</a> and <a href="../retry-configuration/retry-metrics-and-observability.html">Retry Metrics and Observability</a>.</p>
<h3 id="common-debugging-workflow"><a class="header" href="#common-debugging-workflow">Common Debugging Workflow</a></h3>
<ol>
<li>
<p><strong>List failed items</strong>:</p>
<pre><code class="language-bash">prodigy dlq list --job-id mapreduce-1234567890
</code></pre>
</li>
<li>
<p><strong>Inspect specific failure</strong>:</p>
<pre><code class="language-bash">prodigy dlq inspect item-123
</code></pre>
</li>
<li>
<p><strong>Examine Claude logs</strong>:</p>
<pre><code class="language-bash">cat /path/to/claude-session.json | jq '.messages[-3:]'
</code></pre>
</li>
<li>
<p><strong>Analyze failure patterns</strong>:</p>
<pre><code class="language-bash">prodigy dlq analyze --job-id mapreduce-1234567890
</code></pre>
</li>
<li>
<p><strong>Fix underlying issue</strong> (code bug, config error, etc.)</p>
</li>
<li>
<p><strong>Retry failed items</strong>:</p>
<pre><code class="language-bash">prodigy dlq retry mapreduce-1234567890
</code></pre>
</li>
</ol>
<h2 id="integration-with-mapreduce"><a class="header" href="#integration-with-mapreduce">Integration with MapReduce</a></h2>
<p>The DLQ is tightly integrated with MapReduce workflows through the <code>on_item_failure</code> policy:</p>
<pre><code class="language-yaml">name: my-workflow
mode: mapreduce

map:
  input: "items.json"
  json_path: "$.items[*]"

  # Default policy: send failures to DLQ
  on_item_failure: dlq

  agent_template:
    - claude: "/process '${item}'"
</code></pre>
<h3 id="available-policies"><a class="header" href="#available-policies">Available Policies</a></h3>
<ul>
<li><strong><code>dlq</code></strong> (default): Failed items sent to DLQ, job continues</li>
<li><strong><code>retry</code></strong>: Immediate retry with exponential backoff</li>
<li><strong><code>skip</code></strong>: Ignore failures, mark as skipped, continue</li>
<li><strong><code>stop</code></strong>: Halt entire workflow on first failure</li>
<li><strong><code>custom</code></strong>: User-defined failure handler</li>
</ul>
<h3 id="failure-flow"><a class="header" href="#failure-flow">Failure Flow</a></h3>
<pre><code>Work Item Processing
       ↓
   Command Failed
       ↓
  Retry Attempts (if configured)
       ↓
   Still Failing?
       ↓
on_item_failure: dlq
       ↓
Create DeadLetteredItem
       ↓
Save to ~/.prodigy/dlq/{repo}/{job_id}/mapreduce/dlq/{job_id}/items/{item_id}.json
       ↓
Continue Processing Other Items
</code></pre>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="when-to-retry-vs-manual-fix"><a class="header" href="#when-to-retry-vs-manual-fix">When to Retry vs Manual Fix</a></h3>
<p><strong>Automatic Retry</strong> (via <code>prodigy dlq retry</code>):</p>
<ul>
<li>Transient failures (network timeouts, resource contention)</li>
<li>Flaky tests or intermittent issues</li>
<li>Items that may succeed with more resources (<code>--max-parallel 1</code>)</li>
</ul>
<p><strong>Manual Fix</strong> (code changes, then retry):</p>
<ul>
<li>Logic errors in processing code</li>
<li>Invalid assumptions about item data</li>
<li>Missing dependencies or configuration</li>
<li>Systematic failures affecting multiple items</li>
</ul>
<h3 id="dlq-management"><a class="header" href="#dlq-management">DLQ Management</a></h3>
<ol>
<li><strong>Monitor regularly</strong>: Use <code>prodigy dlq stats</code> to track failure rates</li>
<li><strong>Analyze patterns</strong>: Run <code>prodigy dlq analyze</code> to identify systematic issues</li>
<li><strong>Clean up old items</strong>: Periodically run <code>prodigy dlq purge</code> to remove resolved failures</li>
<li><strong>Set review flags</strong>: Mark <code>manual_review_required: true</code> for items needing human investigation</li>
</ol>
<h3 id="performance-considerations"><a class="header" href="#performance-considerations">Performance Considerations</a></h3>
<ul>
<li><strong>Large DLQs</strong>: Retry command uses streaming to handle thousands of items efficiently</li>
<li><strong>Parallelism</strong>: Tune <code>--max-parallel</code> based on failure type (CPU-bound vs I/O-bound)</li>
<li><strong>Filtering</strong>: Use <code>--filter</code> to target specific subsets of failures</li>
</ul>
<h2 id="advanced-dlq-storage-internals"><a class="header" href="#advanced-dlq-storage-internals">Advanced: DLQ Storage Internals</a></h2>
<p>For advanced debugging or direct file access, understanding the DLQ storage structure can be helpful.</p>
<h3 id="index-file-structure"><a class="header" href="#index-file-structure">Index File Structure</a></h3>
<p>The <code>index.json</code> file provides metadata about the DLQ (src/cook/execution/dlq.rs:608-637):</p>
<pre><code class="language-json">{
  "job_id": "mapreduce-1234567890",
  "item_count": 3,
  "item_ids": ["item-123", "item-456", "item-789"],
  "updated_at": "2025-01-11T10:30:00Z"
}
</code></pre>
<p>This index is automatically updated when items are added or removed from the DLQ.</p>
<h3 id="direct-file-access"><a class="header" href="#direct-file-access">Direct File Access</a></h3>
<p>To inspect DLQ items directly:</p>
<pre><code class="language-bash"># List all DLQ items for a job
ls ~/.prodigy/dlq/prodigy/mapreduce-1234567890/mapreduce/dlq/mapreduce-1234567890/items/

# View a specific item
cat ~/.prodigy/dlq/prodigy/mapreduce-1234567890/mapreduce/dlq/mapreduce-1234567890/items/item-123.json | jq

# Count total items
jq '.item_count' ~/.prodigy/dlq/prodigy/mapreduce-1234567890/mapreduce/dlq/mapreduce-1234567890/index.json
</code></pre>
<p><strong>Note</strong>: Direct file access is provided for debugging. Always use the Prodigy CLI commands for production operations to ensure data consistency.</p>
<h2 id="cross-references"><a class="header" href="#cross-references">Cross-References</a></h2>
<ul>
<li><a href="./checkpoint-and-resume.html">Checkpoint and Resume</a>: DLQ state preserved in checkpoints</li>
<li><a href="./event-tracking.html">Event Tracking</a>: DLQ operations emit trackable events</li>
<li><a href="../error-handling.html">Error Handling</a>: Broader error handling strategies</li>
<li><a href="../mapreduce-worktree-architecture.html">Worktree Architecture</a>: Agent isolation and artifact preservation</li>
<li><a href="../troubleshooting/best-practices-for-debugging.html">Best Practices for Debugging</a>: Using JSON logs and DLQ for debugging failed items</li>
<li><a href="../retry-configuration/retry-metrics-and-observability.html">Retry Metrics and Observability</a>: Monitoring retry behavior and failures</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../mapreduce/checkpoint-and-resume.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../mapreduce/workflow-format-comparison.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../mapreduce/checkpoint-and-resume.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../mapreduce/workflow-format-comparison.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
