<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation References - Prodigy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="AI-powered workflow orchestration for development teams">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prodigy Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy/edit/main/book/src/retry-configuration/implementation-references.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="implementation-references"><a class="header" href="#implementation-references">Implementation References</a></h2>
<p>This section provides pointers to the source code implementing the retry system. These references are useful for developers who want to understand implementation details, extend the retry functionality, or troubleshoot issues.</p>
<h3 id="core-retry-system"><a class="header" href="#core-retry-system">Core Retry System</a></h3>
<h4 id="enhanced-retry-configuration-srccookretry_v2rs14-461"><a class="header" href="#enhanced-retry-configuration-srccookretry_v2rs14-461">Enhanced Retry Configuration (<code>src/cook/retry_v2.rs:14-461</code>)</a></h4>
<p>The primary implementation of Prodigy’s retry system with comprehensive features:</p>
<ul>
<li>
<p><strong>RetryConfig struct</strong> (lines 14-52): Main configuration type with fields for:</p>
<ul>
<li>Maximum retry attempts</li>
<li>Backoff strategies (Fixed, Linear, Exponential, Fibonacci, Custom)</li>
<li>Initial and maximum delays</li>
<li>Jitter support for preventing thundering herd</li>
<li>Error matching for conditional retries</li>
<li>Retry budget (maximum total time)</li>
<li>Failure actions</li>
</ul>
</li>
<li>
<p><strong>BackoffStrategy enum</strong> (lines 70-90): Implements multiple delay calculation strategies:</p>
<ul>
<li><code>Fixed</code>: Constant delay between retries</li>
<li><code>Linear</code>: Incrementing delay (initial + n * increment)</li>
<li><code>Exponential</code>: Doubling delay (initial * base^n)</li>
<li><code>Fibonacci</code>: Fibonacci sequence delays</li>
<li><code>Custom</code>: User-defined delay sequence</li>
</ul>
</li>
<li>
<p><strong>Retry execution logic</strong>: Core retry loop with backoff calculation, jitter application, and timeout enforcement</p>
</li>
</ul>
<p><strong>Example usage</strong> (from src/cook/retry_v2.rs):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let config = RetryConfig {
    attempts: 5,
    backoff: BackoffStrategy::Exponential { base: 2.0 },
    initial_delay: Duration::from_millis(100),
    max_delay: Duration::from_secs(60),
    jitter: true,
    jitter_factor: 0.1,
    retry_on: vec![ErrorMatcher::Network, ErrorMatcher::Timeout],
    retry_budget: Some(Duration::from_secs(300)),
    on_failure: FailureAction::Fail,
};
<span class="boring">}</span></code></pre></pre>
<h4 id="workflow-error-policy-srccookworkflowerror_policyrs91-129"><a class="header" href="#workflow-error-policy-srccookworkflowerror_policyrs91-129">Workflow Error Policy (<code>src/cook/workflow/error_policy.rs:91-129</code>)</a></h4>
<p>Simpler retry configuration used at the workflow level:</p>
<ul>
<li>
<p><strong>RetryConfig struct</strong> (lines 91-99): Workflow-scoped retry settings with:</p>
<ul>
<li><code>max_attempts</code>: Maximum number of retry attempts (default: 3)</li>
<li><code>backoff</code>: Backoff strategy for delay calculation</li>
</ul>
</li>
<li>
<p><strong>BackoffStrategy enum</strong> (lines 105-120): Workflow backoff strategies with duration parameters:</p>
<ul>
<li><code>Fixed { delay }</code>: Fixed delay between retries</li>
<li><code>Linear { initial, increment }</code>: Linear backoff with configurable increment</li>
<li><code>Exponential { initial, multiplier }</code>: Exponential backoff with configurable base</li>
<li><code>Fibonacci { initial }</code>: Fibonacci sequence starting from initial delay</li>
</ul>
</li>
<li>
<p><strong>WorkflowErrorPolicy struct</strong> (lines 131-140+): Workflow-level error handling with:</p>
<ul>
<li><code>on_item_failure</code>: Action to take when items fail</li>
<li><code>continue_on_failure</code>: Whether to continue processing after failures</li>
</ul>
</li>
</ul>
<p><strong>Example usage</strong> (from workflow YAML):</p>
<pre><code class="language-yaml">retry_config:
  max_attempts: 5
  backoff:
    exponential:
      initial: 1s
      multiplier: 2.0
</code></pre>
<h4 id="command-metadata-srcconfigcommandrs135"><a class="header" href="#command-metadata-srcconfigcommandrs135">Command Metadata (<code>src/config/command.rs:135</code>)</a></h4>
<p>Command-level retry override configuration:</p>
<ul>
<li><strong>CommandMetadata struct</strong> (lines 133-149): Per-command settings including:
<ul>
<li><code>retries: Option&lt;u32&gt;</code>: Override global retry attempts for specific commands</li>
<li><code>timeout: Option&lt;u64&gt;</code>: Command-specific timeout in seconds</li>
<li><code>continue_on_error: Option&lt;bool&gt;</code>: Whether workflow continues if command fails</li>
<li><code>env</code>: Environment variables for the command</li>
<li><code>commit_required</code>: Whether command must create git commits</li>
</ul>
</li>
</ul>
<p>This allows fine-grained control over retry behavior at the command level, overriding workflow-level settings when needed.</p>
<p><strong>Example usage</strong> (from workflow YAML):</p>
<pre><code class="language-yaml">commands:
  - shell: "flaky-network-operation.sh"
    retries: 10
    timeout: 300
    continue_on_error: false
</code></pre>
<h3 id="error-handling-components"><a class="header" href="#error-handling-components">Error Handling Components</a></h3>
<h4 id="error-matchers-srccookretry_v2rs100-151"><a class="header" href="#error-matchers-srccookretry_v2rs100-151">Error Matchers (<code>src/cook/retry_v2.rs:100-151</code>)</a></h4>
<p>Conditional retry based on error patterns:</p>
<ul>
<li>
<p><strong>ErrorMatcher enum</strong> (lines 101-114): Pre-defined error categories:</p>
<ul>
<li><code>Network</code>: Connection, refused, unreachable errors</li>
<li><code>Timeout</code>: Timeout and “timed out” errors</li>
<li><code>ServerError</code>: HTTP 5xx status codes (500, 502, 503, 504)</li>
<li><code>RateLimit</code>: HTTP 429 and “rate limit” errors</li>
<li><code>Pattern(String)</code>: Custom regex pattern matching</li>
</ul>
</li>
<li>
<p><strong>Matching logic</strong> (lines 116-151): Case-insensitive error message matching with regex support</p>
</li>
</ul>
<p>This enables intelligent retry behavior that only retries on transient errors (network issues, timeouts, rate limits) while failing fast on permanent errors (validation failures, authentication errors).</p>
<p><strong>Example usage</strong> (from src/cook/retry_v2.rs):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>retry_on: vec![
    ErrorMatcher::Network,
    ErrorMatcher::Timeout,
    ErrorMatcher::ServerError,
    ErrorMatcher::Pattern("temporary.*unavailable".to_string()),
]
<span class="boring">}</span></code></pre></pre>
<h3 id="resilience-features"><a class="header" href="#resilience-features">Resilience Features</a></h3>
<h4 id="circuit-breaker-srccookretry_v2rs325-397"><a class="header" href="#circuit-breaker-srccookretry_v2rs325-397">Circuit Breaker (<code>src/cook/retry_v2.rs:325-397</code>)</a></h4>
<p>Protection against cascading failures:</p>
<ul>
<li>
<p><strong>CircuitBreaker struct</strong> (lines 325-331): Stateful circuit breaker with:</p>
<ul>
<li><code>failure_threshold</code>: Number of consecutive failures before opening</li>
<li><code>recovery_timeout</code>: Time to wait before attempting recovery</li>
<li><code>state</code>: Current circuit state (Closed, Open, HalfOpen)</li>
<li><code>consecutive_failures</code>: Counter for failure tracking</li>
</ul>
</li>
<li>
<p><strong>State machine</strong> (lines 333-338): Three-state circuit breaker:</p>
<ul>
<li><code>Closed</code>: Normal operation, requests allowed</li>
<li><code>Open { until }</code>: Failing, requests blocked until timeout</li>
<li><code>HalfOpen</code>: Testing recovery, limited requests allowed</li>
</ul>
</li>
<li>
<p><strong>State transitions</strong>:</p>
<ul>
<li><code>is_open()</code> (lines 351-367): Check state and transition from Open to HalfOpen after timeout</li>
<li><code>record_success()</code> (lines 369-379): Reset failures, close circuit if in HalfOpen</li>
<li><code>record_failure()</code> (lines 381-397): Increment failures, open circuit if threshold exceeded</li>
</ul>
</li>
</ul>
<p><strong>Example usage</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let breaker = CircuitBreaker::new(5, Duration::from_secs(30));

// Check before operation
if breaker.is_open().await {
    return Err(anyhow!("Circuit breaker open"));
}

// Record result
match operation().await {
    Ok(result) =&gt; {
        breaker.record_success().await;
        Ok(result)
    }
    Err(e) =&gt; {
        breaker.record_failure().await;
        Err(e)
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="observability"><a class="header" href="#observability">Observability</a></h3>
<h4 id="retry-metrics-srccookretry_v2rs399-422"><a class="header" href="#retry-metrics-srccookretry_v2rs399-422">Retry Metrics (<code>src/cook/retry_v2.rs:399-422</code>)</a></h4>
<p>Tracking retry behavior for monitoring:</p>
<ul>
<li><strong>RetryMetrics struct</strong> (lines 399-422): Statistics collection including:
<ul>
<li><code>total_attempts</code>: Total retry attempts made</li>
<li><code>successful_attempts</code>: Number of successful retries</li>
<li><code>failed_attempts</code>: Number of failed retries</li>
<li><code>total_delay</code>: Cumulative delay time across all retries</li>
<li>Additional timing and success rate metrics</li>
</ul>
</li>
</ul>
<p>These metrics enable monitoring of retry effectiveness, identifying problematic operations, and tuning retry configurations for optimal performance.</p>
<p><strong>Example usage</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let metrics = RetryMetrics::default();
// Metrics are updated during retry execution
println!("Success rate: {}/{}",
    metrics.successful_attempts,
    metrics.total_attempts);
<span class="boring">}</span></code></pre></pre>
<h2 id="organization-by-component"><a class="header" href="#organization-by-component">Organization by Component</a></h2>
<p>The retry system is organized into logical components:</p>
<p><strong>Core Retry System</strong>:</p>
<ul>
<li>Main retry configuration and execution (src/cook/retry_v2.rs)</li>
<li>Workflow-level configuration (src/cook/workflow/error_policy.rs)</li>
<li>Command-level overrides (src/config/command.rs)</li>
</ul>
<p><strong>Error Handling</strong>:</p>
<ul>
<li>Conditional retry with error matchers (src/cook/retry_v2.rs:100-151)</li>
<li>Error pattern matching and classification</li>
</ul>
<p><strong>Resilience</strong>:</p>
<ul>
<li>Circuit breaker implementation (src/cook/retry_v2.rs:325-397)</li>
<li>State management and failure protection</li>
</ul>
<p><strong>Observability</strong>:</p>
<ul>
<li>Retry metrics and monitoring (src/cook/retry_v2.rs:399-422)</li>
<li>Performance tracking and debugging</li>
</ul>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li>For practical examples, see the <a href="complete-examples.html">Complete Examples</a> subsection</li>
<li>For configuration details, see the <a href="basic-retry-configuration.html">Basic Retry Configuration</a> subsection</li>
<li>For backoff strategies, see the <a href="backoff-strategies.html">Backoff Strategies</a> subsection</li>
<li>For best practices, see the <a href="best-practices.html">Best Practices</a> subsection</li>
<li>For troubleshooting, see the <a href="troubleshooting.html">Troubleshooting</a> subsection</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../retry-configuration/related-topics.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../error-handling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../retry-configuration/related-topics.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../error-handling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
