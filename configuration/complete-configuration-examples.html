<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Complete Configuration Examples - Prodigy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="AI-powered workflow orchestration for development teams">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prodigy Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy/edit/main/book/src/configuration/complete-configuration-examples.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="complete-configuration-examples"><a class="header" href="#complete-configuration-examples">Complete Configuration Examples</a></h2>
<p>This subsection provides comprehensive, production-ready workflow examples demonstrating all major Prodigy configuration features. Each example is extracted from real workflows in the repository and includes detailed annotations explaining configuration choices.</p>
<h3 id="quick-reference"><a class="header" href="#quick-reference">Quick Reference</a></h3>
<p>Complete workflow configurations include:</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Standard Workflow</th><th>MapReduce Workflow</th></tr></thead><tbody>
<tr><td><strong>Basic Structure</strong></td><td><code>commands: []</code></td><td><code>mode: mapreduce</code> with <code>setup</code>, <code>map</code>, <code>reduce</code></td></tr>
<tr><td><strong>Environment Variables</strong></td><td><code>env:</code>, <code>secrets:</code>, <code>profiles:</code></td><td>Same + phase-specific overrides</td></tr>
<tr><td><strong>Command Types</strong></td><td><code>claude:</code>, <code>shell:</code>, <code>goal_seek:</code>, <code>foreach:</code>, <code>write_file:</code></td><td>Same + <code>agent_template</code></td></tr>
<tr><td><strong>Error Handling</strong></td><td><code>on_failure:</code>, <code>on_success:</code>, <code>retry:</code></td><td>Same + <code>error_policy:</code>, <code>on_item_failure:</code></td></tr>
<tr><td><strong>Validation</strong></td><td><code>validate:</code> with <code>threshold</code>, <code>on_incomplete</code></td><td>Per-step validation + gap filling</td></tr>
<tr><td><strong>Output Capture</strong></td><td><code>capture_output:</code>, <code>outputs:</code></td><td><code>capture_outputs:</code> in setup phase</td></tr>
<tr><td><strong>Timeouts</strong></td><td><code>timeout:</code> per command</td><td><code>timeout:</code> per phase + <code>agent_timeout_secs</code></td></tr>
<tr><td><strong>Merge Workflow</strong></td><td><code>merge:</code> with custom commands</td><td>Same with <code>${merge.*}</code> variables</td></tr>
</tbody></table>
</div>
<hr />
<h3 id="1-complete-standard-workflow-example"><a class="header" href="#1-complete-standard-workflow-example">1. Complete Standard Workflow Example</a></h3>
<p>This example demonstrates a full standard workflow with all major configuration options.</p>
<p><strong>Source</strong>: workflows/debtmap.yml (lines 1-56)</p>
<pre><code class="language-yaml"># Sequential workflow for technical debt analysis and remediation
# Demonstrates: validation, goal-seeking, error handlers, output capture

# Phase 1: Generate coverage data
- shell: "just coverage-lcov"
  timeout: 300

# Phase 2: Analyze tech debt and capture baseline
- shell: "debtmap analyze . --lcov target/coverage/lcov.info --output .prodigy/debtmap-before.json --format json"
  capture_output: true

# Phase 3: Create implementation plan with validation
- claude: "/prodigy-debtmap-plan --before .prodigy/debtmap-before.json --output .prodigy/IMPLEMENTATION_PLAN.md"
  commit_required: true
  validate:
    commands:
      - claude: "/prodigy-validate-debtmap-plan --before .prodigy/debtmap-before.json --plan .prodigy/IMPLEMENTATION_PLAN.md --output .prodigy/plan-validation.json"
    result_file: ".prodigy/plan-validation.json"
    threshold: 75  # Must achieve 75% completeness
    on_incomplete:
      commands:
        - claude: "/prodigy-revise-debtmap-plan --gaps ${validation.gaps} --plan .prodigy/IMPLEMENTATION_PLAN.md"
      max_attempts: 3
      fail_workflow: false

# Phase 4: Execute the plan with comprehensive validation
- claude: "/prodigy-debtmap-implement --plan .prodigy/IMPLEMENTATION_PLAN.md"
  commit_required: true
  validate:
    commands:
      - shell: "just coverage-lcov"
      - shell: "debtmap analyze . --lcov target/coverage/lcov.info --output .prodigy/debtmap-after.json --format json"
      - shell: "debtmap compare --before .prodigy/debtmap-before.json --after .prodigy/debtmap-after.json --plan .prodigy/IMPLEMENTATION_PLAN.md --output .prodigy/comparison.json --format json"
      - claude: "/prodigy-validate-debtmap-improvement --comparison .prodigy/comparison.json --output .prodigy/debtmap-validation.json"
    result_file: ".prodigy/debtmap-validation.json"
    threshold: 75
    on_incomplete:
      commands:
        - claude: "/prodigy-complete-debtmap-fix --plan .prodigy/IMPLEMENTATION_PLAN.md --validation .prodigy/debtmap-validation.json --attempt ${validation.attempt_number}"
          commit_required: true
        - shell: "just coverage-lcov"
        - shell: "debtmap analyze . --lcov target/coverage/lcov.info --output .prodigy/debtmap-after.json --format json"
        - shell: "debtmap compare --before .prodigy/debtmap-before.json --after .prodigy/debtmap-after.json --plan .prodigy/IMPLEMENTATION_PLAN.md --output .prodigy/comparison.json --format json"
      max_attempts: 5
      fail_workflow: true

# Phase 5: Verify tests pass with error recovery
- shell: "just test"
  on_failure:
    claude: "/prodigy-debug-test-failure --output ${shell.output}"
    max_attempts: 5
    fail_workflow: true

# Phase 6: Enforce code quality standards
- shell: "just fmt-check &amp;&amp; just lint"
  on_failure:
    claude: "/prodigy-lint ${shell.output}"
    max_attempts: 5
    fail_workflow: true
</code></pre>
<p><strong>Key Features Demonstrated</strong>:</p>
<ul>
<li><strong>Validation with gap filling</strong>: <code>validate:</code> block with <code>threshold</code> and <code>on_incomplete</code> handler</li>
<li><strong>Error recovery</strong>: <code>on_failure:</code> handlers with <code>max_attempts</code> for automatic fixing</li>
<li><strong>Output capture</strong>: Shell output captured and passed to Claude for debugging</li>
<li><strong>Commit control</strong>: <code>commit_required: true</code> ensures changes are tracked</li>
<li><strong>Timeouts</strong>: Per-command timeout to prevent hanging</li>
<li><strong>Sequential orchestration</strong>: Each phase builds on previous results</li>
</ul>
<p><strong>Configuration Details</strong> (from src/config/command.rs:WorkflowStepCommand):</p>
<ul>
<li><code>commit_required: bool</code> - Whether step must create a git commit (default: false)</li>
<li><code>timeout: u64</code> - Maximum execution time in seconds</li>
<li><code>validate: ValidationConfig</code> - Validation specification with threshold and handlers</li>
<li><code>on_failure: TestDebugConfig</code> - Error handler with max_attempts and fail_workflow</li>
<li><code>capture_output: bool</code> - Capture command output for use in subsequent steps</li>
</ul>
<hr />
<h3 id="2-complete-mapreduce-workflow-example"><a class="header" href="#2-complete-mapreduce-workflow-example">2. Complete MapReduce Workflow Example</a></h3>
<p>This example demonstrates a production MapReduce workflow with all phases and configuration options.</p>
<p><strong>Source</strong>: workflows/book-docs-drift.yml (lines 1-101)</p>
<pre><code class="language-yaml">name: prodigy-book-docs-drift-detection
mode: mapreduce

# Global environment configuration
env:
  # Project configuration
  PROJECT_NAME: "Prodigy"
  PROJECT_CONFIG: ".prodigy/book-config.json"
  FEATURES_PATH: ".prodigy/book-analysis/features.json"

  # Book-specific settings
  BOOK_DIR: "book"
  ANALYSIS_DIR: ".prodigy/book-analysis"
  CHAPTERS_FILE: "workflows/data/prodigy-chapters.json"

  # Workflow settings
  MAX_PARALLEL: "3"

# Setup phase: Analyze codebase and prepare work items
setup:
  - shell: "mkdir -p $ANALYSIS_DIR"

  # Step 1: Analyze codebase features
  - claude: "/prodigy-analyze-features-for-book --project $PROJECT_NAME --config $PROJECT_CONFIG"

  # Step 2: Detect gaps and generate work items
  - claude: "/prodigy-detect-documentation-gaps --project $PROJECT_NAME --config $PROJECT_CONFIG --features $FEATURES_PATH --chapters $CHAPTERS_FILE --book-dir $BOOK_DIR"

# Map phase: Process each documentation subsection in parallel
map:
  input: "${ANALYSIS_DIR}/flattened-items.json"
  json_path: "$[*]"

  agent_template:
    # Step 1: Analyze subsection for drift
    - claude: "/prodigy-analyze-subsection-drift --project $PROJECT_NAME --json '${item}' --features $FEATURES_PATH"
      commit_required: true

    # Step 2: Fix drift with validation
    - claude: "/prodigy-fix-subsection-drift --project $PROJECT_NAME --json '${item}'"
      commit_required: true
      validate:
        claude: "/prodigy-validate-doc-fix --project $PROJECT_NAME --json '${item}' --output .prodigy/validation-result.json"
        result_file: ".prodigy/validation-result.json"
        threshold: 100  # Documentation must meet 100% quality standards
        on_incomplete:
          claude: "/prodigy-complete-doc-fix --project $PROJECT_NAME --json '${item}' --gaps ${validation.gaps}"
          max_attempts: 3
          fail_workflow: false
          commit_required: true

  max_parallel: ${MAX_PARALLEL}

# Reduce phase: Aggregate results and validate build
reduce:
  # Rebuild the book to ensure all chapters compile
  - shell: "cd book &amp;&amp; mdbook build"
    on_failure:
      claude: "/prodigy-fix-book-build-errors --project $PROJECT_NAME"
      commit_required: true

  # Clean up temporary analysis files
  - shell: "rm -rf ${ANALYSIS_DIR}"
  - shell: "git add -A &amp;&amp; git commit -m 'chore: remove temporary book analysis files for ${PROJECT_NAME}' || true"

# Error handling policy
error_policy:
  on_item_failure: dlq          # Send failures to Dead Letter Queue
  continue_on_failure: true     # Don't stop on individual item failures
  max_failures: 2               # Stop if more than 2 items fail
  error_collection: aggregate   # Collect errors for batch reporting

# Custom merge workflow
merge:
  commands:
    - shell: "git fetch origin"
    - claude: "/prodigy-merge-master --project ${PROJECT_NAME}"
    - claude: "/prodigy-merge-worktree ${merge.source_branch} ${merge.target_branch}"
</code></pre>
<p><strong>Key Features Demonstrated</strong>:</p>
<ul>
<li><strong>Environment parameterization</strong>: All paths and settings in <code>env:</code> block for easy customization</li>
<li><strong>Setup phase</strong>: Generate work items before parallel processing</li>
<li><strong>Agent template</strong>: Commands execute in isolation per work item</li>
<li><strong>Work item access</strong>: <code>${item}</code> variable provides access to current item fields</li>
<li><strong>Parallel execution</strong>: <code>max_parallel</code> controls concurrency (can reference env vars)</li>
<li><strong>Validation with gap filling</strong>: Automatic quality improvement until threshold met</li>
<li><strong>Error policy</strong>: Comprehensive failure handling with DLQ and thresholds</li>
<li><strong>Merge workflow</strong>: Custom merge process with branch variables</li>
</ul>
<p><strong>MapReduce Configuration Details</strong> (from src/config/mapreduce.rs):</p>
<p><strong>SetupPhaseConfig</strong>:</p>
<ul>
<li><code>commands: Vec&lt;WorkflowStep&gt;</code> - Commands to execute during setup</li>
<li><code>timeout: Option&lt;String&gt;</code> - Phase timeout (supports env var references like <code>"$TIMEOUT"</code>)</li>
<li><code>capture_outputs: HashMap&lt;String, CaptureConfig&gt;</code> - Variables to capture from setup</li>
</ul>
<p><strong>MapPhaseYaml</strong>:</p>
<ul>
<li><code>input: String</code> - Path to work items JSON or command to generate items</li>
<li><code>json_path: String</code> - JSONPath expression to extract items (default: <code>""</code> for array root)</li>
<li><code>agent_template: AgentTemplate</code> - Commands to execute per item</li>
<li><code>max_parallel: String</code> - Concurrency limit (supports env vars like <code>"${MAX_PARALLEL}"</code>)</li>
<li><code>filter: Option&lt;String&gt;</code> - Filter expression (e.g., <code>"item.priority &gt;= 5"</code>)</li>
<li><code>sort_by: Option&lt;String&gt;</code> - Sort field with direction (<code>"item.priority DESC"</code>)</li>
<li><code>max_items: Option&lt;usize&gt;</code> - Limit number of items to process</li>
<li><code>offset: Option&lt;usize&gt;</code> - Skip first N items</li>
<li><code>agent_timeout_secs: Option&lt;String&gt;</code> - Per-agent timeout (supports env vars)</li>
</ul>
<p><strong>Error Policy</strong> (from src/cook/workflow/error_policy.rs:WorkflowErrorPolicy):</p>
<ul>
<li><code>on_item_failure: ItemFailureAction</code> - Action on failure: <code>dlq</code>, <code>retry</code>, <code>skip</code>, <code>stop</code> (default: <code>dlq</code>)</li>
<li><code>continue_on_failure: bool</code> - Continue processing after failures (default: <code>true</code>)</li>
<li><code>max_failures: Option&lt;usize&gt;</code> - Stop after N failures</li>
<li><code>failure_threshold: Option&lt;f64&gt;</code> - Stop if failure rate exceeds threshold (0.0 to 1.0)</li>
<li><code>error_collection: ErrorCollectionStrategy</code> - Collection mode: <code>aggregate</code>, <code>immediate</code>, <code>batched</code> (default: <code>aggregate</code>)</li>
</ul>
<p><strong>Merge Workflow Variables</strong>:</p>
<ul>
<li><code>${merge.worktree}</code> - Worktree name being merged</li>
<li><code>${merge.source_branch}</code> - Source branch (worktree branch)</li>
<li><code>${merge.target_branch}</code> - Target branch (original branch)</li>
<li><code>${merge.session_id}</code> - Session ID for correlation</li>
</ul>
<hr />
<h3 id="3-environment-variables-and-secrets-example"><a class="header" href="#3-environment-variables-and-secrets-example">3. Environment Variables and Secrets Example</a></h3>
<p>This example demonstrates comprehensive environment configuration with static variables, dynamic values, secrets, and profiles.</p>
<p><strong>Source</strong>: workflows/environment-example.yml (lines 1-70)</p>
<pre><code class="language-yaml"># Global environment configuration
env:
  # Static environment variables
  NODE_ENV: production
  API_URL: https://api.example.com

  # Dynamic environment variable (computed from command)
  WORKERS:
    command: "nproc 2&gt;/dev/null || echo 4"
    cache: true  # Cache the result for workflow duration

  # Conditional environment variable (based on git branch)
  DEPLOY_ENV:
    condition: "${branch} == 'main'"
    when_true: "production"
    when_false: "staging"

# Secret environment variables (masked in logs)
secrets:
  # Reference to environment variable
  API_KEY: "${env:SECRET_API_KEY}"

# Environment files to load (.env format)
env_files:
  - .env.production

# Environment profiles for different contexts
profiles:
  development:
    NODE_ENV: development
    API_URL: http://localhost:3000
    DEBUG: "true"

  testing:
    NODE_ENV: test
    API_URL: http://localhost:4000
    COVERAGE: "true"

# Workflow steps demonstrating environment features
commands:
  - name: "Show environment"
    shell: "echo NODE_ENV=$NODE_ENV API_URL=$API_URL WORKERS=$WORKERS"
    capture_output: true

  - name: "Build frontend"
    shell: "echo 'Building frontend with NODE_ENV='$NODE_ENV"
    env:
      BUILD_TARGET: production  # Step-specific environment override
      OPTIMIZE: "true"
    working_dir: ./frontend

  - name: "Run tests"
    shell: "echo 'Running tests in test environment'"
    env:
      PYTHONPATH: "./src:./tests"
      TEST_ENV: "true"
    working_dir: ./backend
    temporary: true  # Environment restored after this step

  - name: "Deploy application"
    shell: "echo 'Deploying to '$DEPLOY_ENV' environment'"
    working_dir: "${env.DEPLOY_DIR}"

  - name: "Cleanup"
    shell: "echo 'Cleaning up temporary files'"
    clear_env: true  # Clear all environment variables except step-specific
    env:
      CLEANUP_MODE: "full"
</code></pre>
<p><strong>Environment Configuration Details</strong> (from src/cook/environment/config.rs):</p>
<p><strong>EnvValue Types</strong>:</p>
<ul>
<li><strong>Static</strong>: Simple string value</li>
<li><strong>Dynamic</strong>: Computed from command with optional caching
<ul>
<li><code>command: String</code> - Command to execute for value</li>
<li><code>cache: bool</code> - Cache result (default: false)</li>
</ul>
</li>
<li><strong>Conditional</strong>: Value based on expression evaluation
<ul>
<li><code>condition: String</code> - Expression to evaluate</li>
<li><code>when_true: String</code> - Value when condition is true</li>
<li><code>when_false: String</code> - Value when condition is false</li>
</ul>
</li>
</ul>
<p><strong>Secret Management</strong>:</p>
<ul>
<li>Marked with <code>secret: true</code> or defined in <code>secrets:</code> block</li>
<li>Automatically masked in logs, error messages, and event streams</li>
<li>Supports environment variable references: <code>"${env:VAR_NAME}"</code></li>
</ul>
<p><strong>Profile Usage</strong>:</p>
<pre><code class="language-bash"># Activate a profile at runtime
prodigy run workflow.yml --profile development
prodigy run workflow.yml --profile testing
</code></pre>
<p><strong>Step-Level Environment</strong> (from src/config/command.rs:WorkflowStepCommand):</p>
<ul>
<li><code>env: HashMap&lt;String, String&gt;</code> - Step-specific environment variables</li>
<li><code>working_dir: Option&lt;PathBuf&gt;</code> - Working directory for this step</li>
<li><code>temporary: bool</code> - Restore environment after step (default: false)</li>
<li><code>clear_env: bool</code> - Clear parent environment before applying step env (default: false)</li>
</ul>
<hr />
<h3 id="4-error-handling-and-retry-strategies-example"><a class="header" href="#4-error-handling-and-retry-strategies-example">4. Error Handling and Retry Strategies Example</a></h3>
<p>This example demonstrates comprehensive error handling patterns including retry strategies, backoff configurations, and circuit breakers.</p>
<p><strong>Source</strong>: workflows/implement-with-tests.yml (lines 1-79) and workflows/debtmap.yml</p>
<pre><code class="language-yaml"># Nested error handling with automatic recovery
commands:
  # Step 1: Implement specification
  - claude: "/prodigy-implement-spec $ARG"
    analysis:
      max_cache_age: 300

  # Step 2: Run tests with nested error recovery
  - shell: "cargo test"
    capture_output: "test_output"
    commit_required: false
    on_failure:
      # First attempt: Debug test failures
      claude: "/prodigy-debug-test-failures '${test_output}'"
      commit_required: true
      on_success:
        # Verify fixes work
        shell: "cargo test"
        commit_required: false
        on_failure:
          # Second attempt: Deep analysis if still failing
          claude: "/prodigy-fix-test-failures '${shell.output}' --deep-analysis"
          commit_required: true

  # Step 3: Run linting
  - claude: "/prodigy-lint"
    commit_required: false

  # Step 4: Run benchmarks (non-critical)
  - shell: "cargo bench --no-run"
    commit_required: false
    on_failure:
      shell: "echo 'Skipping benchmarks due to compilation issues'"
      commit_required: false

  # Step 5: Final verification with status reporting
  - shell: "cargo test --release"
    capture_output: "final_test_results"
    commit_required: false
    on_failure:
      # Report persistent failures
      claude: "/prodigy-report-test-status failed '${final_test_results}' --notify"
      commit_required: false
    on_success:
      shell: "echo '✅ All tests passing! Implementation complete.'"
      commit_required: false
</code></pre>
<p><strong>Error Handler Configuration</strong> (from src/config/command.rs:TestDebugConfig):</p>
<ul>
<li><code>claude: String</code> - Command to run on failure</li>
<li><code>max_attempts: u32</code> - Maximum retry attempts (default: 3)</li>
<li><code>fail_workflow: bool</code> - Stop workflow if max attempts exceeded (default: false)</li>
<li><code>commit_required: bool</code> - Whether handler must create commits (default: true)</li>
</ul>
<p><strong>Backoff Strategy Types</strong> (from src/cook/workflow/error_policy.rs:BackoffStrategy):</p>
<pre><code class="language-yaml"># Fixed delay between retries
retry:
  backoff:
    fixed:
      delay: 5s

# Linear backoff (delay increases linearly)
retry:
  backoff:
    linear:
      initial: 1s
      increment: 2s

# Exponential backoff (default: 2x multiplier)
retry:
  backoff:
    exponential:
      initial: 1s
      multiplier: 2.0

# Fibonacci sequence delays
retry:
  backoff:
    fibonacci:
      initial: 1s
</code></pre>
<p><strong>Circuit Breaker Configuration</strong> (from src/cook/workflow/error_policy.rs:CircuitBreakerConfig):</p>
<pre><code class="language-yaml">error_policy:
  circuit_breaker:
    failure_threshold: 5       # Open circuit after 5 failures
    success_threshold: 3       # Close after 3 successes
    timeout: 30s              # Time before attempting to close
    half_open_requests: 3     # Requests allowed in half-open state
</code></pre>
<hr />
<h3 id="5-goal-seeking-and-validation-examples"><a class="header" href="#5-goal-seeking-and-validation-examples">5. Goal-Seeking and Validation Examples</a></h3>
<p>This example demonstrates iterative refinement with validation and automatic gap filling.</p>
<p><strong>Source</strong>: workflows/goal-seeking-examples.yml (lines 1-129)</p>
<pre><code class="language-yaml"># Example 1: Test Coverage Improvement
- goal_seek:
    goal: "Achieve 90% test coverage"
    claude: "/prodigy-coverage --improve"
    validate: "cargo tarpaulin --print-summary 2&gt;/dev/null | grep 'Coverage' | sed 's/.*Coverage=\\([0-9]*\\).*/score: \\1/'"
    threshold: 90
    max_attempts: 5
    timeout_seconds: 300
    fail_on_incomplete: true
  commit_required: true

# Example 2: Performance Optimization
- goal_seek:
    goal: "Optimize algorithm performance to under 100ms"
    claude: "/optimize-performance --target 100ms"
    validate: "cargo bench --bench main_bench 2&gt;/dev/null | grep 'time:' | awk '{if ($2 &lt; 100) print \"score: 95\"; else print \"score:\", int(10000/$2)}'"
    threshold: 90
    max_attempts: 4
    timeout_seconds: 600
  commit_required: true

# Example 3: Code Quality with Custom Validation
- goal_seek:
    goal: "Fix all clippy warnings and improve code quality"
    claude: "/fix-clippy-warnings"
    validate: |
      warnings=$(cargo clippy 2&gt;&amp;1 | grep -c warning || echo 0)
      if [ "$warnings" -eq 0 ]; then
        echo "score: 100"
      else
        score=$((100 - warnings * 5))
        echo "score: $score"
      fi
    threshold: 95
    max_attempts: 3
    fail_on_incomplete: false
  commit_required: true

# Example 4: Multi-stage Goal Seeking
- name: "Complete feature implementation with quality checks"
  goal_seek:
    goal: "Implement user profile feature"
    claude: "/implement-feature user-profile"
    validate: "test -f src/features/user_profile.rs &amp;&amp; echo 'score: 100' || echo 'score: 0'"
    threshold: 100
    max_attempts: 2

- name: "Add comprehensive tests"
  goal_seek:
    goal: "Add tests for user profile feature"
    claude: "/add-tests src/features/user_profile.rs"
    validate: |
      test_count=$(grep -c "#\\[test\\]" src/features/user_profile.rs || echo 0)
      if [ "$test_count" -ge 5 ]; then
        echo "score: 100"
      else
        score=$((test_count * 20))
        echo "score: $score"
      fi
    threshold: 100
    max_attempts: 3

- name: "Ensure tests pass"
  goal_seek:
    goal: "Make all user profile tests pass"
    claude: "/fix-tests user_profile"
    validate: "cargo test user_profile 2&gt;&amp;1 | grep -q 'test result: ok' &amp;&amp; echo 'score: 100' || echo 'score: 0'"
    threshold: 100
    max_attempts: 4
    fail_on_incomplete: true
</code></pre>
<p><strong>Goal-Seeking Configuration</strong> (from src/cook/goal_seek/mod.rs):</p>
<ul>
<li><code>goal: String</code> - Human-readable description of the goal</li>
<li><code>claude: String</code> - Claude command to execute for improvement</li>
<li><code>validate: String</code> - Shell command that outputs “score: N” (0-100)</li>
<li><code>threshold: u32</code> - Minimum score required for success (0-100)</li>
<li><code>max_attempts: u32</code> - Maximum refinement iterations</li>
<li><code>timeout_seconds: u64</code> - Maximum time for all attempts</li>
<li><code>fail_on_incomplete: bool</code> - Fail workflow if threshold not reached</li>
</ul>
<p><strong>Validation Output Format</strong>:
The validation command must output a single line with the score:</p>
<pre><code>score: 85
</code></pre>
<p>The score should be between 0 and 100, where 100 indicates complete success.</p>
<hr />
<h3 id="6-foreach-parallel-iteration-example"><a class="header" href="#6-foreach-parallel-iteration-example">6. Foreach Parallel Iteration Example</a></h3>
<p>This example demonstrates parallel iteration over work items with different input sources and concurrency controls.</p>
<p><strong>Configuration Details</strong> (from src/config/command.rs:ForeachConfig):</p>
<pre><code class="language-yaml"># Static list input with parallel execution
- foreach:
    input: ["file1.rs", "file2.rs", "file3.rs"]
    parallel: 3  # Process 3 files concurrently
    do:
      - claude: "/lint ${item}"
      - shell: "rustfmt ${item}"
    continue_on_error: true  # Don't stop on individual item failures

# Command input (output becomes items)
- foreach:
    input:
      command: "find src -name '*.rs' -type f"
    parallel: 5
    do:
      - claude: "/analyze ${item}"
      - shell: "cargo check --file ${item}"
    max_items: 50  # Limit to first 50 files

# Sequential execution (no parallelism)
- foreach:
    input: ["step1", "step2", "step3"]
    parallel: false  # Execute sequentially
    do:
      - claude: "/execute-step ${item}"
</code></pre>
<p><strong>ForeachConfig Structure</strong>:</p>
<ul>
<li><code>input: ForeachInput</code> - Source of items (command or static list)
<ul>
<li><code>command: String</code> - Command whose output (one item per line) becomes items</li>
<li><code>list: Vec&lt;String&gt;</code> - Static list of items</li>
</ul>
</li>
<li><code>parallel: ParallelConfig</code> - Concurrency control
<ul>
<li><code>boolean: bool</code> - Enable/disable parallelism (true = default count, false = sequential)</li>
<li><code>count: usize</code> - Specific number of concurrent items</li>
</ul>
</li>
<li><code>do: Vec&lt;WorkflowStepCommand&gt;</code> - Commands to execute per item</li>
<li><code>continue_on_error: bool</code> - Continue if individual item fails (default: false)</li>
<li><code>max_items: Option&lt;usize&gt;</code> - Limit number of items to process</li>
</ul>
<p><strong>Item Access</strong>:</p>
<ul>
<li>Use <code>${item}</code> to reference the current item in commands</li>
<li>Each iteration runs in a clean environment</li>
<li>Failures are isolated to individual items</li>
</ul>
<hr />
<h3 id="7-write-file-command-example"><a class="header" href="#7-write-file-command-example">7. Write File Command Example</a></h3>
<p>This example demonstrates the <code>write_file</code> command for generating files during workflow execution.</p>
<p><strong>Configuration Details</strong> (from src/config/command.rs:WriteFileConfig):</p>
<pre><code class="language-yaml"># Write plain text file
- write_file:
    path: "reports/summary.txt"
    content: |
      Workflow Summary
      ================
      Project: ${PROJECT_NAME}
      Completed: ${map.successful}/${map.total} items
      Duration: ${workflow.duration}
    format: text
    create_dirs: true  # Create parent directories if needed

# Write JSON file with validation
- write_file:
    path: "config/generated.json"
    content: |
      {
        "version": "${VERSION}",
        "timestamp": "${timestamp}",
        "items_processed": ${map.total}
      }
    format: json  # Validates JSON syntax and pretty-prints
    mode: "0644"

# Write YAML configuration
- write_file:
    path: "config/deploy.yml"
    content: |
      environment: ${DEPLOY_ENV}
      version: ${VERSION}
      features:
        - feature1
        - feature2
    format: yaml  # Validates YAML syntax and formats
    create_dirs: true
</code></pre>
<p><strong>WriteFileConfig Structure</strong>:</p>
<ul>
<li><code>path: String</code> - File path (supports variable interpolation)</li>
<li><code>content: String</code> - Content to write (supports variable interpolation)</li>
<li><code>format: WriteFileFormat</code> - Output format (default: <code>text</code>)
<ul>
<li><code>text</code> - Plain text (no processing)</li>
<li><code>json</code> - JSON with validation and pretty-printing</li>
<li><code>yaml</code> - YAML with validation and formatting</li>
</ul>
</li>
<li><code>mode: String</code> - File permissions in octal format (default: <code>"0644"</code>)</li>
<li><code>create_dirs: bool</code> - Create parent directories (default: false)</li>
</ul>
<hr />
<h3 id="8-advanced-timeout-configuration-example"><a class="header" href="#8-advanced-timeout-configuration-example">8. Advanced Timeout Configuration Example</a></h3>
<p>This example demonstrates timeout configuration at multiple levels.</p>
<p><strong>Configuration Details</strong>:</p>
<pre><code class="language-yaml"># Global timeout for workflow
timeout: 3600  # 1 hour for entire workflow

commands:
  # Command-level timeout
  - shell: "long-running-task.sh"
    timeout: 600  # 10 minutes for this command

# MapReduce with phase-specific timeouts
setup:
  - shell: "setup-task.sh"
  timeout: 300  # 5 minutes for setup phase

map:
  agent_template:
    - claude: "/process ${item}"
      timeout: 180  # 3 minutes per command
  agent_timeout_secs: 600  # 10 minutes total per agent
  timeout_config:
    total_timeout_secs: 3600     # Max time for entire map phase
    idle_timeout_secs: 300       # Kill agent if idle for 5 minutes
    per_item_timeout_secs: 180   # Max time per work item

merge:
  commands:
    - claude: "/merge"
  timeout: 600  # 10 minutes for merge phase
</code></pre>
<p><strong>Timeout Hierarchy</strong> (most specific wins):</p>
<ol>
<li>Command-level <code>timeout:</code> - Per command</li>
<li>Agent-level <code>agent_timeout_secs:</code> - Per MapReduce agent</li>
<li>Phase-level <code>timeout:</code> - Per workflow phase (setup, reduce, merge)</li>
<li>Global-level <code>timeout:</code> - Entire workflow</li>
</ol>
<hr />
<h3 id="cross-references"><a class="header" href="#cross-references">Cross-References</a></h3>
<p>For more detailed information on specific features:</p>
<ul>
<li><strong>Workflow Structure</strong>: See <a href="../workflow-basics/full-workflow-structure.html">../workflow-basics/full-workflow-structure.md</a></li>
<li><strong>Environment Variables</strong>: See <a href="environment-variables.html">environment-variables.md</a></li>
<li><strong>Error Handling</strong>: See <a href="../error-handling.html">../error-handling.md</a></li>
<li><strong>MapReduce Basics</strong>: See <a href="../mapreduce/index.html">../mapreduce/index.md</a></li>
<li><strong>Validation</strong>: See <a href="../advanced/implementation-validation.html">../advanced/implementation-validation.md</a></li>
<li><strong>Goal Seeking</strong>: See <a href="../advanced/goal-seeking-operations.html">../advanced/goal-seeking-operations.md</a></li>
</ul>
<hr />
<h3 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h3>
<ol>
<li><strong>Start Simple</strong>: Begin with basic workflows and add complexity incrementally</li>
<li><strong>Use Environment Variables</strong>: Parameterize workflows for reusability across projects</li>
<li><strong>Add Validation</strong>: Use <code>validate:</code> blocks with <code>on_incomplete</code> for quality gates</li>
<li><strong>Handle Errors Gracefully</strong>: Add <code>on_failure:</code> handlers for automatic recovery</li>
<li><strong>Capture Outputs</strong>: Use <code>capture_output:</code> to pass data between steps</li>
<li><strong>Set Timeouts</strong>: Always set timeouts to prevent hanging workflows</li>
<li><strong>Test Incrementally</strong>: Test each phase separately before running full workflow</li>
<li><strong>Use Annotations</strong>: Add comments explaining configuration choices</li>
<li><strong>Profile for Environments</strong>: Use <code>profiles:</code> for dev/staging/prod configurations</li>
<li><strong>Monitor Progress</strong>: Use <code>-v</code> flag to watch Claude streaming output during development</li>
</ol>
<hr />
<h3 id="common-configuration-pitfalls"><a class="header" href="#common-configuration-pitfalls">Common Configuration Pitfalls</a></h3>
<ol>
<li><strong>Missing <code>mode: mapreduce</code></strong>: Standard workflows default to sequential mode</li>
<li><strong>Wrong JSONPath</strong>: Use <code>"$[*]"</code> for array root, not <code>"$.items[*]"</code> if items are at root</li>
<li><strong>Environment Variable Syntax</strong>: Use <code>${VAR}</code> for Prodigy variables, <code>$VAR</code> for shell variables</li>
<li><strong>Validation Score Format</strong>: Must output exactly <code>"score: N"</code> (0-100)</li>
<li><strong>Forgetting <code>commit_required</code></strong>: Set to <code>true</code> when commits are expected</li>
<li><strong>Merge Variables</strong>: Always use <code>${merge.source_branch}</code> and <code>${merge.target_branch}</code>, not hardcoded branches</li>
<li><strong>Timeout Units</strong>: Always in seconds, not milliseconds</li>
<li><strong>Parallel Count</strong>: Must be a number or env var reference (string), not interpolated expression</li>
</ol>
<hr />
<h3 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h3>
<ul>
<li>Explore real-world workflows in the <code>workflows/</code> directory</li>
<li>Read the <a href="best-practices.html">Configuration Best Practices</a> guide</li>
<li>Learn about <a href="../composition/index.html">Workflow Composition</a> for reusable templates</li>
<li>Review <a href="../mapreduce/troubleshooting.html">MapReduce Troubleshooting</a> for debugging tips</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../configuration/environment-variables.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../configuration/default-values-reference.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../configuration/environment-variables.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../configuration/default-values-reference.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
