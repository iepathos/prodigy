# Specification 34: Worktree-Specific Temporary Spec Storage

**Category**: storage
**Priority**: high
**Status**: draft
**Dependencies**: Spec 29 (Centralized Worktree State)

## Context

Currently, temporary improvement specifications generated by `/mmm-code-review` are stored in `/specs/temp/` and accumulate indefinitely. With 17 files already present and no cleanup mechanism, this approach leads to:
- File system pollution with obsolete specs
- Confusion between permanent feature specs and temporary improvement specs
- No lifecycle management for temporary specifications
- Manual cleanup burden on users

Since we already have worktree isolation (Spec 24) and centralized worktree state (Spec 29), we can leverage the worktree infrastructure to provide automatic lifecycle management for temporary specs.

## Objective

Move temporary improvement specification storage from the global `/specs/temp/` directory to worktree-specific `.metadata/` directories, providing automatic cleanup when worktrees are removed and better isolation between parallel improvement sessions.

## Requirements

### Functional Requirements
- Store temporary improvement specs in `{worktree}/.metadata/specs/` instead of `/specs/temp/`
- Maintain the same file naming convention: `iteration-{timestamp}-improvements.md`
- Support both worktree and non-worktree modes of operation
- Preserve git-native workflow with spec IDs in commit messages
- Ensure specs are accessible to `/mmm-implement-spec` command

### Non-Functional Requirements
- No performance degradation in spec generation or retrieval
- Maintain backward compatibility with existing specs in `/specs/temp/`
- Preserve audit trail through git commits
- Zero manual cleanup required

## Acceptance Criteria

- [ ] `/mmm-code-review` writes specs to `.metadata/specs/` when in worktree mode
- [ ] `/mmm-code-review` writes specs to `.mmm/temp-specs/` when in non-worktree mode  
- [ ] `/mmm-implement-spec` can locate specs in new locations
- [ ] Worktree cleanup automatically removes all temporary specs
- [ ] Existing specs in `/specs/temp/` can still be implemented
- [ ] Git ignore patterns updated to exclude new temp spec locations
- [ ] Documentation updated to reflect new storage approach

## Technical Details

### Implementation Approach

1. **Spec Location Resolution**
   ```rust
   fn get_temp_spec_dir(worktree_session: Option<&WorktreeSession>) -> PathBuf {
       match worktree_session {
           Some(session) => session.path.join(".metadata/specs"),
           None => PathBuf::from(".mmm/temp-specs")
       }
   }
   ```

2. **Directory Structure**
   ```
   # In worktree mode:
   .worktrees/mmm-improve-{timestamp}/
   └── .metadata/
       ├── specs/
       │   ├── iteration-1234567890-improvements.md
       │   └── iteration-1234567891-improvements.md
       └── state.json

   # In non-worktree mode:
   .mmm/
   └── temp-specs/
       ├── iteration-1234567890-improvements.md
       └── iteration-1234567891-improvements.md
   ```

3. **Spec Discovery Order**
   - Check worktree `.metadata/specs/` first
   - Fall back to `.mmm/temp-specs/`
   - Check legacy `/specs/temp/` for backward compatibility

### Architecture Changes

- Modify `/mmm-code-review` to use context-aware spec directory
- Update `/mmm-implement-spec` to search multiple locations
- Extend `WorktreeSession` to track temp spec location
- Add spec migration utility for existing files

### Data Structures

```rust
pub struct TempSpecManager {
    worktree_session: Option<WorktreeSession>,
    spec_dir: PathBuf,
}

impl TempSpecManager {
    pub fn new(worktree_session: Option<WorktreeSession>) -> Result<Self>;
    pub fn write_spec(&self, spec_id: &str, content: &str) -> Result<PathBuf>;
    pub fn read_spec(&self, spec_id: &str) -> Result<String>;
    pub fn list_specs(&self) -> Result<Vec<String>>;
}
```

### APIs and Interfaces

No external API changes. Internal changes:
- `get_temp_spec_path()` function to abstract location logic
- `ensure_spec_dir()` to create directories as needed
- `find_spec_file()` to search multiple locations

## Dependencies

- **Prerequisites**: Spec 29 (Centralized Worktree State) must be implemented
- **Affected Components**: 
  - `/mmm-code-review` command
  - `/mmm-implement-spec` command  
  - `improve` module
  - Worktree manager
- **External Dependencies**: None

## Testing Strategy

- **Unit Tests**: 
  - Test spec location resolution logic
  - Verify directory creation
  - Test spec read/write operations
- **Integration Tests**:
  - Full improvement loop with worktree-specific storage
  - Verify cleanup on worktree removal
  - Test backward compatibility with old specs
- **Performance Tests**: 
  - Ensure no regression in spec operations
- **User Acceptance**:
  - Run improvement sessions and verify spec lifecycle
  - Confirm no manual cleanup needed

## Documentation Requirements

- **Code Documentation**: 
  - Document new TempSpecManager struct and methods
  - Update comments in code review and implement commands
- **User Documentation**:
  - Update README.md to reflect new temp spec locations
  - Add note about automatic cleanup with worktrees
- **Architecture Updates**:
  - Update ARCHITECTURE.md temporary spec section
  - Document new directory structure

## Implementation Notes

1. **Migration Path**: 
   - Keep checking `/specs/temp/` for backward compatibility
   - Optionally provide `mmm migrate-temp-specs` command
   - Could auto-migrate on first run

2. **Non-Worktree Mode**:
   - Use `.mmm/temp-specs/` for better organization
   - This directory should be git-ignored
   - Consider adding periodic cleanup command

3. **Edge Cases**:
   - Handle permission errors on directory creation
   - Gracefully fall back if `.metadata/` cannot be created
   - Ensure spec IDs remain unique across locations

## Migration and Compatibility

- No breaking changes to external interfaces
- Existing specs in `/specs/temp/` continue to work
- New `.gitignore` entries needed:
  ```
  .mmm/temp-specs/
  # .metadata/ already ignored in worktrees
  ```
- Optional migration tool to move existing specs to new location