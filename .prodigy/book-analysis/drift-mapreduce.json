{
  "chapter_id": "mapreduce",
  "chapter_title": "MapReduce Workflows",
  "chapter_file": "book/src/mapreduce.md",
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Chapter is generally accurate but has several documentation gaps around error handling configuration and capture formats. The modern syntax vs deprecated syntax distinction is well explained, but circuit breaker configuration format in the chapter doesn't match the actual implementation.",
  "issues": [
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Error Handling Policy - Circuit Breaker Configuration",
      "description": "Chapter shows circuit_breaker.timeout as a number in seconds, but the implementation uses Duration type serialized with humantime_serde (e.g., '60s', '1m')",
      "current_content": "circuit_breaker:\n  failure_threshold: 5\n  success_threshold: 2\n  timeout: 60              # Seconds before attempting half-open",
      "should_be": "circuit_breaker:\n  failure_threshold: 5\n  success_threshold: 2\n  timeout: \"60s\"           # Duration format: '60s', '1m', etc.",
      "fix_suggestion": "Update example to show Duration format with humantime_serde. Add note that timeout accepts duration strings like '60s', '1m', '5m'",
      "source_reference": "src/cook/workflow/error_policy.rs:48-61 (CircuitBreakerConfig with humantime_serde)"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Error Handling Policy - Retry Backoff Configuration",
      "description": "Chapter shows backoff configuration with millisecond numbers and max_delay, but implementation uses Duration types without max_delay field",
      "current_content": "retry_config:\n  max_attempts: 3\n  backoff:\n    type: exponential\n    initial: 1000          # Initial delay in ms\n    multiplier: 2\n    max_delay: 30000       # Maximum delay in ms",
      "should_be": "retry_config:\n  max_attempts: 3\n  backoff:\n    exponential:\n      initial: \"1s\"        # Duration format\n      multiplier: 2.0",
      "fix_suggestion": "Update to show correct BackoffStrategy enum variants (Fixed, Linear, Exponential, Fibonacci) with Duration fields. Remove max_delay which doesn't exist in implementation. Show that initial/delay use Duration types.",
      "source_reference": "src/cook/workflow/error_policy.rs:92-99 (RetryConfig), 108-128 (BackoffStrategy enum)"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Setup Phase - Capture Formats",
      "description": "Chapter mentions 'format: json' for capture_outputs but doesn't explain all available formats or how they differ from CaptureConfig",
      "should_add": "Document that capture_outputs uses CaptureConfig which can be Simple(index) or Detailed with source, pattern, json_path, max_size, default, and multiline options. The 'format' field shown is actually not part of CaptureConfig - it may be confused with CaptureFormat from workflow variables.",
      "fix_suggestion": "Add subsection explaining CaptureConfig enum: Simple(usize) vs Detailed { command_index, source (stdout/stderr/both), pattern (regex), json_path, max_size, default, multiline }. Clarify distinction from CaptureFormat used elsewhere.",
      "source_reference": "src/cook/execution/variable_capture.rs:18-41 (CaptureConfig enum)"
    },
    {
      "type": "unclear_content",
      "severity": "medium",
      "section": "Setup Phase - Capture Configuration Example",
      "description": "Chapter shows 'format: json' in capture configuration but this field doesn't exist in CaptureConfig struct",
      "current_content": "analysis_result:\n  command_index: 1\n  format: json  # string, number, json, lines, boolean",
      "should_be": "analysis_result:\n  command_index: 1\n  json_path: \"$.result\"  # Use json_path for JSON extraction\n  # OR use pattern: \"regex\" for regex extraction\n  # OR use source: stdout/stderr/both",
      "fix_suggestion": "Replace 'format' field with actual CaptureConfig fields. Show examples of json_path for JSON, pattern for regex extraction, and source for selecting stdout/stderr.",
      "source_reference": "src/cook/execution/variable_capture.rs:22-40 (CaptureConfig::Detailed fields)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Map Phase - timeout_config",
      "description": "Chapter mentions agent_timeout_secs but doesn't document the more advanced timeout_config field that exists in MapPhaseYaml",
      "should_add": "Document timeout_config field as advanced option for more sophisticated timeout configuration beyond simple agent_timeout_secs",
      "fix_suggestion": "Add section on advanced timeout configuration showing timeout_config as alternative to agent_timeout_secs",
      "source_reference": "src/config/mapreduce.rs:259-260 (timeout_config field in MapPhaseYaml)"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Error Handling - ErrorCollectionStrategy variants",
      "description": "Chapter mentions error_collection: aggregate/immediate/batched:N but doesn't fully explain what each strategy does",
      "should_add": "Explain ErrorCollectionStrategy variants:\n- aggregate: Collect all errors and report at end\n- immediate: Report each error as it occurs\n- batched:N: Report errors in batches of N items",
      "fix_suggestion": "Add subsection explaining each error collection strategy with use cases for when to use each",
      "source_reference": "src/cook/workflow/error_policy.rs (ErrorCollectionStrategy enum - search for it)"
    }
  ],
  "positive_aspects": [
    "Excellent explanation of modern vs deprecated syntax for agent_template and reduce phases",
    "Clear examples showing both simplified and full configuration formats",
    "Good coverage of MapReduce structure (setup, map, reduce, merge)",
    "Well-documented merge workflow with variable interpolation examples",
    "Comprehensive coverage of filtering, sorting, offset, distinct, and max_items options",
    "Good explanation of convenience fields mapping to error_policy"
  ],
  "improvement_suggestions": [
    "Add a 'Common Pitfalls' section covering:\n  - Duration format requirements for timeout fields\n  - Confusion between CaptureConfig and CaptureFormat\n  - When to use Simple vs Detailed capture configuration",
    "Include a real-world example showing complete error handling configuration that actually works",
    "Add cross-references to 'Variables' chapter for ${map.results}, ${item}, etc.",
    "Consider adding a troubleshooting section for common MapReduce configuration errors",
    "Show example of BackoffStrategy variants (Fixed, Linear, Exponential, Fibonacci) with actual working YAML"
  ],
  "metadata": {
    "analyzed_at": "2025-10-03",
    "feature_inventory": ".prodigy/book-analysis/features.json (not found, used direct code inspection)",
    "topics_covered": [
      "MapReduce mode",
      "Setup phase",
      "Map phase",
      "Reduce phase",
      "Parallel execution",
      "Error handling",
      "Merge workflows",
      "Variable capture"
    ],
    "validation_focus": "Check MapReduce configuration matches MapReduceWorkflowConfig struct",
    "code_references": [
      "src/config/mapreduce.rs:MapReduceWorkflowConfig",
      "src/config/mapreduce.rs:MapPhaseYaml",
      "src/config/mapreduce.rs:ReducePhaseYaml",
      "src/config/mapreduce.rs:SetupPhaseConfig",
      "src/cook/workflow/error_policy.rs:WorkflowErrorPolicy",
      "src/cook/workflow/error_policy.rs:CircuitBreakerConfig",
      "src/cook/workflow/error_policy.rs:RetryConfig",
      "src/cook/workflow/error_policy.rs:BackoffStrategy",
      "src/cook/execution/variable_capture.rs:CaptureConfig"
    ]
  }
}
