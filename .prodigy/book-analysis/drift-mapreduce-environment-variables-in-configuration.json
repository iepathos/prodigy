{
  "item_type": "subsection",
  "chapter_id": "mapreduce",
  "subsection_id": "environment-variables-in-configuration",
  "subsection_title": "Environment Variables in Configuration",
  "subsection_file": "book/src/mapreduce/environment-variables-in-configuration.md",
  "feature_mappings": [
    "environment.mapreduce",
    "environment.variables"
  ],
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Subsection is comprehensive and well-structured with excellent source references and examples. The main issue is inconsistent secret syntax documentation that may confuse users. The documentation shows a `secret: true` flag format that doesn't match the actual workflow examples which use provider-based syntax. Otherwise, coverage is thorough with accurate technical details, complete examples, and helpful cross-references.",
  "issues": [
    {
      "type": "inconsistent_examples",
      "severity": "medium",
      "section": "Secrets Configuration",
      "description": "Documentation shows secret syntax with `secret: true` flag, but actual workflow examples use provider-based syntax without the secret flag",
      "current_content": "API_KEY:\n  secret: true\n  value: \"${env:SECRET_API_KEY}\"",
      "actual_usage_in_workflows": "secrets:\n  API_KEY: \"${env:SECRET_API_KEY}\"\n\nor\n\nsecrets:\n  API_TOKEN:\n    provider: env\n    key: \"GITHUB_TOKEN\"",
      "fix_suggestion": "Show both syntaxes with clear explanation:\n1. Simple syntax: secrets:\n     API_KEY: \"${env:SECRET_API_KEY}\"\n2. Provider syntax: secrets:\n     API_TOKEN:\n       provider: env\n       key: \"GITHUB_TOKEN\"\n\nClarify that the `secret: true` flag is for env block secrets, not the separate secrets block.",
      "source_reference": "workflows/mapreduce-env-example.yml:23-26, workflows/environment-example.yml:21-23"
    },
    {
      "type": "unclear_content",
      "severity": "low",
      "section": "Secrets Configuration",
      "description": "Mixing of `env` block secrets (with secret: true flag) and `secrets` block (dedicated secrets section) may confuse users about which approach to use",
      "current_content": "Lines 27-40 show secrets within env block with secret: true flag, but workflows use separate secrets: block",
      "should_be": "Clearly differentiate between:\n1. Dedicated `secrets:` top-level block (recommended for secrets)\n2. Inline secrets in `env:` block with `secret: true` flag (for backwards compatibility)",
      "fix_suggestion": "Add a subsection explaining the two approaches:\n**Approach 1: Dedicated Secrets Block (Recommended)**\n```yaml\nsecrets:\n  API_KEY: \"${env:SECRET_API_KEY}\"\n```\n\n**Approach 2: Inline Secrets in Env Block**\n```yaml\nenv:\n  API_KEY:\n    secret: true\n    value: \"${env:SECRET_API_KEY}\"\n```",
      "source_reference": "src/config/workflow.rs:24-26 (secrets field), src/cook/environment/config.rs:84-96 (SecretValue enum)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Variable Interpolation in Environment Values",
      "description": "Section mentions interpolation in env values but doesn't show concrete examples of environment variables referencing other environment variables",
      "current_content": "Lines 121-132 discuss interpolation but examples shown are generic",
      "should_be": "Show real working example from actual workflow:\nenv:\n  PROJECT_NAME: \"my-project\"\n  OUTPUT_DIR: \"output\"\n  REPORT_FORMAT: \"json\"\n  # Environment variable referencing other env vars\n  REPORT_PATH: \"${OUTPUT_DIR}/${PROJECT_NAME}-summary.${REPORT_FORMAT}\"",
      "fix_suggestion": "Add practical example showing environment variable composition as seen in workflows/mapreduce-env-example.yml:78",
      "source_reference": "workflows/mapreduce-env-example.yml:78"
    }
  ],
  "positive_aspects": [
    "Comprehensive coverage of all environment configuration features",
    "Excellent source code references (e.g., src/config/workflow.rs:11-39)",
    "Includes test file references for validation (tests/mapreduce_env_execution_test.rs)",
    "Clear explanation of environment precedence order",
    "Complete working example demonstrating all features (lines 175-243)",
    "Detailed best practices section covering security and usage patterns",
    "Good debugging section with verbose output examples",
    "All internal cross-reference links are valid and correctly formatted",
    "Thorough documentation of advanced features (clear_env, temporary, working_dir)",
    "Well-structured with logical progression from basic to advanced topics"
  ],
  "improvement_suggestions": [
    "Clarify the two secret configuration approaches (dedicated secrets: block vs env: block with secret: true)",
    "Add a comparison table showing when to use each secret configuration approach",
    "Include more examples of environment variable composition (vars referencing other vars)",
    "Add a troubleshooting subsection for common environment variable issues",
    "Show example of using profiles with command-line override: MAX_WORKERS=10 prodigy run workflow.yml --profile prod",
    "Add note about case sensitivity of environment variable names",
    "Include example of debugging environment variable resolution with -vv flag output"
  ],
  "cross_references": [
    "variables/index.md - Complete guide to environment variables and interpolation",
    "environment/index.md - Detailed environment management patterns",
    "environment/mapreduce-environment-variables.md - MapReduce-specific environment features",
    "environment/secrets-management.md - Security best practices for secrets",
    "environment/environment-profiles.md - Multi-environment deployment patterns",
    "setup-phase-advanced.md - Using environment variables in setup commands",
    "index.md - Main MapReduce workflow documentation"
  ],
  "metadata": {
    "analyzed_at": "2025-01-11T07:30:00Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "environment variables",
      "secrets",
      "profiles",
      "configuration",
      "variable interpolation",
      "environment precedence",
      "step-level environment"
    ],
    "validation_focus": "Check environment variable configuration in MapReduce workflows",
    "internal_links_validated": 7,
    "broken_links_found": 0,
    "source_files_referenced": [
      "src/config/workflow.rs",
      "src/cook/environment/config.rs",
      "src/cook/environment/manager.rs",
      "tests/mapreduce_env_execution_test.rs",
      "tests/environment_workflow_test.rs",
      "workflows/mapreduce-env-example.yml",
      "workflows/environment-example.yml",
      "examples/test-sensitive-masking.yml"
    ]
  }
}
