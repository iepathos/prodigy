{
  "chapter_id": "advanced",
  "chapter_title": "Advanced Features",
  "chapter_file": "book/src/advanced.md",
  "drift_detected": true,
  "severity": "high",
  "quality_assessment": "Chapter documents several features that don't exist in implementation, missing actual advanced features, and has incorrect examples",
  "issues": [
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: on_exit_code",
      "description": "Chapter shows on_exit_code feature but this is not implemented in WorkflowStepCommand",
      "current_content": "on_exit_code:\n  0:\n    shell: \"echo 'Success!'\"\n  101:\n    claude: \"/fix-compilation-errors\"",
      "should_be": "Feature does not exist in implementation",
      "fix_suggestion": "Remove on_exit_code section entirely as it's not implemented in src/config/command.rs:WorkflowStepCommand. The struct only has on_success and on_failure, not on_exit_code.",
      "source_reference": "src/config/command.rs:325-331 (only on_failure and on_success exist)"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: Enhanced Retry Configuration",
      "description": "Chapter shows retry with exponential backoff but this is not implemented for workflow commands",
      "current_content": "retry:\n  max_attempts: 5\n  backoff:\n    type: exponential\n    initial: 1000\n    multiplier: 2",
      "should_be": "Feature does not exist in workflow commands",
      "fix_suggestion": "Remove Enhanced Retry Configuration section entirely. RetryConfig with backoff only exists in StorageConfig (src/storage/config.rs:115-135) for storage operations, not for workflow command steps.",
      "source_reference": "src/config/command.rs:WorkflowStepCommand has no retry field; src/storage/config.rs:115-135 has RetryConfig but only for storage"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: Working Directory",
      "description": "Chapter shows working_dir field but this is not implemented in WorkflowStepCommand",
      "current_content": "working_dir: \"/path/to/project\"",
      "should_be": "Feature does not exist at step level",
      "fix_suggestion": "Remove Working Directory section. The working_dir only exists at the normalized step level internally (src/cook/workflow/normalized.rs:35), not as a user-facing YAML field in WorkflowStepCommand.",
      "source_reference": "src/config/command.rs:WorkflowStepCommand has no working_dir field"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: Auto-Commit",
      "description": "Chapter shows auto_commit field but this is not implemented in WorkflowStepCommand",
      "current_content": "auto_commit: true",
      "should_be": "Feature does not exist",
      "fix_suggestion": "Remove Auto-Commit section entirely. WorkflowStepCommand only has commit_required field (src/config/command.rs:311), not auto_commit.",
      "source_reference": "src/config/command.rs:309-311 (only commit_required exists)"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: Output File Redirection",
      "description": "Chapter shows output_file field",
      "current_content": "output_file: \"test-results.txt\"",
      "should_be": "Field exists but no documentation of how it works",
      "fix_suggestion": "Verify output_file actually works (it exists at src/config/command.rs:355) and add explanation of behavior. Does it redirect stdout? Both stdout and stderr? How does it interact with capture?",
      "source_reference": "src/config/command.rs:353-355 (output_file exists but behavior unclear)"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: Modular Handlers",
      "description": "Chapter shows handler syntax but this is not implemented in WorkflowStepCommand",
      "current_content": "handler:\n  name: \"custom-validator\"\n  attributes:\n    path: \"src/\"\n    threshold: 80",
      "should_be": "Feature does not exist in YAML config",
      "fix_suggestion": "Remove Modular Handlers section. HandlerConfig only exists in normalized representation (src/cook/workflow/normalized.rs:57-62), not as a user-facing YAML field.",
      "source_reference": "src/config/command.rs:WorkflowStepCommand has no handler field"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Missing: Step Validation",
      "description": "Chapter shows step_validate field but this is not implemented",
      "current_content": "step_validate:\n  shell: \"curl -f https://app.com/health\"\n  timeout: 30\n  on_failure:\n    shell: \"rollback.sh\"",
      "should_be": "Feature does not exist",
      "fix_suggestion": "Remove Step Validation section entirely. WorkflowStepCommand has 'validate' field (src/config/command.rs:335) which is ValidationConfig for checking implementation completeness, not step_validate for post-execution validation.",
      "source_reference": "src/config/command.rs:333-335 (only validate exists, not step_validate)"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Missing: agent_timeout_secs",
      "description": "Chapter shows agent_timeout_secs in MapReduce config but field may not exist",
      "current_content": "map:\n  agent_timeout_secs: 300\n  timeout_config:\n    default: 300\n    per_command:\n      \"cargo test\": 600",
      "should_be": "Need to verify if these timeout fields exist in MapReduceWorkflowConfig",
      "fix_suggestion": "Verify MapReduceWorkflowConfig supports agent_timeout_secs and timeout_config fields. If not, remove this section.",
      "source_reference": "Need to check src/config/mapreduce.rs for actual timeout fields"
    },
    {
      "type": "correct_documentation",
      "severity": "none",
      "section": "Conditional Execution - when",
      "description": "The 'when' field is correctly documented",
      "current_content": "when: \"${tests_passed}\"",
      "fix_suggestion": "No changes needed - when field exists at src/config/command.rs:341-343"
    },
    {
      "type": "correct_documentation",
      "severity": "none",
      "section": "Conditional Execution - on_success",
      "description": "The 'on_success' field is correctly documented",
      "current_content": "on_success:\n  shell: \"cargo bench\"",
      "fix_suggestion": "No changes needed - on_success exists at src/config/command.rs:329-331"
    },
    {
      "type": "correct_documentation",
      "severity": "none",
      "section": "Conditional Execution - on_failure",
      "description": "The 'on_failure' field is correctly documented with max_attempts and fail_workflow",
      "current_content": "on_failure:\n  claude: \"/fix-warnings\"\n  max_attempts: 3\n  fail_workflow: false",
      "fix_suggestion": "No changes needed - on_failure exists at src/config/command.rs:325-327 with TestDebugConfig"
    },
    {
      "type": "correct_documentation",
      "severity": "none",
      "section": "Output Capture Formats",
      "description": "All capture formats are correctly documented",
      "current_content": "capture_format: string|number|json|lines|boolean",
      "fix_suggestion": "No changes needed - matches CaptureFormat enum at src/cook/workflow/variables.rs:253-265",
      "source_reference": "src/cook/workflow/variables.rs:253-265"
    },
    {
      "type": "correct_documentation",
      "severity": "none",
      "section": "Timeout Configuration",
      "description": "Command-level timeout is correctly documented",
      "current_content": "timeout: 600",
      "fix_suggestion": "No changes needed - timeout exists at src/config/command.rs:337-339"
    },
    {
      "type": "correct_documentation",
      "severity": "none",
      "section": "Nested Conditionals",
      "description": "Nested on_success and on_failure are correctly shown",
      "current_content": "Shows nested on_success with nested on_failure",
      "fix_suggestion": "No changes needed - nesting is supported since on_success/on_failure contain Box<WorkflowStepCommand>"
    }
  ],
  "positive_aspects": [
    "Clear examples for conditional execution (when, on_success, on_failure)",
    "Good coverage of output capture formats",
    "Demonstrates nested conditionals well",
    "Timeout configuration is accurate"
  ],
  "improvement_suggestions": [
    "Remove all non-existent features (on_exit_code, retry backoff, working_dir, auto_commit, handler, step_validate)",
    "Add actual advanced features that exist but aren't documented: capture field, capture_streams configuration, validate field for implementation validation",
    "Add section on environment variables (env field exists in WorkflowStepCommand)",
    "Explain relationship between capture, capture_format, and capture_streams",
    "Add examples of foreach command for parallel iteration",
    "Add examples of goal_seek for iterative refinement",
    "Document id field for referencing step outputs",
    "Show examples of variable interpolation in advanced scenarios"
  ],
  "metadata": {
    "analyzed_at": "2025-10-03",
    "feature_inventory": "Analyzed from source code directly",
    "topics_covered": [
      "Conditional execution",
      "Output capture formats",
      "Nested conditionals",
      "Timeouts"
    ],
    "validation_focus": "Check advanced features match implementation"
  }
}
