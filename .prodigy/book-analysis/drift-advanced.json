{
  "chapter_id": "advanced",
  "chapter_title": "Advanced Features",
  "chapter_file": "book/src/advanced.md",
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Chapter is well-structured and covers most advanced features accurately, but has some missing content and incomplete explanations for certain capabilities. Overall alignment with implementation is good, but documentation could be enhanced with additional details on operators, step-level environment configuration, and field name clarifications.",
  "issues": [
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Conditional Execution - Expression Syntax",
      "description": "Chapter mentions comparison operators (==, !=) and logical operators (&&, ||) but doesn't document the full range of operators available",
      "should_add": "Document additional comparison operators: >, <, >=, <=, contains (from features.json)",
      "fix_suggestion": "Expand the 'Comparison Operators' subsection to include: >, <, >=, <= for numeric comparisons, and 'contains' for string matching with examples",
      "source_reference": "features.json advanced_features.conditional_execution.expression_syntax - lists ==, !=, >, <, >=, <=, contains"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "On Success Handlers (lines 64-72)",
      "description": "Chapter mentions on_success supports 'any workflow step command' but doesn't show examples of complex patterns",
      "current_content": "Note states: 'on_success supports any workflow step command with all its features, including nested conditionals, output capture, validation, and error handlers'",
      "should_add": "Examples showing on_success with validation, nested handlers, or multiple complex features",
      "fix_suggestion": "Add an example showing on_success with a claude command that has validation and its own on_failure handler, demonstrating the full power of nested handlers",
      "source_reference": "src/config/command.rs:WorkflowStepCommand - on_success field supports full command nesting"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "On Failure Handlers",
      "description": "Chapter documents on_failure config but doesn't mention that it supports 'commands' array for multiple remediation steps",
      "current_content": "Shows single command in on_failure: claude: /fix-warnings",
      "should_add": "Document that on_failure supports 'commands' array field for multi-step remediation sequences",
      "fix_suggestion": "Add an example showing on_failure with 'commands' array:\n```yaml\non_failure:\n  commands:\n    - claude: /analyze-error\n    - shell: cargo fmt\n    - claude: /verify-fix\n  max_attempts: 3\n```",
      "source_reference": "features.json error_handling.command_level.on_failure.structure mentions commands array, src/config/command.rs:TestDebugConfig"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Nested Conditionals",
      "description": "Chapter doesn't mention on_exit_code handler which allows mapping specific exit codes to different actions",
      "should_add": "Document on_exit_code for fine-grained exit code handling",
      "fix_suggestion": "Add a subsection 'Exit Code Handlers' showing on_exit_code:\n```yaml\n- shell: cargo test\n  on_exit_code:\n    1: {claude: /fix-test-failures}\n    2: {shell: retry.sh}\n    255: {fail_workflow: true}\n```",
      "source_reference": "features.json advanced_features.nested_handlers.on_exit_code - map specific exit codes to actions"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Stream Capture Control (lines 159-204)",
      "description": "Chapter shows both string and struct formats but the explanation of format flexibility could be clearer",
      "current_content": "Shows both formats with note about 'Format Flexibility' at line 203",
      "should_be": "The existing explanation is good but could explicitly mention untagged enum deserialization",
      "fix_suggestion": "Enhance the note to mention: 'Prodigy uses Rust's untagged enum deserialization, allowing you to choose either format based on your needs without any special syntax'",
      "source_reference": "src/config/command.rs and features.json - capture_streams supports both via untagged enum"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Working Directory Control",
      "description": "Chapter documents working_dir well but doesn't mention step-level environment overrides (env, clear_env, inherit)",
      "current_content": "Documents working_dir with examples and mentions cwd alias",
      "should_add": "Document full step-level environment configuration: env, working_dir, clear_env, inherit fields",
      "fix_suggestion": "Add subsection 'Step-Level Environment Overrides' showing:\n```yaml\n- shell: npm test\n  env:\n    NODE_ENV: test\n    DEBUG: \"*\"\n  working_dir: ./frontend\n  clear_env: false\n  inherit: true\n```",
      "source_reference": "features.json environment.step_env - StepEnvironment supports env, working_dir, clear_env, inherit"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Step Identification (lines 246-349)",
      "description": "Step IDs section is comprehensive but doesn't list all metadata fields available via step references",
      "current_content": "Shows ${test-step.output} usage but not all available fields",
      "should_add": "Document all step reference fields: ${step-id.output}, ${step-id.exit_code}, ${step-id.success}, ${step-id.duration}",
      "fix_suggestion": "Add a reference table at the beginning of the Step Identification section:\n\n**Available Step Reference Fields:**\n- `${step-id.output}` - Captured output (string)\n- `${step-id.exit_code}` - Exit code (number)\n- `${step-id.success}` - Success status (boolean)\n- `${step-id.duration}` - Execution time (seconds)",
      "source_reference": "features.json variables.capture_streams lists exit_code, success, duration fields"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Timeout Configuration (lines 352-367)",
      "description": "Chapter documents command-level timeouts but doesn't mention environment variable support for timeout values",
      "current_content": "Shows hardcoded timeout values: timeout: 600, timeout: 1800",
      "should_add": "Document that timeout fields support environment variable references",
      "fix_suggestion": "Add examples showing timeout with environment variables:\n```yaml\n# Use environment variable for timeout\n- shell: cargo bench\n  timeout: $BENCH_TIMEOUT\n\n# With default value\n- claude: /analyze-codebase\n  timeout: ${ANALYSIS_TIMEOUT:-1800}\n```",
      "source_reference": "features.json advanced_features.timeout_control.env_var_support - all timeout fields support env vars"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Validation with Result Files (lines 420-431)",
      "description": "Chapter mentions result_file option but doesn't explain the expected schema or how it differs from stdout parsing",
      "should_add": "Explain that result_file reads validation JSON from a file instead of parsing command stdout, useful for separating validation output from logs",
      "fix_suggestion": "Add explanation:\n\n**When to Use result_file:**\n- Validation produces complex JSON output\n- Want to separate validation results from command logs\n- Validation command produces additional stdout/stderr\n- Need to preserve validation output for debugging\n\nThe file should contain JSON matching the validation result schema (completion_percentage, status, gaps, etc.)",
      "source_reference": "features.json validation_and_quality.validation_config.result_file"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Validation - On Incomplete (lines 433-466)",
      "description": "Chapter documents on_incomplete fields correctly but actual examples always use verbose syntax",
      "current_content": "Shows verbose syntax with claude, max_attempts, fail_workflow, commit_required",
      "should_be": "Show both verbose and convenience array syntax in examples",
      "fix_suggestion": "Convert Example at line 437-445 to show the convenience array syntax:\n```yaml\n- claude: /implement-spec\n  validate:\n    shell: check-completeness.sh\n    threshold: 100\n    on_incomplete:\n      - claude: /fill-gaps\n      - shell: cargo fmt\n```\n\nThen show verbose syntax for complex cases requiring max_attempts or fail_workflow customization.",
      "source_reference": "features.json validation_and_quality.on_incomplete - supports both verbose and array syntax"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Foreach - Parallel Execution (lines 496-506)",
      "description": "Chapter shows 'parallel: 5' but doesn't mention that parallel can also be a boolean (true/false)",
      "current_content": "parallel: 5  # Process 5 items concurrently",
      "should_add": "Document that parallel accepts both boolean (true/false) and number (specific count) values",
      "fix_suggestion": "Update the parallel execution section:\n```yaml\n# Boolean - automatic parallelism\n- foreach:\n    foreach: ls *.txt\n    parallel: true  # Use all available cores\n    do:\n      - shell: analyze ${item}\n\n# Number - explicit concurrency limit\n- foreach:\n    foreach: ls *.txt\n    parallel: 5  # Process 5 items at a time\n    do:\n      - shell: analyze ${item}\n```",
      "source_reference": "features.json command_types.foreach.parallel_config - supports boolean and number"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Goal-Seeking Operations (line 544)",
      "description": "Chapter uses field name 'command' which may not match implementation",
      "current_content": "command: \"cargo fix\"",
      "should_be": "Verify if the field is 'command' or separate 'claude' and 'shell' fields",
      "fix_suggestion": "Based on features.json showing 'claude' and 'shell' as separate fields, update examples to:\n```yaml\n# Using shell command\n- goal_seek:\n    goal: All tests pass\n    shell: cargo fix  # or 'claude: /fix-issues'\n    validate: cargo test\n    threshold: 100\n```",
      "source_reference": "features.json command_types.goal_seek.fields - lists 'claude' and 'shell' as separate options, not 'command'"
    },
    {
      "type": "incorrect_example",
      "severity": "low",
      "section": "Goal-Seeking Operations (line 567)",
      "description": "Chapter uses field name 'timeout' instead of 'timeout_seconds' from the implementation",
      "current_content": "timeout: 300",
      "should_be": "timeout_seconds: 300",
      "fix_suggestion": "Verify correct field name and update all goal_seek examples to use 'timeout_seconds' if that's the correct field name from the implementation",
      "source_reference": "features.json command_types.goal_seek.fields shows 'timeout_seconds'"
    }
  ],
  "positive_aspects": [
    "Excellent organization with clear sections for each advanced feature",
    "Comprehensive coverage of conditional execution with detailed expression syntax explanation (lines 25-60)",
    "Good progression from basic to advanced patterns throughout the chapter",
    "Well-documented capture_streams with both simple and advanced formats (lines 159-204)",
    "Strong examples throughout showing real-world use cases",
    "Best practices section (lines 572-635) provides valuable guidance",
    "Common patterns section (lines 638-709) demonstrates practical applications",
    "Working directory control is well explained with clear use cases (lines 219-243)",
    "Step IDs section (lines 246-349) provides excellent guidance on when to use them with 4 detailed scenarios",
    "Validation section (lines 370-467) is thorough with multiple examples and convenience syntax",
    "All five capture formats documented correctly (string, number, json, lines, boolean)",
    "On failure handler defaults are accurately documented (max_attempts: 3, fail_workflow: false, commit_required: true)",
    "Output file redirection is documented (lines 206-217)",
    "Nested conditionals example shows practical chaining (lines 94-107)",
    "Foreach documentation covers all major configuration options (lines 469-530)"
  ],
  "improvement_suggestions": [
    "Add a reference table showing all comparison and logical operators supported in 'when' clauses (==, !=, >, <, >=, <=, contains, &&, ||)",
    "Include more examples of nested handler combinations showing the full power of on_success and on_failure",
    "Add documentation for on_exit_code handler for fine-grained exit code handling",
    "Add a 'Step-Level Environment Overrides' section documenting env, clear_env, and inherit fields",
    "Expand goal_seek section with verification of correct field names (command vs claude/shell, timeout vs timeout_seconds)",
    "Add a troubleshooting subsection for common conditional execution issues",
    "Add cross-references to related chapters (Environment chapter for step-level env, Error Handling chapter for on_failure details)",
    "Include examples showing integration of multiple advanced features together",
    "Document edge cases and gotchas (e.g., variable scope in nested handlers, depth limits for conditionals)",
    "Add performance considerations for parallel foreach execution",
    "Show more examples using convenience array syntax for on_incomplete to demonstrate both approaches"
  ],
  "metadata": {
    "analyzed_at": "2025-11-02",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Conditional execution",
      "Expression syntax for when clauses",
      "Output capture formats",
      "Stream capture control",
      "Nested conditionals",
      "On success and on failure handlers",
      "Timeouts",
      "Working directory control",
      "Step identification",
      "Validation with result files",
      "On incomplete handlers",
      "Foreach parallel iteration",
      "Goal-seeking operations",
      "Best practices",
      "Common patterns"
    ],
    "validation_focus": "Check advanced features match implementation",
    "implementation_alignment": "Good - most features documented accurately with some field name clarifications needed",
    "completeness_score": 0.85,
    "accuracy_score": 0.92
  }
}
