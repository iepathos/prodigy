{
  "item_type": "chapter",
  "chapter_id": "advanced",
  "chapter_title": "Advanced Features",
  "chapter_file": "book/src/advanced/index.md",
  "drift_detected": true,
  "severity": "high",
  "quality_assessment": "Chapter covers core advanced features well but has one critical issue with on_exit_code documentation showing a feature that isn't implemented in WorkflowStepCommand. Also missing duration field in capture_streams, and step-level environment configuration details need clarification.",
  "issues": [
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Exit Code Handlers (lines 128-141)",
      "description": "Documentation shows on_exit_code handler but this feature is not implemented in WorkflowStepCommand YAML config layer",
      "current_content": "- shell: \"cargo test\"\n  on_exit_code:\n    1: {claude: \"/fix-test-failures\"}\n    2: {shell: \"retry-flaky-tests.sh\"}\n    101: {claude: \"/fix-compilation-errors\"}\n    255: {fail_workflow: true}",
      "should_be": "Feature exists in normalized workflow structures (WorkflowStep) but not exposed in YAML config (WorkflowStepCommand)",
      "fix_suggestion": "REMOVE this section from documentation until on_exit_code is implemented in WorkflowStepCommand. The feature exists internally but isn't user-facing yet.",
      "source_reference": "src/config/command.rs:WorkflowStepCommand (field not present), src/cook/workflow/normalized.rs:69 (on_exit_code exists in WorkflowStep)"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Stream Capture Control (lines 230-245)",
      "description": "Missing duration field in CaptureStreams structured format documentation",
      "current_content": "capture_streams:\n  stdout: true\n  stderr: true\n  exit_code: true\n  success: true",
      "should_be": "capture_streams:\n  stdout: true\n  stderr: true\n  exit_code: true\n  success: true\n  duration: true",
      "fix_suggestion": "Add duration field to structured format example and explain that it captures command execution duration in seconds",
      "source_reference": "src/cook/workflow/variables.rs:269-292 (CaptureStreams struct includes duration field with default true)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "medium",
      "section": "Stream Capture Control (lines 248-250)",
      "description": "Documentation correctly mentions untagged enum deserialization but implementation details differ from what's shown",
      "current_content": "Shows both string and structured object formats with note about flexibility",
      "should_be": "Clarify that capture_streams accepts EITHER a simple string (stdout/stderr/both) OR a structured object (CaptureStreams)",
      "fix_suggestion": "Update Format Flexibility note to: 'The capture_streams field supports two formats: (1) Simple string values (\"stdout\", \"stderr\", \"both\") stored as Option<String> in config, or (2) Structured object with boolean fields parsed into CaptureStreams struct during execution. Use the simple format for basic cases, structured format when you need fine-grained control over exit_code, success, or duration capture.'",
      "source_reference": "src/config/command.rs:395 (capture_streams: Option<String>), src/cook/workflow/variables.rs:269 (CaptureStreams struct)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Step-Level Environment Overrides (lines 266-289)",
      "description": "Step-level environment configuration fields shown but not present in WorkflowStepCommand",
      "current_content": "Shows env, working_dir, clear_env, inherit fields in example",
      "should_be": "Only working_dir/cwd are actually in WorkflowStepCommand. env, clear_env, inherit may be in NormalizedWorkflowStep or execution layer",
      "fix_suggestion": "Verify which fields are actually in WorkflowStepCommand. If env/clear_env/inherit aren't there, either remove from docs or clarify they're execution-layer features not available in YAML config. Update example to only show fields that users can actually configure.",
      "source_reference": "src/config/command.rs:WorkflowStepCommand does not include env, clear_env, inherit fields"
    },
    {
      "type": "incorrect_example",
      "severity": "low",
      "section": "On Success Handlers (lines 79-91)",
      "description": "Complex on_success example shows incorrect nesting of validate field",
      "current_content": "on_success:\n  claude: /verify-build-artifacts\n  validate:\n    shell: check-binary-size.sh\n    threshold: 100\n  on_failure:\n    claude: /optimize-binary-size",
      "should_be": "validate is a separate field at WorkflowStepCommand level, not nested configuration under claude",
      "fix_suggestion": "Update example to show on_success as Box<WorkflowStepCommand> properly:\n```yaml\n- shell: \"cargo build --release\"\n  on_success:\n    claude: \"/verify-build-artifacts\"\n    validate:\n      shell: \"check-binary-size.sh\"\n      threshold: 100\n    on_failure:\n      claude: \"/optimize-binary-size\"\n```\nOr clarify that this shows a complete workflow step with all its fields",
      "source_reference": "src/config/command.rs:376 (on_success: Option<Box<WorkflowStepCommand>>), line 379 (validate is a separate field in WorkflowStepCommand)"
    }
  ],
  "positive_aspects": [
    "Excellent coverage of conditional execution with when clause and expression syntax",
    "Clear examples of comparison operators (==, !=, >, <, >=, <=, contains) and logical operators (&&, ||)",
    "Good explanation of output capture formats (string, json, lines, number, boolean)",
    "Well-structured progression from simple to complex patterns",
    "Type coercion explanation is clear and accurate (lines 47-50)",
    "Good cross-references to related subsections at end",
    "On failure handler defaults accurately documented (max_attempts: 3, fail_workflow: false, commit_required: true)",
    "Multi-step remediation with commands array documented (lines 115-126)",
    "Nested conditionals example shows practical chaining (lines 143-156)",
    "Output file redirection documented (lines 251-264)"
  ],
  "improvement_suggestions": [
    "CRITICAL: Remove on_exit_code section until feature is implemented in WorkflowStepCommand",
    "Add duration field to capture_streams structured format example with explanation",
    "Clarify which step-level environment fields (env, clear_env, inherit) are actually available in YAML config",
    "Fix on_success complex example to show proper field structure",
    "Add troubleshooting section for common conditional execution issues",
    "Include example of combining capture_output with capture_format and capture_streams all together",
    "Add performance considerations for nested conditionals",
    "Include example showing how to access nested fields in captured JSON (${var.field.subfield})",
    "Add note about execution order: when clause evaluates first, then on_success/on_failure after command completes",
    "Clarify relationship between timeout at command level vs workflow/phase levels"
  ],
  "metadata": {
    "analyzed_at": "2025-11-09T23:43:00Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Conditional execution",
      "Expression syntax",
      "Output capture formats",
      "Stream capture control",
      "Nested conditionals",
      "Timeouts"
    ],
    "validation_focus": "Check advanced features match implementation in WorkflowStepCommand",
    "critical_findings": [
      "on_exit_code documented but not implemented in user-facing config layer"
    ]
  }
}
