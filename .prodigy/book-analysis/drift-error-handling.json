{
  "item_type": "chapter",
  "chapter_id": "error-handling",
  "chapter_title": "Error Handling",
  "chapter_file": "book/src/error-handling.md",
  "drift_detected": true,
  "severity": "low",
  "quality_assessment": "Chapter is comprehensive and accurate with excellent structure and examples. The documentation effectively guides users through error handling from simple to complex patterns. Minor drift exists: actual implementation uses 'timeout_per_agent' in error messages (not 'agent_timeout_secs'), and network error suggestion says 'retry settings' (not 'retry configuration'). Documentation could be improved with notes about max_attempts/max_retries aliasing and capture field usage. Overall quality is very good.",
  "issues": [
    {
      "type": "outdated_information",
      "severity": "low",
      "section": "Error Metrics Pattern Detection (Line 336)",
      "description": "Documentation references 'agent_timeout_secs' but actual implementation suggests 'timeout_per_agent'",
      "current_content": "**Timeout errors** → \"Consider increasing agent_timeout_secs\"",
      "should_be": "**Timeout errors** → \"Consider increasing timeout_per_agent\"",
      "fix_suggestion": "Update line 336 to match the actual error message from src/cook/workflow/error_policy.rs:481 which uses 'timeout_per_agent'",
      "source_reference": "src/cook/workflow/error_policy.rs:481"
    },
    {
      "type": "outdated_information",
      "severity": "low",
      "section": "Error Metrics Pattern Detection (Line 337)",
      "description": "Documentation references 'retry configuration' but implementation says 'retry settings'",
      "current_content": "**Network errors** → \"Check network connectivity and retry configuration\"",
      "should_be": "**Network errors** → \"Check network connectivity and retry settings\"",
      "fix_suggestion": "Update line 337 to match the exact error message from implementation",
      "source_reference": "src/cook/workflow/error_policy.rs:483"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Advanced Configuration",
      "description": "Documentation doesn't mention that max_attempts is an alias for max_retries",
      "fix_suggestion": "Add note that max_attempts and max_retries are aliases and both are supported for backward compatibility. This is documented in the migration note on line 60 but could be mentioned in the Advanced Configuration section as well.",
      "source_reference": "src/cook/workflow/on_failure.rs:103"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Error Metrics Pattern Detection (Lines 332-345)",
      "description": "Pattern detection section correctly lists three error types with remediations, but could be clearer about which error types get specific suggestions",
      "current_content": "Lists Timeout, Network, and Permission errors with specific remediations. Generic remediation mentioned in Note.",
      "should_be": "Make it explicit that only these three types get specific suggestions, all others get generic 'Review error logs' suggestion",
      "fix_suggestion": "Add clarifying sentence: 'Prodigy automatically detects recurring error patterns when an error type occurs 3 or more times. The following error types receive specific remediation suggestions: [list]. Other error types receive a generic suggestion: \"Review error logs for more details.\"'",
      "source_reference": "src/cook/workflow/error_policy.rs:478-489 (suggest_action method)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Circuit Breaker Monitoring (Lines 239-250)",
      "description": "Section shows CLI commands (prodigy events ls, prodigy events follow) but notes they are stubs",
      "current_content": "Shows prodigy events ls --job-id <job_id> | grep -i circuit and prodigy events follow --job-id <job_id>",
      "fix_suggestion": "The documentation already includes a helpful note: 'Note: The events CLI commands are defined but currently have stub implementations. Event data is stored in ~/.prodigy/events/{repo_name}/{job_id}/ and can be inspected directly as JSONL files.' This is accurate and helpful.",
      "source_reference": "Lines 249-250 in error-handling.md"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Command-Level Error Handling - Detailed Handler Configuration (Lines 62-101)",
      "description": "Detailed handler configuration shows 'commands' array but doesn't clearly mention the simpler Advanced format alternative",
      "current_content": "Shows FailureHandlerConfig with commands array, strategy, timeout, capture, handler_failure_fatal",
      "should_add": "Note explaining when to use Detailed vs Advanced format",
      "fix_suggestion": "Add note after line 101: '> **Simpler Alternative:** For basic cases, you can use the Advanced format shown earlier instead of the detailed handler configuration. The Advanced format allows `shell` and `claude` fields directly without wrapping in a `commands` array: `on_failure: { shell: \"command\", fail_workflow: false, max_attempts: 3 }`.'",
      "source_reference": "src/cook/workflow/on_failure.rs:85-105 (Advanced variant)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Success Handling (Lines 103-137)",
      "description": "on_success section shows configuration but could better explain the capture field and its usage",
      "current_content": "Shows on_success configuration with simple and advanced forms, lists common use cases",
      "should_add": "Clearer explanation of how capture field works for passing data to subsequent steps",
      "fix_suggestion": "Add to the Common Use Cases section: 'The handler receives access to step outputs via the `capture` field, allowing you to process results or pass data to subsequent steps. For example, using `capture: \"metrics\"` creates a `${metrics}` variable containing the handler output, which can be used in later workflow steps for processing or decision-making.'",
      "source_reference": "src/cook/workflow/on_failure.rs:38-40 (capture field in FailureHandlerConfig)"
    }
  ],
  "positive_aspects": [
    "Excellent progression from simple to complex error handling patterns",
    "Clear examples for each configuration level (simple, advanced, detailed)",
    "Comprehensive coverage of MapReduce-specific error policies",
    "Well-documented circuit breaker states and transitions with clear state flow diagram",
    "Good explanation of backoff strategies with concrete calculation examples",
    "Helpful best practices section distinguishing command-level vs workflow-level error handling",
    "Clear comparison table showing when to use each error handling level",
    "Error metrics section accurately describes available fields and pattern detection logic",
    "DLQ workflow clearly explained with CLI commands and practical examples",
    "Success handling section shows both simple and advanced forms with real use cases",
    "Common patterns section provides comprehensive real-world examples combining multiple features",
    "All four backoff strategies (Fixed, Linear, Exponential, Fibonacci) accurately documented with formulas",
    "Documentation correctly shows on_failure max_attempts implies retry behavior",
    "Good coverage of failure patterns and automated remediation suggestions"
  ],
  "improvement_suggestions": [
    "Fix terminology: Change 'timeout_per_agent' to 'agent_timeout_secs' on line 332",
    "Fix YAML syntax error: Update batched error collection example to show proper nested structure",
    "Add clarifying note about which error patterns get specific vs generic remediation suggestions",
    "Verify circuit breaker monitoring CLI commands exist, or update to show actual monitoring approach",
    "Add note comparing Detailed vs Advanced on_failure formats to help users choose",
    "Expand on_success section with clearer explanation of capture field usage",
    "Consider adding troubleshooting section for common error handling issues",
    "Add visual diagram showing complete error handling flow: failure → handler → retry → DLQ → circuit breaker",
    "Include more cross-references to MapReduce chapter for workflow-level error policy context",
    "Add example showing how to access error metrics programmatically via Prodigy API"
  ],
  "metadata": {
    "analyzed_at": "2025-01-11T03:42:44Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Command-level error handling (on_failure with simple, advanced, and detailed forms)",
      "Workflow-level error policy (MapReduce only)",
      "Circuit breaker configuration and state transitions",
      "Retry configuration with backoff strategies (Fixed, Linear, Exponential, Fibonacci)",
      "Dead Letter Queue (DLQ) with retry capability",
      "Error metrics and pattern detection",
      "Success handling (on_success)",
      "Commit requirements",
      "Error collection strategies",
      "Best practices and common patterns"
    ],
    "validation_focus": "Check error handling policies and configurations",
    "implementation_files_reviewed": [
      "src/cook/workflow/error_policy.rs",
      "src/cook/workflow/on_failure.rs",
      "src/cook/retry_v2.rs",
      "src/config/command.rs",
      "src/config/mapreduce.rs"
    ]
  }
}
