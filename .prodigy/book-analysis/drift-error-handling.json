{
  "item_type": "chapter",
  "chapter_id": "error-handling",
  "chapter_title": "Error Handling",
  "chapter_file": "book/src/error-handling.md",
  "drift_detected": true,
  "severity": "low",
  "quality_assessment": "Chapter is comprehensive and mostly accurate with excellent structure and examples. Minor issues found relate to terminology inconsistencies (timeout_per_agent vs agent_timeout_secs), a YAML syntax error in the batched error collection example, and some incomplete explanations. Overall, the documentation effectively guides users through error handling from simple to complex patterns.",
  "issues": [
    {
      "type": "inconsistent_terminology",
      "severity": "medium",
      "section": "Error Metrics Pattern Detection (Line 332)",
      "description": "Suggested remediation uses 'timeout_per_agent' but this field doesn't exist in MapReduceWorkflowConfig",
      "current_content": "**Timeout errors** → \"Consider increasing timeout_per_agent\"",
      "should_be": "**Timeout errors** → \"Consider increasing agent_timeout_secs\"",
      "fix_suggestion": "Update line 332 to use correct field name 'agent_timeout_secs' from MapPhaseYaml config. This matches the actual suggestion in error_policy.rs:481",
      "source_reference": "src/config/mapreduce.rs (MapPhaseYaml has agent_timeout_secs field, not timeout_per_agent)"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Best Practices - Combined Error Handling Strategies (Line 499)",
      "description": "Example shows 'batch_size: 10' directly under error_policy but ErrorCollectionStrategy::Batched expects nested structure",
      "current_content": "error_collection: batched\nbatch_size: 10",
      "should_be": "error_collection:\n  batched:\n    size: 10",
      "fix_suggestion": "Update YAML example to properly nest batch_size inside the batched variant structure as: error_collection: { batched: { size: 10 } }",
      "source_reference": "src/cook/workflow/error_policy.rs:42-44 (ErrorCollectionStrategy::Batched { size: usize })"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Error Metrics (Lines 304-338)",
      "description": "Pattern detection section correctly lists three error types with remediations, but could be clearer about which error types get specific suggestions",
      "current_content": "Lists Timeout, Network, and Permission errors with specific remediations. Generic remediation mentioned in Note.",
      "should_be": "Make it explicit that only these three types get specific suggestions, all others get generic 'Review error logs' suggestion",
      "fix_suggestion": "Add clarifying sentence: 'Prodigy automatically detects recurring error patterns when an error type occurs 3 or more times. The following error types receive specific remediation suggestions: [list]. Other error types receive a generic suggestion: \"Review error logs for more details.\"'",
      "source_reference": "src/cook/workflow/error_policy.rs:478-489 (suggest_action method)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Circuit Breaker Monitoring (Lines 233-245)",
      "description": "Section mentions monitoring circuit breaker state but doesn't verify if the suggested CLI commands actually exist",
      "current_content": "prodigy events list <job_id> | grep -i circuit\nprodigy events watch <job_id>",
      "should_verify": "Check if these CLI commands are actually implemented",
      "fix_suggestion": "Verify the actual CLI commands available for querying circuit breaker events. If they don't exist, update to show how users can actually monitor circuit state (e.g., through event logs or API)",
      "source_reference": "CLI command verification needed"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Command-Level Error Handling - Detailed Handler Configuration (Lines 62-101)",
      "description": "Detailed handler configuration shows 'commands' array but doesn't clearly mention the simpler Advanced format alternative",
      "current_content": "Shows FailureHandlerConfig with commands array, strategy, timeout, capture, handler_failure_fatal",
      "should_add": "Note explaining when to use Detailed vs Advanced format",
      "fix_suggestion": "Add note after line 101: '> **Simpler Alternative:** For basic cases, you can use the Advanced format shown earlier instead of the detailed handler configuration. The Advanced format allows `shell` and `claude` fields directly without wrapping in a `commands` array: `on_failure: { shell: \"command\", fail_workflow: false, max_attempts: 3 }`.'",
      "source_reference": "src/cook/workflow/on_failure.rs:85-105 (Advanced variant)"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Success Handling (Lines 103-137)",
      "description": "on_success section shows configuration but could better explain the capture field and its usage",
      "current_content": "Shows on_success configuration with simple and advanced forms, lists common use cases",
      "should_add": "Clearer explanation of how capture field works for passing data to subsequent steps",
      "fix_suggestion": "Add to the Common Use Cases section: 'The handler receives access to step outputs via the `capture` field, allowing you to process results or pass data to subsequent steps. For example, using `capture: \"metrics\"` creates a `${metrics}` variable containing the handler output, which can be used in later workflow steps for processing or decision-making.'",
      "source_reference": "src/cook/workflow/on_failure.rs:38-40 (capture field in FailureHandlerConfig)"
    }
  ],
  "positive_aspects": [
    "Excellent progression from simple to complex error handling patterns",
    "Clear examples for each configuration level (simple, advanced, detailed)",
    "Comprehensive coverage of MapReduce-specific error policies",
    "Well-documented circuit breaker states and transitions with clear state flow diagram",
    "Good explanation of backoff strategies with concrete calculation examples",
    "Helpful best practices section distinguishing command-level vs workflow-level error handling",
    "Clear comparison table showing when to use each error handling level",
    "Error metrics section accurately describes available fields and pattern detection logic",
    "DLQ workflow clearly explained with CLI commands and practical examples",
    "Success handling section shows both simple and advanced forms with real use cases",
    "Common patterns section provides comprehensive real-world examples combining multiple features",
    "All four backoff strategies (Fixed, Linear, Exponential, Fibonacci) accurately documented with formulas",
    "Documentation correctly shows on_failure max_attempts implies retry behavior",
    "Good coverage of failure patterns and automated remediation suggestions"
  ],
  "improvement_suggestions": [
    "Fix terminology: Change 'timeout_per_agent' to 'agent_timeout_secs' on line 332",
    "Fix YAML syntax error: Update batched error collection example to show proper nested structure",
    "Add clarifying note about which error patterns get specific vs generic remediation suggestions",
    "Verify circuit breaker monitoring CLI commands exist, or update to show actual monitoring approach",
    "Add note comparing Detailed vs Advanced on_failure formats to help users choose",
    "Expand on_success section with clearer explanation of capture field usage",
    "Consider adding troubleshooting section for common error handling issues",
    "Add visual diagram showing complete error handling flow: failure → handler → retry → DLQ → circuit breaker",
    "Include more cross-references to MapReduce chapter for workflow-level error policy context",
    "Add example showing how to access error metrics programmatically via Prodigy API"
  ],
  "metadata": {
    "analyzed_at": "2025-11-09T23:43:36Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Command-level error handling (on_failure with simple, advanced, and detailed forms)",
      "Workflow-level error policy (MapReduce only)",
      "Circuit breaker configuration and state transitions",
      "Retry configuration with backoff strategies (Fixed, Linear, Exponential, Fibonacci)",
      "Dead Letter Queue (DLQ) with retry capability",
      "Error metrics and pattern detection",
      "Success handling (on_success)",
      "Commit requirements",
      "Error collection strategies",
      "Best practices and common patterns"
    ],
    "validation_focus": "Check error handling policies and configurations",
    "implementation_files_reviewed": [
      "src/cook/workflow/error_policy.rs",
      "src/cook/workflow/on_failure.rs",
      "src/cook/retry_v2.rs",
      "src/config/command.rs",
      "src/config/mapreduce.rs"
    ]
  }
}
