{
  "item_type": "chapter",
  "chapter_id": "git-context-advanced",
  "chapter_title": "Advanced Git Context",
  "chapter_file": "book/src/git-context-advanced.md",
  "drift_detected": true,
  "severity": "critical",
  "quality_assessment": "Documentation describes features that are NOT implemented in the codebase. The chapter documents pattern filtering and format modifiers for git context variables, but the actual implementation does not support these features. This is misleading documentation that will cause user errors.",
  "issues": [
    {
      "type": "documented_but_not_implemented",
      "severity": "critical",
      "section": "Pattern Filtering",
      "description": "Documentation claims git context variables support pattern filtering with syntax like ${step.files_added:*.rs} but this is NOT implemented",
      "current_content": "Filter git context variables using glob patterns with the :pattern modifier syntax.\n\n```yaml\n# Only Rust files added in this step\n- shell: \"echo ${step.files_added:*.rs}\"\n```",
      "actual_implementation": "Git context variables are added to InterpolationContext as simple space-separated strings. No pattern filtering is applied. The GitChangeTracker.resolve_variable() method supports patterns, but it is NEVER called during workflow execution.",
      "fix_suggestion": "Either: (1) Remove all pattern filtering documentation until it's implemented, OR (2) Implement pattern filtering by calling git_tracker.resolve_variable() during interpolation instead of pre-formatting variables as strings",
      "source_reference": "src/cook/workflow/executor/context.rs:106-136 (variables added as simple strings), src/cook/workflow/git_context.rs:489-505 (resolve_variable exists but unused)"
    },
    {
      "type": "documented_but_not_implemented",
      "severity": "critical",
      "section": "Format Modifiers",
      "description": "Documentation claims git context variables support format modifiers like :json, :lines, :csv but this is NOT implemented",
      "current_content": "### JSON Format\n\nUse `:json` for JSON array output:\n\n```yaml\n- shell: \"echo ${step.files_added:json}\"\n# Output: [\"src/main.rs\",\"src/lib.rs\",\"tests/test.rs\"]\n```",
      "actual_implementation": "All git context variables are pre-formatted as space-separated strings when added to the context. The GitChangeTracker.format_file_list() method exists but is never used during variable resolution.",
      "fix_suggestion": "Either: (1) Remove all format modifier documentation, OR (2) Implement custom resolver in InterpolationEngine to support modifiers on git context variables",
      "source_reference": "src/cook/workflow/executor/context.rs:106-172 (all variables formatted as space-separated), src/cook/workflow/git_context.rs:477-486 (format_file_list exists but unused)"
    },
    {
      "type": "documented_but_not_implemented",
      "severity": "high",
      "section": "Modifier Precedence and Limitations",
      "description": "Documentation explains complex rules for combining patterns and formats that don't exist in implementation",
      "current_content": "**IMPORTANT**: Format modifiers and glob patterns are **mutually exclusive**. Each variable reference can use **either** a format keyword (json, lines, csv, comma) **OR** a glob pattern, but not both.",
      "actual_implementation": "Neither patterns NOR formats are supported in variable interpolation. This entire section documents non-existent functionality.",
      "fix_suggestion": "Remove this entire section until the feature is implemented",
      "source_reference": "src/cook/workflow/executor/context.rs:96-172"
    },
    {
      "type": "documented_but_not_implemented",
      "severity": "high",
      "section": "Workarounds for Combined Filtering and Formatting",
      "description": "Provides workarounds for a feature that doesn't exist",
      "current_content": "When you need both pattern filtering and custom formatting, use shell post-processing:\n\n```yaml\n# Get filtered files as JSON array using jq\n- shell: \"echo ${step.files_changed:*.rs} | xargs -n1 | jq -R | jq -s\"\n```",
      "actual_implementation": "The workaround is needed because patterns don't work at all, not because they can't be combined with formats. Users need to do ALL filtering in shell, not just combined filtering+formatting.",
      "fix_suggestion": "Rewrite to explain that ALL filtering must be done in shell commands, not just combined operations",
      "source_reference": "src/cook/workflow/executor/context.rs:96-172"
    },
    {
      "type": "missing_limitation_documentation",
      "severity": "high",
      "section": "Overview",
      "description": "Documentation doesn't explain that git context variables are pre-formatted and cannot be customized",
      "current_content": "Variables are automatically available for interpolation in all commands",
      "should_be": "Variables are available as space-separated strings only. Custom formatting requires shell post-processing.",
      "fix_suggestion": "Add prominent notice at the top explaining current limitations and that advanced features are planned but not yet implemented",
      "source_reference": "src/cook/workflow/executor/context.rs:106-172"
    },
    {
      "type": "incomplete_explanation",
      "severity": "medium",
      "section": "How Git Tracking Works",
      "description": "Doesn't explain that git context is added to the InterpolationContext as pre-formatted strings",
      "current_content": "Variables are automatically available for interpolation in all commands",
      "should_be": "Git context variables are pre-formatted as space-separated strings and added to the interpolation context before each step execution. Custom formatting is not currently supported.",
      "fix_suggestion": "Add technical details about how variables are actually populated and why modifiers aren't supported",
      "source_reference": "src/cook/workflow/executor/context.rs:96-172"
    },
    {
      "type": "incorrect_examples",
      "severity": "critical",
      "section": "Use Cases - Code Review Workflows, Documentation Updates, Test Verification, Conditional Execution",
      "description": "All examples showing pattern filtering will NOT work as documented",
      "current_content": "```yaml\n- claude: \"/review-changes\"\n  args:\n    files: \"${step.files_changed:src/**/*.rs}\"\n```",
      "should_be": "```yaml\n# Pattern filtering not supported - use shell instead\n- shell: |\n    files=$(echo \"${step.files_changed}\" | tr ' ' '\\n' | grep 'src/.*\\.rs$')\n    echo \"$files\"\n```",
      "fix_suggestion": "Rewrite all use case examples to use shell post-processing for filtering instead of non-existent :pattern syntax",
      "source_reference": "src/cook/workflow/executor/context.rs:96-172"
    },
    {
      "type": "misleading_troubleshooting",
      "severity": "medium",
      "section": "Troubleshooting - Combined Pattern and Format Not Working",
      "description": "Troubleshooting suggests the issue is combining features, when actually neither feature works",
      "current_content": "**Issue**: Trying to combine pattern and format syntax like `${var:*.rs:json}` produces no output or unexpected results\n\n**Cause**: The implementation only supports a single modifier",
      "should_be": "**Issue**: Pattern and format modifiers don't work at all\n\n**Cause**: These features are documented but not yet implemented. Git context variables are pre-formatted as space-separated strings.",
      "fix_suggestion": "Rewrite troubleshooting to explain the actual limitation",
      "source_reference": "src/cook/workflow/executor/context.rs:96-172"
    }
  ],
  "positive_aspects": [
    "Accurate documentation of GitChangeTracker API and methods (even though they're not used in workflows)",
    "Clear explanation of automatic git tracking initialization and lifecycle",
    "Good documentation of available variables (step.*, workflow.*)",
    "Accurate variable reference table showing all supported variables",
    "Well-organized structure with clear sections",
    "Good explanation of when git tracking is active vs inactive",
    "Comprehensive use case examples (though they need correction)"
  ],
  "improvement_suggestions": [
    "Add a prominent \"Current Limitations\" section at the top explaining that pattern filtering and format modifiers are planned but not yet implemented",
    "Update all examples to show only what actually works (space-separated format only)",
    "Add shell post-processing examples as the recommended approach for filtering and formatting",
    "Remove or mark as \"Future\" the sections on pattern filtering, format modifiers, and modifier precedence",
    "Add a roadmap section explaining when advanced features will be implemented",
    "Include actual working examples showing shell-based filtering and formatting",
    "Clarify the difference between GitChangeTracker's internal capabilities and what's exposed to workflows",
    "Add source code references to help users understand implementation details"
  ],
  "metadata": {
    "analyzed_at": "2025-01-09T23:43:36Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Pattern filtering",
      "Format modifiers",
      "File patterns",
      "Combined filters",
      "Git context variables"
    ],
    "validation_focus": "Check that pattern filtering syntax, format modifiers, and file pattern options are documented",
    "critical_findings": [
      "Pattern filtering documented but NOT implemented",
      "Format modifiers documented but NOT implemented",
      "GitChangeTracker.resolve_variable() exists but is never called",
      "Variables pre-formatted as strings, no runtime customization possible"
    ]
  }
}
