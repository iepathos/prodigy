{
  "chapter_id": "environment",
  "chapter_title": "Environment Configuration",
  "chapter_file": "book/src/environment.md",
  "drift_detected": true,
  "severity": "high",
  "quality_assessment": "Chapter has been significantly improved but still contains critical drift. Major issue: documents step-level `env` and `working_dir` fields that don't exist in WorkflowStepCommand. The chapter correctly documents WorkflowConfig but incorrectly extends these features to step level.",
  "issues": [
    {
      "type": "missing_content",
      "severity": "critical",
      "section": "Step-Level Environment (lines 456-503)",
      "description": "Chapter documents step-level `env` and `working_dir` fields, but WorkflowStepCommand does NOT have these fields. The struct only has claude, shell, analyze, test, goal_seek, foreach, id, commit_required, analysis, outputs, capture_output, on_failure, on_success, validate, timeout, when, capture_format, capture_streams, and output_file.",
      "current_content": "commands:\n  - shell: \"echo $API_URL\"\n    env:\n      API_URL: \"https://api.staging.com\"\n      DEBUG: \"true\"\n  - shell: \"pwd && ls -la\"\n    working_dir: \"/tmp/sandbox\"",
      "should_be": "Step-level environment configuration is NOT available in WorkflowStepCommand. Environment variables must be set at workflow level via WorkflowConfig.env or passed via shell environment.",
      "fix_suggestion": "Remove entire Step-Level Environment section (lines 456-503) OR clarify that this is a planned feature not yet implemented. The StepEnvironment struct exists internally but is not exposed in WorkflowStepCommand YAML syntax.",
      "source_reference": "src/config/command.rs:280-356 WorkflowStepCommand (no env or working_dir fields), src/cook/environment/config.rs:127-144 StepEnvironment (internal only)"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Step-Level Environment - Variable Interpolation (lines 492-503)",
      "description": "Example shows step.env with variable interpolation, but step-level env doesn't exist",
      "current_content": "commands:\n  - shell: \"echo 'Version: $APP_VERSION'\"\n    env:\n      APP_VERSION: \"${VERSION}\"\n      BUILD_TAG: \"build-${BUILD_NUMBER}\"",
      "should_be": "Feature does not exist in current implementation",
      "fix_suggestion": "Remove this example as step-level environment is not implemented",
      "source_reference": "src/config/command.rs:280-356 WorkflowStepCommand"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Step Environment for Overrides (lines 591-607)",
      "description": "Best practice example shows step-level env override which doesn't exist",
      "current_content": "commands:\n  - shell: \"cargo run\"\n  - shell: \"cargo run --verbose\"\n    env:\n      RUST_LOG: debug",
      "should_be": "Use shell syntax for environment overrides: RUST_LOG=debug cargo run --verbose",
      "fix_suggestion": "Update example to use shell environment syntax since step-level env is not available",
      "source_reference": "src/config/command.rs:280-356"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Temporary Environment Changes (lines 673-685)",
      "description": "Example shows working_dir field which doesn't exist in WorkflowStepCommand",
      "current_content": "- shell: \"./node_modules/.bin/webpack\"\n  working_dir: \"frontend\"\n  env:\n    PATH: \"${PWD}/node_modules/.bin:${PATH}\"",
      "should_be": "Use shell cd command or run commands from correct directory",
      "fix_suggestion": "Replace with shell-based approach: shell: \"cd frontend && PATH=./node_modules/.bin:$PATH ./node_modules/.bin/webpack\"",
      "source_reference": "src/config/command.rs:280-356"
    },
    {
      "type": "outdated_information",
      "severity": "medium",
      "section": "Available Step-Level Fields (lines 480-490)",
      "description": "Chapter lists env and working_dir as available fields but they don't exist",
      "current_content": "**Available Step-Level Fields:**\n- `env` - Step-specific environment variables\n- `working_dir` - Working directory for command execution",
      "should_be": "WorkflowStepCommand does not support step-level env or working_dir fields. Use global env in WorkflowConfig or shell syntax for per-command environment.",
      "fix_suggestion": "Remove this section or clarify these are internal-only fields not exposed in YAML",
      "source_reference": "src/config/command.rs:280-356"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Environment Precedence Example (lines 516-537)",
      "description": "Example shows step env overriding global env, but step env doesn't exist",
      "current_content": "commands:\n  - shell: \"echo $NODE_ENV\"  # Prints: production\n  - shell: \"echo $NODE_ENV\"  # Prints: staging\n    env:\n      NODE_ENV: staging",
      "should_be": "Without step-level env, NODE_ENV would be the same for all commands (from global env or profile)",
      "fix_suggestion": "Update example to only show precedence of global env, profiles, and env_files - remove step-level from precedence list",
      "source_reference": "src/config/command.rs:280-356"
    },
    {
      "type": "outdated_information",
      "severity": "medium",
      "section": "Environment Precedence List (lines 506-514)",
      "description": "Lists 'Step-level env' as highest precedence but this field doesn't exist",
      "current_content": "1. **Step-level `env`** - Defined on individual commands\n2. **Active profile** - If a profile is activated\n3. **Global `env`** - Defined at workflow level\n4. **Environment files** - Loaded from `env_files`\n5. **Parent environment** - Inherited from parent",
      "should_be": "1. **Active profile** (internal)\n2. **Global `env`** - Defined at workflow level\n3. **Environment files** - Loaded from `env_files`\n4. **Parent environment** - Always inherited",
      "fix_suggestion": "Remove step-level env from precedence list. Note that active_profile is internal and not exposed in YAML.",
      "source_reference": "src/config/workflow.rs:12-35, src/cook/environment/config.rs:12-36"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Architecture Overview (lines 5-12)",
      "description": "Chapter mentions two-layer architecture but doesn't fully explain that step-level features are internal only",
      "current_content": "1. **WorkflowConfig**: User-facing YAML configuration\n2. **EnvironmentConfig**: Internal runtime configuration",
      "should_add": "Clarify that StepEnvironment (with env/working_dir/clear_env/temporary) exists in EnvironmentConfig but is NOT exposed in WorkflowStepCommand YAML syntax",
      "fix_suggestion": "Expand architecture note to explain which features are user-facing (WorkflowConfig/WorkflowStepCommand) vs internal (EnvironmentConfig/StepEnvironment)",
      "source_reference": "src/config/workflow.rs vs src/cook/environment/config.rs"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Custom Secret Provider Syntax",
      "description": "Chapter doesn't show clear example of Custom provider YAML syntax",
      "current_content": "CUSTOM_SECRET:\n  provider:\n    custom: \"my-custom-provider\"\n  key: \"secret-id\"",
      "should_add": "Clarify if this is the correct syntax for Custom(String) variant. SecretProvider uses #[serde(rename_all = \"lowercase\")] so it might be just 'provider: custom' not nested",
      "fix_suggestion": "Test and document correct YAML syntax for Custom provider. May need to check deserialization behavior.",
      "source_reference": "src/cook/environment/config.rs:99-112 SecretProvider::Custom(String)"
    }
  ],
  "positive_aspects": [
    "Correctly documents WorkflowConfig.env as HashMap<String, String> (static strings only)",
    "Correctly shows that parent environment is always inherited (no inherit field needed)",
    "Good coverage of MapReduce environment variable usage across all phases",
    "Excellent examples of variable interpolation with ${VAR} syntax",
    "Correctly documents secrets with Provider structure",
    "Correctly shows EnvProfile with flattened structure (no nested env:)",
    "Good best practices section for environment variable naming and documentation",
    "Comprehensive coverage of .env file format and loading",
    "Clear explanation of secrets masking in logs"
  ],
  "improvement_suggestions": [
    "CRITICAL: Remove or mark as 'planned feature' all step-level env and working_dir documentation",
    "Show shell-based alternatives for per-command environment (e.g., 'ENV_VAR=value command')",
    "Clarify which environment features are WorkflowConfig YAML vs internal EnvironmentConfig",
    "Add note about StepEnvironment existing internally but not exposed in YAML",
    "Test and document correct Custom secret provider YAML syntax",
    "Add troubleshooting for environment variable expansion issues",
    "Show how to debug environment issues (what env is actually set?)",
    "Add examples of profile activation if that feature exists",
    "Document environment variable escaping and special characters"
  ],
  "metadata": {
    "analyzed_at": "2025-10-05",
    "feature_inventory": "Analyzed from source code (WorkflowConfig, WorkflowStepCommand, EnvironmentConfig, SecretValue, EnvProfile)",
    "topics_covered": [
      "Global environment (correctly documented)",
      "MapReduce environment variables (correctly documented)",
      "Secrets management (correctly documented)",
      "Environment files (correctly documented)",
      "Environment profiles (correctly documented)",
      "Step-level environment (INCORRECTLY documented - feature doesn't exist)",
      "Environment precedence (partially incorrect due to step-level)"
    ],
    "validation_focus": "Check environment configuration options and syntax",
    "codebase_sources": [
      "src/config/workflow.rs:12-35 WorkflowConfig",
      "src/config/command.rs:280-356 WorkflowStepCommand",
      "src/cook/environment/config.rs:12-36 EnvironmentConfig",
      "src/cook/environment/config.rs:84-96 SecretValue",
      "src/cook/environment/config.rs:99-112 SecretProvider",
      "src/cook/environment/config.rs:114-124 EnvProfile",
      "src/cook/environment/config.rs:127-144 StepEnvironment (internal only)"
    ]
  }
}
