{
  "chapter_id": "environment",
  "chapter_title": "Environment Configuration",
  "chapter_file": "book/src/environment.md",
  "drift_detected": true,
  "severity": "high",
  "quality_assessment": "Chapter contains significant drift from implementation. Critical issues: (1) documents --profile CLI flag that doesn't exist, (2) shows incorrect secret provider syntax, (3) correctly notes WorkflowStepCommand lacks env field but presentation could be clearer. The MapReduce environment section is accurate and comprehensive.",
  "issues": [
    {
      "type": "incorrect_example",
      "severity": "critical",
      "section": "Profile Support in MapReduce (line 228-231)",
      "description": "Chapter shows 'prodigy run workflow.yml --profile production' command, but --profile CLI flag does not exist in the implementation",
      "current_content": "Activate a profile:\n```bash\nprodigy run workflow.yml --profile production\n```",
      "should_be": "Profile activation is not currently exposed in the CLI. The profiles field can be defined in YAML but there is no mechanism to activate them.",
      "fix_suggestion": "Remove the CLI example or add a note that this is a planned feature. The infrastructure exists (active_profile in EnvironmentConfig) but no CLI flag to set it.",
      "source_reference": "Grep search for '--profile' in src/cli found no matches; src/cook/environment/config.rs:34 has active_profile field but no way to set it"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Secrets Management - Custom Provider (lines 388-392)",
      "description": "Custom secret provider syntax is incorrect - shows nested object but implementation expects string value",
      "current_content": "CUSTOM_SECRET:\n  provider:\n    custom: \"my-custom-provider\"\n  key: \"secret-id\"",
      "should_be": "CUSTOM_SECRET:\n  provider: \"my-custom-provider\"\n  key: \"secret-id\"",
      "fix_suggestion": "Fix custom provider syntax to use string value directly. The SecretProvider::Custom(String) variant expects a string, not a nested object.",
      "source_reference": "src/cook/environment/config.rs:111 - Custom(String) variant; #[serde(rename_all = \"lowercase\")] at line 100"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Environment Profiles (line 453)",
      "description": "Chapter mentions 'profile activation is managed internally' which is true, but then shows CLI example that doesn't work",
      "current_content": "**Note:** Profile activation is managed internally by the runtime environment manager. The selection mechanism is not currently exposed in WorkflowConfig YAML.",
      "should_be": "Profile activation is not currently implemented. You can define profiles in YAML but cannot activate them via CLI or YAML configuration.",
      "fix_suggestion": "Be more direct that profiles can be defined but not activated. Remove contradictory CLI example earlier in the chapter.",
      "source_reference": "src/cook/environment/config.rs:35 - active_profile field exists but no mechanism to set it"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Secrets with Fallbacks (lines 624-636)",
      "description": "Example shows shell-style variable substitution ${API_KEY:-default-key} which is not supported in workflow env field",
      "current_content": "env:\n  # Fallback for local development\n  API_KEY: \"${API_KEY:-default-key}\"",
      "should_be": "Workflow env field only supports static string values. Variable substitution like ${VAR:-default} is not supported.",
      "fix_suggestion": "Remove this example or replace with a valid approach. WorkflowConfig.env is HashMap<String, String> - no substitution logic.",
      "source_reference": "src/config/workflow.rs:18 - pub env: Option<HashMap<String, String>> - simple strings only"
    },
    {
      "type": "outdated_information",
      "severity": "medium",
      "section": "Per-Command Environment Overrides (lines 456-485)",
      "description": "Section correctly states WorkflowStepCommand lacks env field, but could be more prominent and clearer",
      "current_content": "While WorkflowStepCommand does not support a dedicated `env` field, you can override environment variables...",
      "should_be": "WorkflowStepCommand does NOT have an `env` field. All per-command environment changes must use shell syntax (e.g., ENV_VAR=value command).",
      "fix_suggestion": "Make this limitation more prominent - perhaps a warning box or heading. Current presentation buries it in explanatory text.",
      "source_reference": "src/config/command.rs:321-401 - WorkflowStepCommand has no env field"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Architecture Overview",
      "description": "Chapter mentions StepEnvironment exists internally but doesn't explain the full scope of what's internal vs user-facing",
      "should_add": "EnvironmentConfig (internal runtime) supports EnvValue enum with Dynamic (command output) and Conditional (expression-based) values, but WorkflowConfig (user YAML) only supports static strings.",
      "fix_suggestion": "Add to Architecture Overview section explaining that EnvironmentConfig has richer capabilities (Dynamic, Conditional env values) not exposed in workflow YAML.",
      "source_reference": "src/cook/environment/config.rs:38-81 - EnvValue enum with Static, Dynamic, Conditional variants"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Environment Precedence (lines 487-520)",
      "description": "Precedence order is accurate but doesn't clarify this is runtime behavior, not YAML configuration",
      "current_content": "1. Active profile\n2. Global env\n3. Environment files\n4. Parent environment",
      "should_clarify": "This precedence order applies to internal EnvironmentConfig runtime resolution. In workflow YAML, only global env and env_files are configurable.",
      "fix_suggestion": "Add note that profile activation is internal-only, and step-level env shown is also internal (not in WorkflowStepCommand YAML).",
      "source_reference": "src/cook/environment/config.rs vs src/config/workflow.rs - different layers"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Environment Files",
      "description": "Chapter doesn't explicitly state env_files are processed in order with later overriding earlier",
      "should_add": "Explicitly document that env_files are loaded in order, with later files overriding earlier files. This allows layered configuration (e.g., .env, .env.local, .env.production).",
      "fix_suggestion": "Add explicit example showing override behavior when multiple env files define the same variable.",
      "source_reference": "src/cook/environment/config.rs:23 - env_files: Vec<PathBuf>"
    },
    {
      "type": "unclear_content",
      "severity": "low",
      "section": "MapReduce Environment Variables (lines 40-316)",
      "description": "Very long section covering many topics - could be better organized for readability",
      "current_content": "Single large section mixing basic usage, interpolation syntax, phase-specific examples, secrets, profiles, reusability, and best practices",
      "should_be": "Split into focused subsections with clear headings. Move secrets and profiles to their own top-level sections with MapReduce-specific notes.",
      "fix_suggestion": "Reorganize to: (1) Basic env in MapReduce, (2) Variable interpolation, (3) Brief phase examples, (4) Link to Secrets/Profiles sections. Reduces repetition and improves scanability.",
      "source_reference": "N/A - organizational issue"
    }
  ],
  "positive_aspects": [
    "Excellent architecture overview clearly separating WorkflowConfig (user-facing) from EnvironmentConfig (runtime)",
    "Correctly documents that WorkflowConfig.env only supports static string values (HashMap<String, String>)",
    "Comprehensive examples showing environment variables in all MapReduce phases (setup, map, reduce, merge)",
    "Accurate documentation that parent environment is always inherited by default",
    "Good coverage of .env file format with example showing KEY=value syntax",
    "Clear best practices section with naming conventions (UPPER_CASE) and documentation examples",
    "Correct EnvProfile structure documentation showing flattened env vars (not nested under 'env:' key)",
    "Good explanation of secrets masking in logs and output",
    "Helpful examples of reusable workflows parameterized with environment variables",
    "Accurate note (line 14) that StepEnvironment is internal and not exposed in WorkflowStepCommand YAML"
  ],
  "improvement_suggestions": [
    "CRITICAL: Remove CLI example 'prodigy run workflow.yml --profile production' - this flag doesn't exist",
    "Fix custom secret provider syntax from nested object to simple string value",
    "Make WorkflowStepCommand env limitation more prominent - perhaps a warning box",
    "Remove shell substitution example ${VAR:-default} from workflow env field documentation",
    "Clarify that profile activation is not implemented (not just 'managed internally')",
    "Add note about EnvValue enum (Dynamic, Conditional) existing internally but not exposed in YAML",
    "Reorganize MapReduce environment section for better flow and less repetition",
    "Add explicit example of env_files override behavior (later files override earlier)",
    "Clarify which precedence rules apply to YAML config vs internal runtime",
    "Consider adding troubleshooting section for environment variable issues"
  ],
  "metadata": {
    "analyzed_at": "2025-01-10",
    "feature_inventory": "Analyzed directly from codebase (features.json not yet created in this worktree)",
    "topics_covered": [
      "Global environment",
      "MapReduce environment variables",
      "Secrets management",
      "Profiles",
      "Environment files",
      "Variable interpolation",
      "Per-command environment overrides"
    ],
    "validation_focus": "Check environment configuration options and syntax",
    "codebase_sources": [
      "src/config/workflow.rs:18-30 - WorkflowConfig env, secrets, env_files, profiles fields",
      "src/config/mapreduce.rs:26-38 - MapReduceWorkflowConfig env fields",
      "src/config/command.rs:321-401 - WorkflowStepCommand (no env field)",
      "src/cook/environment/config.rs:12-36 - EnvironmentConfig",
      "src/cook/environment/config.rs:38-81 - EnvValue enum",
      "src/cook/environment/config.rs:84-96 - SecretValue",
      "src/cook/environment/config.rs:99-112 - SecretProvider",
      "src/cook/environment/config.rs:115-124 - EnvProfile",
      "src/cook/environment/config.rs:127-144 - StepEnvironment (internal only)"
    ]
  }
}
