{
  "item_type": "subsection",
  "chapter_id": "mapreduce",
  "subsection_id": "dead-letter-queue-dlq",
  "subsection_title": "Dead Letter Queue (DLQ)",
  "subsection_file": "book/src/mapreduce/dead-letter-queue-dlq.md",
  "feature_mappings": [
    "mapreduce.dlq",
    "error_handling.dlq"
  ],
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "The subsection provides comprehensive coverage of DLQ functionality with accurate examples and detailed command documentation. Minor discrepancies exist between documented field types and actual implementation, and CLI command stubs need implementation. Overall structure and concepts are solid, with good cross-referencing and practical examples.",
  "issues": [
    {
      "type": "incorrect_information",
      "severity": "medium",
      "section": "DLQ Item Structure",
      "description": "Documentation shows step_failed as integer (line 45), but implementation uses String type",
      "current_content": "\"step_failed\": 2",
      "should_be": "\"step_failed\": \"shell: cargo test\"",
      "fix_suggestion": "Update example to show step_failed as a String describing the command that failed, not a numeric step index",
      "source_reference": "src/cook/execution/dlq.rs:54"
    },
    {
      "type": "incorrect_information",
      "severity": "medium",
      "section": "Failure Detail Fields",
      "description": "Documentation shows step_failed as numeric (line 90), inconsistent with actual String type",
      "current_content": "\"step_failed\": 2",
      "should_be": "\"step_failed\": \"claude: /process '${item}'\"",
      "fix_suggestion": "Update FailureDetail example to use String value for step_failed field matching implementation",
      "source_reference": "src/cook/execution/dlq.rs:54"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "DLQ Item Structure",
      "description": "Documentation missing first_attempt and last_attempt timestamp fields that exist in implementation",
      "fix_suggestion": "Add first_attempt and last_attempt DateTime<Utc> fields to DeadLetteredItem structure documentation",
      "source_reference": "src/cook/execution/dlq.rs:35-36"
    },
    {
      "type": "incorrect_information",
      "severity": "low",
      "section": "DLQ Item Structure",
      "description": "Documentation uses retry_count field (line 52), but implementation uses failure_count",
      "current_content": "\"retry_count\": 3",
      "should_be": "\"failure_count\": 3",
      "fix_suggestion": "Update field name to failure_count to match implementation, or add both fields if retry_count is derived",
      "source_reference": "src/cook/execution/dlq.rs:37"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "DLQ Item Structure",
      "description": "Documentation missing error_signature field that exists in implementation",
      "fix_suggestion": "Add error_signature: String field to DeadLetteredItem example - used for grouping similar failures in pattern analysis",
      "source_reference": "src/cook/execution/dlq.rs:39"
    },
    {
      "type": "incorrect_information",
      "severity": "low",
      "section": "Worktree Artifacts",
      "description": "uncommitted_changes field documented as array (line 59), but implementation uses Option<String>",
      "current_content": "\"uncommitted_changes\": [\"src/main.rs\"]",
      "should_be": "\"uncommitted_changes\": \"src/main.rs modified\"",
      "fix_suggestion": "Update uncommitted_changes type to Option<String> or clarify the actual serialization format",
      "source_reference": "src/cook/execution/dlq.rs:78"
    },
    {
      "type": "incorrect_information",
      "severity": "low",
      "section": "Worktree Artifacts",
      "description": "error_logs field documented as array (line 60), but implementation uses Option<String>",
      "current_content": "\"error_logs\": [\"error.log\"]",
      "should_be": "\"error_logs\": \"error.log contents...\"",
      "fix_suggestion": "Update error_logs type to Option<String> to match implementation",
      "source_reference": "src/cook/execution/dlq.rs:79"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Error Types",
      "description": "CommandFailed error type documented without exit_code field that exists in implementation",
      "current_content": "- `CommandFailed`: Shell or Claude command returned non-zero exit code",
      "should_be": "- `CommandFailed { exit_code: i32 }`: Shell or Claude command returned non-zero exit code",
      "fix_suggestion": "Update ErrorType::CommandFailed documentation to show it contains exit_code field for diagnostic purposes",
      "source_reference": "src/cook/execution/dlq.rs:65"
    },
    {
      "type": "incomplete_implementation",
      "severity": "high",
      "section": "DLQ Commands",
      "description": "All DLQ CLI commands are stubs that only print messages - no actual implementation yet",
      "fix_suggestion": "Add implementation status note in documentation that DLQ CLI commands are planned but currently stubs, or implement the commands to match documented behavior",
      "source_reference": "src/cli/commands/dlq.rs:9-73"
    },
    {
      "type": "incorrect_information",
      "severity": "low",
      "section": "Retry Command",
      "description": "Documentation shows --max-parallel flag but CLI implementation uses --parallel",
      "current_content": "prodigy dlq retry mapreduce-1234567890 --max-parallel 10",
      "should_be": "prodigy dlq retry mapreduce-1234567890 --parallel 10",
      "fix_suggestion": "Update command examples to use --parallel flag to match CLI implementation (default: 10)",
      "source_reference": "src/cli/args.rs:653"
    },
    {
      "type": "incorrect_information",
      "severity": "medium",
      "section": "Retry Command",
      "description": "Documentation shows job_id as positional argument, but CLI expects workflow_id",
      "current_content": "prodigy dlq retry mapreduce-1234567890",
      "should_be": "prodigy dlq retry <workflow_id>",
      "fix_suggestion": "Clarify relationship between workflow_id and job_id in retry command documentation, or update CLI parameter naming for consistency",
      "source_reference": "src/cli/args.rs:642"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Retry Command",
      "description": "Documentation shows max_parallel default as 5, but CLI default is 10",
      "current_content": "default: 5, uses workflow's max_parallel",
      "should_be": "default: 10",
      "fix_suggestion": "Update default parallelism value to 10 to match CLI implementation",
      "source_reference": "src/cli/args.rs:653"
    }
  ],
  "positive_aspects": [
    "Comprehensive coverage of DLQ concepts and workflow integration",
    "Clear explanation of DLQ storage structure and global architecture benefits",
    "Detailed documentation of DeadLetteredItem and FailureDetail structures with JSON examples",
    "Complete documentation of all CLI commands with usage examples and options",
    "Excellent cross-referencing to related subsections (checkpoints, events, error handling, Claude logs)",
    "Strong coverage of debugging workflow with Claude JSON logs integration",
    "Well-structured best practices section distinguishing automatic retry vs manual fix scenarios",
    "Clear explanation of failure flow diagram and integration with MapReduce on_item_failure policy",
    "Good performance considerations section covering large DLQs, parallelism tuning, and filtering",
    "Comprehensive command reference with all options documented (list, inspect, analyze, export, purge, retry, stats, clear)"
  ],
  "improvement_suggestions": [
    "Correct field types in examples to match implementation (step_failed: String, failure_count, uncommitted_changes: Option<String>, error_logs: Option<String>)",
    "Add missing fields to documentation (first_attempt, last_attempt, error_signature)",
    "Update ErrorType::CommandFailed to show { exit_code: i32 } structure",
    "Clarify workflow_id vs job_id terminology consistently throughout retry command documentation",
    "Add implementation status note for CLI commands (currently stubs awaiting implementation)",
    "Update --max-parallel flag to --parallel in all examples",
    "Correct default parallelism value from 5 to 10",
    "Consider adding note about actual DLQ storage internals: items stored as individual JSON files in ~/.prodigy/state/{repo}/mapreduce/dlq/{job_id}/items/ directory",
    "Add example showing DLQ index.json structure for advanced debugging",
    "Consider documenting DLQStorage internal structure for users who need direct file access"
  ],
  "cross_references": [
    "checkpoint-and-resume",
    "event-tracking",
    "error-handling",
    "worktree-architecture",
    "claude-command-observability"
  ],
  "metadata": {
    "analyzed_at": "2025-01-11T00:00:00Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "failed items",
      "retry",
      "DLQ",
      "error handling",
      "failure analysis",
      "worktree artifacts"
    ],
    "validation_focus": "Check DLQ structure and retry commands documented"
  }
}
