{
  "item_type": "chapter",
  "chapter_id": "commands",
  "chapter_title": "Command Types",
  "chapter_file": "book/src/commands.md",
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Chapter is mostly accurate with good examples but has field availability confusion between WorkflowStepCommand (user-facing YAML) and WorkflowStep (internal representation). Some documented fields (cwd, env, on_exit_code) appear in WorkflowStep but not in WorkflowStepCommand struct.",
  "issues": [
    {
      "type": "incorrect_information",
      "severity": "high",
      "section": "Working Directory (cwd) Examples",
      "description": "Documentation shows 'cwd' field in WorkflowStepCommand examples, but WorkflowStepCommand struct (src/config/command.rs:320-401) does not have a 'cwd' field. Only the internal WorkflowStep (data_structures.rs:99) has 'working_dir' field.",
      "current_content": "- shell: \"cargo test\"\n  cwd: \"crates/prodigy-core\"",
      "should_be": "Verify if cwd is actually available in YAML or if it's only available in the internal WorkflowStep format. If available, it may need to be named 'working_dir' not 'cwd'.",
      "fix_suggestion": "Check actual YAML parsing to confirm field name. If 'cwd' is supported, update WorkflowStepCommand struct. If not, update documentation to remove cwd examples or clarify they're for advanced WorkflowStep usage only.",
      "source_reference": "src/config/command.rs:320-401 (no cwd field), src/cook/workflow/executor/data_structures.rs:99 (working_dir field)"
    },
    {
      "type": "incorrect_information",
      "severity": "high",
      "section": "Step-Level Environment Variables (env) Examples",
      "description": "Documentation shows 'env' field in WorkflowStepCommand examples, but WorkflowStepCommand struct does not have an 'env' field. Only WorkflowStep (data_structures.rs:103) has env field.",
      "current_content": "- shell: \"rustfmt --check src/**/*.rs\"\n  env:\n    PATH: \"/custom/bin:${PATH}\"",
      "should_be": "Either add env field to WorkflowStepCommand or clarify this is only available in WorkflowStep format",
      "fix_suggestion": "Verify if env is actually supported in YAML WorkflowStepCommand. The field exists in CommandMetadata.env (line 145) but WorkflowStepCommand doesn't expose it. Add env field to WorkflowStepCommand if it should be user-facing.",
      "source_reference": "src/config/command.rs:320-401 (no env field), src/cook/workflow/executor/data_structures.rs:103 (env field)"
    },
    {
      "type": "incorrect_information",
      "severity": "high",
      "section": "Exit Code Handlers (on_exit_code) Examples",
      "description": "Documentation shows 'on_exit_code' field but WorkflowStepCommand struct does not have this field. Only WorkflowStep (data_structures.rs:119) and normalized workflows (normalized.rs:69) have it.",
      "current_content": "- shell: \"cargo build\"\n  on_exit_code:\n    1:\n      claude: \"/fix-compile-errors ${shell.output}\"",
      "should_be": "Clarify whether on_exit_code is available in YAML or if it's planned/internal-only",
      "fix_suggestion": "Add on_exit_code field to WorkflowStepCommand if it should be supported in YAML. Otherwise, move examples to a 'Planned Features' or 'Advanced Usage' section with clear indication it's not yet available.",
      "source_reference": "src/config/command.rs:320-401 (no on_exit_code), src/cook/workflow/executor/data_structures.rs:119 (has on_exit_code)"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Command Reference > Command Fields",
      "description": "Missing 'capture' field which is the preferred alternative to deprecated 'capture_output'",
      "feature_reference": "command_types.shell.fields",
      "fix_suggestion": "Add 'capture' field to the Command Fields table showing it as the preferred method: 'capture | string | Variable name to capture command output (preferred over capture_output)'",
      "source_reference": "src/cook/workflow/executor/data_structures.rs:75, documented in Deprecated Fields section but not in main table"
    },
    {
      "type": "unclear_content",
      "severity": "medium",
      "section": "Command Reference > Command Fields",
      "description": "Table lists 'capture_streams' with description 'Reserved for future YAML syntax' which is confusing - is it available or not?",
      "current_content": "capture_streams | string | Reserved for future YAML syntax - not yet available in workflows",
      "should_be": "Either remove from table and add to 'Planned Features' section, or clarify it's internal-only",
      "fix_suggestion": "Move capture_streams to a separate 'Planned/Internal Fields' section to avoid confusion about what users can actually use in their YAML workflows",
      "source_reference": "src/config/command.rs:396"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Nested failure handlers",
      "description": "Documentation mentions nested on_failure handlers (line 18-23) but doesn't explain the strategy field or other OnFailureConfig options",
      "feature_reference": "error_handling.command_level.on_failure",
      "fix_suggestion": "Add explanation of OnFailureConfig fields: strategy (Recovery/Fallback/Cleanup/Custom), max_retries, fail_workflow, retry_original",
      "source_reference": "src/cook/workflow/on_failure.rs:25-100"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Deprecated Fields > capture_output migration",
      "description": "Documentation explains capture_output is deprecated but shows both Boolean and String variants without clearly showing they both map to the same new 'capture' field",
      "current_content": "Shows both variants separately but migration is unclear",
      "should_be": "Show clear before/after for both: capture_output: true → capture: \"output\", capture_output: \"name\" → capture: \"name\"",
      "fix_suggestion": "Add side-by-side comparison table showing old vs new syntax for both Boolean and String variants",
      "source_reference": "book/src/commands.md:410-441"
    }
  ],
  "positive_aspects": [
    "Excellent examples for all command types with clear, runnable YAML",
    "Good deprecation warnings with migration paths (test: to shell:, capture_output to capture)",
    "Comprehensive coverage of goal_seek, foreach, write_file, and validation commands",
    "Clear explanation of capture_format options with examples (string, number, json, lines, boolean)",
    "Good organization with cross-references to related chapters",
    "Technical notes section appropriately separates internal implementation from user-facing API",
    "Validation command documentation covers both simple and complex use cases",
    "Troubleshooting section for goal_seek is helpful and practical"
  ],
  "improvement_suggestions": [
    "CRITICAL: Verify which fields are actually available in WorkflowStepCommand (user-facing YAML) vs WorkflowStep (internal representation)",
    "Add cwd, env, and on_exit_code fields to WorkflowStepCommand struct if they should be user-accessible, or remove/clarify their examples in documentation",
    "Add 'capture' field to the main Command Fields table (not just in Deprecated section)",
    "Create a clear 'Field Availability' section explaining which fields work with which command formats",
    "Move 'capture_streams' to a 'Planned Features' or 'Internal Fields' section to avoid confusion",
    "Add more explanation of OnFailureConfig options (strategy, max_retries, retry_original)",
    "Consider adding examples combining multiple features (capture + on_failure + timeout + when)",
    "Add a migration guide showing exact before/after for all deprecated features"
  ],
  "metadata": {
    "analyzed_at": "2025-01-11T23:50:00Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Shell commands",
      "Claude commands",
      "Goal-seeking",
      "Foreach",
      "Validation",
      "Write file",
      "Command fields",
      "Error handling",
      "Output capture",
      "Deprecated features"
    ],
    "validation_focus": "Check all command types and their fields are documented",
    "struct_comparison": {
      "WorkflowStepCommand_fields": [
        "claude",
        "shell",
        "analyze",
        "test",
        "goal_seek",
        "foreach",
        "write_file",
        "id",
        "commit_required",
        "analysis",
        "outputs",
        "capture_output",
        "on_failure",
        "on_success",
        "validate",
        "timeout",
        "when",
        "capture_format",
        "capture_streams",
        "output_file"
      ],
      "WorkflowStep_additional_fields": [
        "cwd (working_dir)",
        "env",
        "on_exit_code",
        "capture"
      ]
    }
  }
}
