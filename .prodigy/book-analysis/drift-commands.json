{
  "item_type": "chapter",
  "chapter_id": "commands",
  "chapter_title": "Command Types",
  "chapter_file": "book/src/commands.md",
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Chapter provides good coverage of basic command types with clear examples, but is missing several important fields available in the implementation (cwd, on_exit_code, step-level env). Examples are accurate and well-structured, but incomplete field documentation limits user awareness of advanced capabilities.",
  "issues": [
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Command Reference - Command Fields table",
      "description": "Missing documentation for 'cwd' field for per-command working directory control",
      "feature_reference": "advanced_features.working_directory",
      "fix_suggestion": "Add 'cwd' field to Command Fields table with description: 'Working directory for command execution (string)' and example showing usage",
      "source_reference": "features.json:advanced_features.working_directory, src/config/command.rs line 354"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Command Reference - Command Fields table",
      "description": "Missing documentation for 'on_exit_code' field for mapping specific exit codes to different handlers",
      "feature_reference": "error_handling.command_level.on_exit_code",
      "fix_suggestion": "Add 'on_exit_code' field to Command Fields table and provide example showing exit code mapping (e.g., '1: compile error, 2: lint error, 127: missing tool')",
      "source_reference": "features.json:error_handling.command_level.on_exit_code"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Command Reference - Command Fields table",
      "description": "Missing documentation for step-level 'env' field for command-specific environment variables",
      "feature_reference": "environment.step_env",
      "fix_suggestion": "Add 'env' field to Command Fields table with description about step-level environment variable overrides and example",
      "source_reference": "features.json:environment.step_env, src/config/command.rs:CommandMetadata.env line 145"
    },
    {
      "type": "incomplete_explanation",
      "severity": "medium",
      "section": "Command Reference - Command Fields table",
      "description": "The 'capture' field is documented but the relationship with 'capture_output' (CaptureOutputConfig) is not fully explained in the table",
      "current_content": "capture | string | Variable name to capture command output (replaces deprecated `capture_output: true`)",
      "should_be": "Explain that CaptureOutputConfig supports both Boolean (deprecated) and String (variable name) variants",
      "fix_suggestion": "Update the capture field documentation to clarify both capture: variable_name (preferred) and capture_output: true/variable_name (deprecated) are supported",
      "source_reference": "src/config/command.rs:CaptureOutputConfig enum lines 404-411"
    },
    {
      "type": "incomplete_explanation",
      "severity": "medium",
      "section": "Shell Commands - on_failure",
      "description": "Documentation mentions nested on_failure handlers but doesn't show concrete example",
      "feature_reference": "error_handling.command_level.on_failure.nesting",
      "fix_suggestion": "Add example showing on_failure handler with its own nested on_failure for multi-level error recovery (e.g., test fails → debug, debug fails → notify team)",
      "source_reference": "features.json:error_handling.command_level.on_failure.nesting line 389"
    },
    {
      "type": "unclear_content",
      "severity": "low",
      "section": "Command Reference - CaptureStreams Configuration",
      "description": "The note says 'capture_streams' is 'not yet exposed in YAML syntax' but doesn't indicate when it will be available or priority",
      "fix_suggestion": "Either provide a timeline/issue reference for when capture_streams will be available or clarify it's a long-term planned feature",
      "source_reference": "src/config/command.rs:WorkflowStepCommand.capture_streams line 395-396"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "Deprecated Fields",
      "description": "Deprecation warnings could be more prominent with warning boxes instead of inline mentions",
      "fix_suggestion": "Add markdown warning/note boxes for deprecated features (test:, command: in ValidationConfig, capture_output) using > **Note:** or > **Warning:** syntax",
      "source_reference": "book/src/commands.md lines 174, 320"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Cross-References",
      "description": "Cross-references mention chapters but don't provide specific anchor links for easy navigation",
      "current_content": "See the Variables chapter for details on using captured outputs",
      "should_be": "See the [Variables chapter](./variables.md#captured-variables) for details on using captured outputs",
      "fix_suggestion": "Add specific markdown links with anchors to referenced sections in Variables, Error Handling, and MapReduce chapters",
      "source_reference": "book/src/commands.md lines 376-378"
    }
  ],
  "positive_aspects": [
    "Clear, practical examples for each command type (shell, claude, goal_seek, foreach, write_file, validation)",
    "Good explanation of deprecation migration paths (test → shell with on_failure, capture_output → capture)",
    "Helpful troubleshooting section for goal_seek command with common issues and solutions",
    "Well-organized command reference table that clearly lists most available fields",
    "Detailed capture format examples showing string, number, json, lines, boolean formats",
    "Good coverage of validation command with both old and new syntax examples",
    "Technical notes section appropriately separates internal implementation details from user-facing config",
    "Examples are syntactically correct and match actual implementation"
  ],
  "improvement_suggestions": [
    "Add 'cwd', 'on_exit_code', and 'env' fields to the Command Fields table with usage examples",
    "Provide concrete example of nested on_failure handlers for multi-level error recovery",
    "Add warning boxes for deprecated features to make them more visible to readers",
    "Convert generic cross-references to specific markdown links with section anchors",
    "Consider adding a 'Common Patterns' section showing realistic multi-command workflows",
    "Add examples combining multiple command features (e.g., shell with capture, on_failure, timeout, when)",
    "Clarify timeline or priority for capture_streams YAML syntax availability"
  ],
  "metadata": {
    "analyzed_at": "2025-11-09T19:45:00Z",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Shell commands",
      "Claude commands",
      "Goal-seeking",
      "Foreach",
      "Validation"
    ],
    "validation_focus": "Check all command types and their fields are documented",
    "command_types_verified": [
      "shell",
      "claude",
      "goal_seek",
      "foreach",
      "write_file",
      "validation"
    ],
    "missing_fields_identified": [
      "cwd",
      "on_exit_code",
      "env (step-level)"
    ]
  }
}
