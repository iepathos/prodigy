<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Examples - Prodigy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="AI-powered workflow orchestration for development teams">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prodigy Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy/edit/main/book/src/examples.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<blockquote>
<p><strong>Last Verified</strong>: 2025-01-11 against codebase commit 753f90e0</p>
<p>All examples in this chapter have been validated against the current implementation. Field names, syntax, and configuration options are verified against source code definitions.</p>
</blockquote>
<p>This chapter demonstrates practical Prodigy workflows with real-world examples. Examples progress from simple to advanced, covering standard workflows, MapReduce parallel processing, error handling, and advanced features.</p>
<h2 id="quick-reference"><a class="header" href="#quick-reference">Quick Reference</a></h2>
<p>Find the right example for your use case:</p>
<div class="table-wrapper"><table><thead><tr><th>Use Case</th><th>Example</th><th>Key Features</th></tr></thead><tbody>
<tr><td>Simple build/test pipeline</td><td>Example 1</td><td>Basic commands, error handling</td></tr>
<tr><td>Iterative optimization</td><td>Example 2</td><td>Goal seeking, validation feedback</td></tr>
<tr><td>Loop over configurations</td><td>Example 3</td><td>Foreach iteration, parallel processing</td></tr>
<tr><td>Parallel code processing</td><td>Example 4, 8</td><td>MapReduce, distributed work</td></tr>
<tr><td>Conditional logic</td><td>Example 5</td><td>Capture output, when clauses</td></tr>
<tr><td>Multi-step validation</td><td>Example 6</td><td>Validation with gap filling</td></tr>
<tr><td>Environment configuration</td><td>Example 7</td><td>Env vars, secrets, profiles</td></tr>
<tr><td>Dead Letter Queue (DLQ)</td><td>Example 8</td><td>Error handling, retry failed items</td></tr>
<tr><td>Generate config files</td><td>Example 9</td><td>write_file with JSON/YAML/text</td></tr>
<tr><td>Advanced git tracking</td><td>Example 10</td><td>Git context variables, working_dir</td></tr>
<tr><td>External service resilience</td><td>Example 11</td><td>Circuit breakers, fail fast</td></tr>
<tr><td>Retry with backoff</td><td>Example 12</td><td>Exponential/linear/custom backoff</td></tr>
<tr><td>Reusable workflows</td><td>Example 13</td><td>Composition (preview feature)</td></tr>
<tr><td>Custom merge process</td><td>Example 14</td><td>Merge workflows, pre-merge validation</td></tr>
</tbody></table>
</div>
<h2 id="example-1-simple-build-and-test"><a class="header" href="#example-1-simple-build-and-test">Example 1: Simple Build and Test</a></h2>
<pre><code class="language-yaml">- shell: "cargo build"
- shell: "cargo test"
  on_failure:
    claude: "/fix-failing-tests"
- shell: "cargo clippy"
</code></pre>
<hr />
<h2 id="example-2-coverage-improvement-with-goal-seeking"><a class="header" href="#example-2-coverage-improvement-with-goal-seeking">Example 2: Coverage Improvement with Goal Seeking</a></h2>
<pre><code class="language-yaml">- goal_seek:
    goal: "Achieve 80% test coverage"
    claude: "/improve-coverage"  # Can also use 'shell' for shell commands
    validate: |
      coverage=$(cargo tarpaulin | grep 'Coverage' | sed 's/.*: \([0-9.]*\)%.*/\1/')
      echo "score: ${coverage%.*}"
    threshold: 80
    max_attempts: 5
    timeout_seconds: 1800  # Optional: 30 minute timeout for entire goal-seeking process
    fail_on_incomplete: false  # Optional: Continue workflow even if goal not reached
</code></pre>
<p><strong>Source</strong>: GoalSeekConfig from src/cook/goal_seek/mod.rs:14-41, execution engine from src/cook/goal_seek/engine.rs:23-116</p>
<p><strong>How Goal Seeking Works:</strong></p>
<p>Goal seeking provides iterative refinement with automatic convergence detection:</p>
<ol>
<li>Execute the improvement command (Claude or shell)</li>
<li>Run validation script to get a score (0-100)</li>
<li>Pass environment variables to next iteration:
<ul>
<li><code>PRODIGY_VALIDATION_SCORE</code> - Current score</li>
<li><code>PRODIGY_VALIDATION_OUTPUT</code> - Full validation output</li>
<li><code>PRODIGY_VALIDATION_GAPS</code> - Identified improvement areas</li>
</ul>
</li>
<li>Repeat until threshold reached, max attempts hit, or convergence detected</li>
<li>Auto-stops when no improvement in last 3 attempts (convergence)</li>
</ol>
<p><strong>Validation Script Format:</strong></p>
<pre><code class="language-bash"># Must output "score: N" where N is 0-100
echo "score: 75"
# Optional: output "gaps: description" for targeted improvements
echo "gaps: Missing tests for auth module"
</code></pre>
<p><strong>Goal-Seek vs Validate:</strong></p>
<ul>
<li><code>goal_seek</code>: Iterative optimization with feedback loop</li>
<li><code>validate</code>: One-time completion check (see Example 6)</li>
</ul>
<p><strong>Note:</strong> Changes are automatically committed during goal-seeking iterations. Use <code>commit_required: true</code> on the outer goal_seek step to control commit behavior.</p>
<hr />
<h2 id="example-3-foreach-iteration"><a class="header" href="#example-3-foreach-iteration">Example 3: Foreach Iteration</a></h2>
<pre><code class="language-yaml"># Test multiple configurations in sequence
- foreach:
    - rust-version: "1.70"
      profile: debug
    - rust-version: "1.71"
      profile: release
    - rust-version: "stable"
      profile: release
  do:
    - shell: "rustup install ${foreach.item.rust-version}"
    - shell: "cargo +${foreach.item.rust-version} build --profile ${foreach.item.profile}"
    - shell: "cargo +${foreach.item.rust-version} test"

# Parallel foreach with error handling
- foreach:
    - "web-service"
    - "api-gateway"
    - "worker-service"
  parallel: 3  # Options: false (sequential), true (default parallelism), or number (specific count)
  continue_on_error: true
  do:
    - shell: "cd services/${foreach.item} &amp;&amp; cargo build"
    - shell: "cd services/${foreach.item} &amp;&amp; cargo test"
      on_failure:
        claude: "/fix-service-tests ${foreach.item}"
</code></pre>
<hr />
<h2 id="example-4-parallel-code-review"><a class="header" href="#example-4-parallel-code-review">Example 4: Parallel Code Review</a></h2>
<pre><code class="language-yaml">name: parallel-code-review
mode: mapreduce

setup:
  - shell: "find src -name '*.rs' &gt; files.txt"
  - shell: "jq -R -s -c 'split(\"\n\") | map(select(length &gt; 0) | {path: .})' files.txt &gt; items.json"

map:
  input: items.json
  json_path: "$[*]"  # Process all items in root array
  agent_template:
    - claude: "/review-file ${item.path}"
      id: "review"
      capture_output: "review_result"  # Capture command output for use in later steps
      capture_format: "json"  # Parse output as JSON (see Example 5 for all format options)
    - shell: "cargo check ${item.path}"
  max_parallel: 5

reduce:
  - claude: "/summarize-reviews ${map.results}"
</code></pre>
<p><strong>Note:</strong> JSONPath <code>"$[*]"</code> matches all items in the root array. Since the setup phase creates an array of <code>{path: ...}</code> objects, each map agent receives an <code>item</code> object with <code>item.path</code> available for use in commands.</p>
<p><strong>Advanced JSONPath Patterns:</strong></p>
<ul>
<li><code>$.items[*]</code> - Extract items from nested object</li>
<li><code>$.items[*].files[*]</code> - Extract from nested arrays (flattens results)</li>
<li><code>$.items[?(@.priority &gt; 5)]</code> - Filter items by condition</li>
<li><code>$[?(@.severity == 'critical')]</code> - Filter array by field value</li>
</ul>
<hr />
<h2 id="example-5-conditional-deployment"><a class="header" href="#example-5-conditional-deployment">Example 5: Conditional Deployment</a></h2>
<pre><code class="language-yaml">- shell: "cargo test --quiet &amp;&amp; echo true || echo false"
  id: "test"
  capture_output: "test_result"  # Canonical field name (alias: 'capture')
  capture_format: "boolean"  # Supported formats explained below
  timeout: 300  # Timeout in seconds (5 minutes)

- shell: "cargo build --release"
  when: "${test_result} == true"

- shell: "docker build -t myapp ."
  when: "${test_result} == true"
  on_success:
    shell: "docker push myapp:latest"
</code></pre>
<p><strong>Note:</strong> <code>capture_format</code> options:</p>
<ul>
<li><code>string</code> - Raw text output (default)</li>
<li><code>json</code> - Parse output as JSON object</li>
<li><code>lines</code> - Split output into array of lines</li>
<li><code>number</code> - Parse output as numeric value</li>
<li><code>boolean</code> - Parse as true/false based on exit code or output text</li>
</ul>
<p><strong>Advanced capture options:</strong></p>
<pre><code class="language-yaml"># Capture specific streams (stdout, stderr, exit_code, success, duration)
- shell: "cargo build 2&gt;&amp;1"
  capture_output: "build_output"
  capture_streams: "stdout,stderr,exit_code"  # Capture multiple streams

# Access captured values
- shell: "echo 'Exit code was ${build_output.exit_code}'"
</code></pre>
<hr />
<h2 id="example-6-multi-step-validation"><a class="header" href="#example-6-multi-step-validation">Example 6: Multi-Step Validation</a></h2>
<pre><code class="language-yaml">- claude: "/implement-feature auth"
  commit_required: true
  validate:
    commands:
      - shell: "cargo test auth"
      - shell: "cargo clippy -- -D warnings"
      - claude: "/validate-implementation --output validation.json"
    result_file: "validation.json"
    threshold: 90
    on_incomplete:
      claude: "/complete-gaps ${validation.gaps}"
      commit_required: true
      max_attempts: 2
</code></pre>
<hr />
<h2 id="example-7-environment-aware-workflow"><a class="header" href="#example-7-environment-aware-workflow">Example 7: Environment-Aware Workflow</a></h2>
<pre><code class="language-yaml"># Global environment variables (including secrets with masking)
env:
  # Regular variables
  NODE_ENV: production
  API_URL: https://api.production.com

  # Secrets (automatically masked in logs)
  # Use secret: true and value fields for sensitive data
  API_KEY:
    secret: true
    value: "${SECRET_API_KEY}"

  # Secret with external provider
  DB_PASSWORD:
    secret: true
    value: "${DB_PASSWORD}"
    # provider: "vault"  # Optional: external secret store (not yet implemented)

# Environment profiles for different contexts
profiles:
  production:
    env:
      API_URL: https://api.production.com
      LOG_LEVEL: error
    description: "Production environment with error-level logging"

  staging:
    env:
      API_URL: https://api.staging.com
      LOG_LEVEL: warn
    description: "Staging environment with warning-level logging"

# Load additional variables from .env files
# Note: Paths are relative to workflow file location
env_files:
  - .env
  - .env.production

# Workflow steps
- shell: "cargo build --release"

# Use environment variables in commands
- shell: "echo 'Deploying to ${NODE_ENV} at ${API_URL}'"

# Override environment for specific step using env field
- shell: "./deploy.sh"
  env:
    LOG_LEVEL: debug
</code></pre>
<p><strong>Source</strong>: Environment configuration from src/cook/environment/config.rs:12-36, secret masking from src/cook/environment/config.rs:84-96</p>
<p><strong>Note:</strong> Profiles are activated using the <code>--profile &lt;name&gt;</code> CLI flag when running workflows. For example:</p>
<pre><code class="language-bash"># Use production profile
prodigy run workflow.yml --profile production

# Use staging profile
prodigy run workflow.yml --profile staging
</code></pre>
<p><strong>Secrets Masking</strong>: Variables with <code>secret: true</code> are automatically masked in:</p>
<ul>
<li>Command output logs</li>
<li>Error messages</li>
<li>Event logs</li>
<li>Checkpoint files</li>
</ul>
<p>Example masked output:</p>
<pre><code>$ echo 'API key is ***'
</code></pre>
<p><strong>Source</strong>: Example workflow from workflows/mapreduce-env-example.yml:7-40, profile structure from tests/environment_workflow_test.rs:68-88</p>
<hr />
<h2 id="example-8-complex-mapreduce-with-error-handling"><a class="header" href="#example-8-complex-mapreduce-with-error-handling">Example 8: Complex MapReduce with Error Handling</a></h2>
<pre><code class="language-yaml">name: tech-debt-elimination
mode: mapreduce

setup:
  - shell: "debtmap analyze . --output debt.json"

map:
  input: debt.json
  json_path: "$.items[*]"
  filter: "item.severity == 'critical'"
  sort_by: "item.priority DESC"
  max_items: 20
  max_parallel: 5
  distinct: "item.id"  # Deduplication: Prevents processing duplicate items based on this field

  # Timeout configuration (optional - default is 600 seconds / 10 minutes)
  timeout_config:
    agent_timeout_secs: 600  # Maximum time per agent execution
    cleanup_grace_period_secs: 30  # Time allowed for cleanup after timeout

  agent_template:
    - claude: "/fix-debt-item '${item.description}'"
      commit_required: true
    - shell: "cargo test"
      on_failure:
        claude: "/debug-and-fix"

reduce:
  - shell: "debtmap analyze . --output debt-after.json"
  - claude: "/compare-debt-reports --before debt.json --after debt-after.json"

error_policy:
  on_item_failure: dlq  # Default: dlq (failed items to Dead Letter Queue)
  continue_on_failure: true  # Default: true (continue despite failures)
  max_failures: 5  # Optional: stop after N failures
  failure_threshold: 0.3  # Optional: stop if &gt;30% fail
  error_collection: aggregate  # Default: aggregate (Options: aggregate, immediate, batched:{size})
</code></pre>
<p><strong>Note:</strong> The entire <code>error_policy</code> block is optional with sensible defaults. If not specified, failed items go to the Dead Letter Queue (<code>on_item_failure: dlq</code>), workflow continues despite failures (<code>continue_on_failure: true</code>), and errors are aggregated at the end (<code>error_collection: aggregate</code>). Use <code>max_failures</code> or <code>failure_threshold</code> to fail fast if too many items fail.</p>
<p><strong>Deduplication with <code>distinct</code></strong>: The <code>distinct</code> field enables idempotent processing by preventing duplicate work items. When specified, Prodigy extracts the value of the given field (e.g., <code>item.id</code>) from each work item and ensures only unique values are processed. This is useful when:</p>
<ul>
<li>Input data may contain duplicates</li>
<li>Resuming a workflow after adding new items</li>
<li>Preventing wasted work on identical items</li>
<li>Ensuring exactly-once processing semantics</li>
</ul>
<p>Example: With <code>distinct: "item.id"</code>, if your input contains <code>[{id: "1", ...}, {id: "2", ...}, {id: "1", ...}]</code>, only items with IDs “1” and “2” will be processed (the duplicate “1” is skipped).</p>
<p><strong>Resuming MapReduce Workflows:</strong>
MapReduce jobs can be resumed using either the session ID or job ID:</p>
<pre><code class="language-bash"># Resume using session ID
prodigy resume session-mapreduce-1234567890

# Resume using job ID
prodigy resume-job mapreduce-1234567890

# Unified resume command (auto-detects ID type)
prodigy resume mapreduce-1234567890
</code></pre>
<p><strong>Session-Job ID Mapping</strong>: The bidirectional mapping between session IDs and job IDs is stored in <code>~/.prodigy/state/{repo_name}/mappings/</code> and created automatically when the MapReduce workflow starts. This allows you to resume using either the session ID (e.g., <code>session-mapreduce-1234567890</code>) or the job ID (e.g., <code>mapreduce-1234567890</code>), and Prodigy will automatically find the correct checkpoint data.</p>
<p><strong>Source</strong>: Session-job mapping implementation from MapReduce checkpoint and resume (Spec 134)</p>
<p><strong>Debugging Failed Agents:</strong>
When agents fail, DLQ entries include a <code>json_log_location</code> field pointing to the Claude JSON log file for debugging:</p>
<pre><code class="language-bash"># View failed items and their log locations
prodigy dlq show &lt;job_id&gt; | jq '.items[].failure_history[].json_log_location'

# Inspect the Claude interaction for a failed agent
cat &lt;json_log_location&gt; | jq
</code></pre>
<p>This allows you to see exactly what tools Claude invoked and why the agent failed.</p>
<hr />
<h2 id="example-9-generating-configuration-files"><a class="header" href="#example-9-generating-configuration-files">Example 9: Generating Configuration Files</a></h2>
<pre><code class="language-yaml"># Generate a JSON configuration file
- write_file:
    path: "config/deployment.json"
    format: json  # Options: text, json, yaml
    create_dirs: true  # Create parent directories if they don't exist
    content:
      environment: production
      api_url: "${API_URL}"
      features:
        - auth
        - analytics
        - notifications
      timeout: 30

# Generate a YAML configuration file
- write_file:
    path: "config/services.yml"
    format: yaml
    content:
      services:
        web:
          image: "myapp:latest"
          ports:
            - "8080:8080"
        database:
          image: "postgres:15"
          environment:
            POSTGRES_DB: "${DB_NAME}"

# Generate a plain text report
- write_file:
    path: "reports/summary.txt"
    format: text
    mode: "0644"  # File permissions (optional)
    content: |
      Deployment Summary
      ==================
      Environment: ${NODE_ENV}
      API URL: ${API_URL}
      Timestamp: $(date)
</code></pre>
<hr />
<h2 id="example-10-advanced-features"><a class="header" href="#example-10-advanced-features">Example 10: Advanced Features</a></h2>
<pre><code class="language-yaml"># Nested error handling with retry configuration
- shell: "cargo build --release"
  on_failure:
    shell: "cargo clean"
    on_success:
      shell: "cargo build --release"
      max_attempts: 2
  on_success:
    shell: "cargo test --release"

# Complex conditional execution with max_attempts
- shell: "cargo test"
  id: "test"
  capture_output: "test_output"

- claude: "/fix-tests"
  when: "${test_output} contains 'FAILED'"
  max_attempts: 3

# Conditional deployment based on test results
- shell: "cargo build --release"
  when: "${test.exit_code} == 0"

# Multi-condition logic
- shell: "./deploy.sh"
  when: "${test_output} contains 'passed' and ${build_output} contains 'Finished'"
</code></pre>
<p><strong>Note:</strong> Advanced features currently supported:</p>
<ul>
<li><strong>Nested handlers</strong>: Chain <code>on_failure</code> and <code>on_success</code> handlers for complex error recovery</li>
<li><strong>Max attempts</strong>: Combine with conditional execution for automatic retry logic</li>
<li><strong>Conditional execution</strong>: Use <code>when</code> clauses with captured output or variables</li>
<li><strong>Complex conditionals</strong>: Combine multiple conditions with <code>and</code>/<code>or</code> operators</li>
<li><strong>Working directory</strong>: Per-command directory control using <code>working_dir</code> field</li>
<li><strong>Git context variables</strong>: Automatic tracking of file changes during workflow execution</li>
</ul>
<p><strong>Example of working_dir usage:</strong></p>
<p><strong>Source</strong>: Field definition from src/commands/handlers/shell.rs:40, examples from workflows/environment-example.yml:52-64</p>
<pre><code class="language-yaml"># Run command in specific directory
- name: "Build frontend"
  shell: "npm run build"
  working_dir: ./frontend      # Execute in frontend/ directory

# Combine with environment variables
- name: "Run backend tests"
  shell: "pytest"
  env:
    PYTHONPATH: "./src:./tests"
  working_dir: ./backend

# Use variable interpolation for dynamic paths
- name: "Deploy to environment"
  shell: "echo 'Deploying...'"
  working_dir: "${env.DEPLOY_DIR}"  # Path from environment variable
</code></pre>
<p><strong>Note:</strong> The <code>working_dir</code> field is fully implemented and production-ready:</p>
<ul>
<li>Accepts relative or absolute paths</li>
<li>Supports variable interpolation (e.g., <code>"${env.PROJECT_DIR}"</code>)</li>
<li>Falls back to current execution context if not specified</li>
<li>Paths are resolved to absolute paths automatically</li>
<li>Relative paths are resolved via the workflow execution context</li>
</ul>
<p><strong>Git Context Variables (Spec 122):</strong>
Prodigy automatically tracks file changes during workflow execution and exposes them as variables:</p>
<pre><code class="language-yaml"># Access files changed in current step
- shell: "echo 'Modified files: ${step.files_modified}'"
- shell: "echo 'Added files: ${step.files_added}'"
- shell: "echo 'Deleted files: ${step.files_deleted}'"

# Format as JSON array
- shell: "echo '${step.files_modified:json}'"

# Filter by glob pattern (only Rust files)
- shell: "echo 'Rust files changed: ${step.files_modified:*.rs}'"

# Access workflow-level aggregations
- shell: "echo 'Total commits: ${workflow.commit_count}'"
- shell: "echo 'All modified files: ${workflow.files_modified}'"

# Access uncommitted changes
- shell: "echo 'Staged files: ${git.staged_files}'"
- shell: "echo 'Unstaged files: ${git.unstaged_files}'"

# Pattern filtering for git context
- claude: "/review-changes ${git.modified_files|pattern:**/*.rs}"
- shell: "echo 'Changed Rust files: ${git.staged_files|pattern:**/*.rs}'"

# Basename-only output (no paths)
- shell: "echo 'File names: ${git.modified_files|basename}'"
</code></pre>
<p><strong>Available Git Context Variables:</strong></p>
<ul>
<li><code>${step.files_added}</code> - Files added in current step</li>
<li><code>${step.files_modified}</code> - Files modified in current step</li>
<li><code>${step.files_deleted}</code> - Files deleted in current step</li>
<li><code>${step.commits}</code> - Commit SHAs created in this step</li>
<li><code>${step.insertions}</code> - Lines inserted in this step</li>
<li><code>${step.deletions}</code> - Lines deleted in this step</li>
<li><code>${workflow.commit_count}</code> - Total commits in workflow</li>
<li><code>${workflow.files_modified}</code> - All files modified across workflow</li>
<li><code>${git.staged_files}</code> - Currently staged files (uncommitted)</li>
<li><code>${git.unstaged_files}</code> - Modified but unstaged files</li>
<li><code>${git.modified_files}</code> - All uncommitted modifications</li>
</ul>
<p><strong>Supported Formats and Filters:</strong></p>
<ul>
<li><code>:json</code> - Format as JSON array</li>
<li><code>:*.rs</code> - Filter by glob pattern (e.g., <code>*.rs</code>, <code>src/**/*.py</code>)</li>
<li><code>|pattern:**/*.rs</code> - Alternative syntax for glob pattern filtering (equivalent to <code>:pattern</code>)</li>
<li><code>|basename</code> - Extract just file names without paths</li>
</ul>
<p><strong>Note:</strong> Both <code>:pattern</code> and <code>|pattern:</code> syntaxes are valid and equivalent. Use whichever is more readable in your context:</p>
<ul>
<li><code>${git.modified_files:*.rs}</code> - Colon syntax (more concise)</li>
<li><code>${git.modified_files|pattern:**/*.rs}</code> - Pipe syntax (more explicit)</li>
</ul>
<p><strong>Source</strong>: Git context tracking from src/cook/workflow/git_context.rs:1-120, variable resolution from src/cook/workflow/git_context.rs:36-42</p>
<p><strong>Troubleshooting MapReduce Cleanup:</strong>
If agent worktree cleanup fails (due to disk full, permission errors, etc.), use the orphaned worktree cleanup command:</p>
<pre><code class="language-bash"># List and clean orphaned worktrees for a specific job
prodigy worktree clean-orphaned &lt;job_id&gt;

# Dry run to preview what would be cleaned
prodigy worktree clean-orphaned &lt;job_id&gt; --dry-run

# Force cleanup without confirmation
prodigy worktree clean-orphaned &lt;job_id&gt; --force
</code></pre>
<p>Note: Agent execution status is independent of cleanup status. If an agent completes successfully but cleanup fails, the agent is still marked as successful and results are preserved.</p>
<p><strong>Source</strong>: Orphaned worktree cleanup from MapReduce cleanup failure handling (Spec 136)</p>
<hr />
<h2 id="example-11-circuit-breaker-for-resilient-error-handling"><a class="header" href="#example-11-circuit-breaker-for-resilient-error-handling">Example 11: Circuit Breaker for Resilient Error Handling</a></h2>
<pre><code class="language-yaml">name: api-processing-with-circuit-breaker
mode: mapreduce

setup:
  - shell: "curl https://api.example.com/items &gt; items.json"

map:
  input: items.json
  json_path: "$[*]"
  max_parallel: 10

  agent_template:
    - shell: "curl -X POST https://api.example.com/process -d '${item}'"
      max_attempts: 3
    - claude: "/validate-processing ${item.id}"

  # Circuit breaker prevents cascading failures from external service issues
  error_policy:
    on_item_failure: dlq
    continue_on_failure: true
    circuit_breaker:
      failure_threshold: 5      # Open circuit after 5 consecutive failures
      success_threshold: 3      # Close circuit after 3 consecutive successes
      timeout: 30s             # Wait 30s before testing recovery (half-open state)
      half_open_requests: 3    # Allow 3 test requests in half-open state

reduce:
  - claude: "/summarize-results ${map.results}"
</code></pre>
<p><strong>Source</strong>: CircuitBreakerConfig from src/cook/workflow/error_policy.rs:46-88, state machine from error_policy.rs:251-343</p>
<p><strong>Circuit Breaker State Transitions:</strong></p>
<pre><code>Closed → Open (after failure_threshold consecutive failures)
Open → HalfOpen (after timeout expires)
HalfOpen → Closed (after success_threshold successes)
HalfOpen → Open (if any half_open_request fails)
</code></pre>
<p><strong>When to Use Circuit Breakers:</strong></p>
<ul>
<li>External API calls that may become unavailable</li>
<li>Database operations during maintenance windows</li>
<li>Network-dependent operations with potential outages</li>
<li>Any operation where cascading failures should be prevented</li>
</ul>
<p><strong>Circuit Breaker Benefits:</strong></p>
<ul>
<li><strong>Fail Fast</strong>: Stop wasting resources on doomed requests</li>
<li><strong>Self-Healing</strong>: Automatically test recovery after timeout</li>
<li><strong>Prevent Overload</strong>: Give external services time to recover</li>
<li><strong>Clear Signals</strong>: Circuit state indicates system health</li>
</ul>
<p><strong>Default Values</strong> (from error_policy.rs:63-76):</p>
<ul>
<li><code>failure_threshold: 5</code> - Balance between sensitivity and stability</li>
<li><code>success_threshold: 3</code> - Require consistent success before full recovery</li>
<li><code>timeout: 30s</code> - Typical recovery time for transient issues</li>
<li><code>half_open_requests: 3</code> - Minimal testing before full recovery</li>
</ul>
<p><strong>See Also</strong>: <a href="error-handling.html">Error Handling Guide</a> for comprehensive error handling patterns</p>
<hr />
<h2 id="example-12-retry-configuration-with-backoff-strategies"><a class="header" href="#example-12-retry-configuration-with-backoff-strategies">Example 12: Retry Configuration with Backoff Strategies</a></h2>
<pre><code class="language-yaml">name: resilient-deployment
mode: standard

# Global retry defaults for all commands
error_policy:
  retry_config:
    max_attempts: 3          # Maximum retry attempts
    backoff: exponential      # Backoff strategy (see variants below)

# Workflow steps
- shell: "curl https://api.example.com/deploy"
  # Inherits global retry_config

- shell: "docker push myapp:latest"
  # Override with custom retry config
  retry_config:
    max_attempts: 5
    backoff:
      exponential:
        initial: 2s          # Start with 2 second delay
        multiplier: 2.0      # Double delay each retry (2s, 4s, 8s, 16s, 32s)
</code></pre>
<p><strong>Source</strong>: BackoffStrategy enum from src/cook/retry_v2.rs:70-98, RetryConfig from retry_v2.rs:14-52</p>
<p><strong>Backoff Strategy Variants:</strong></p>
<p><strong>1. Exponential (Default)</strong> - Delay doubles each retry:</p>
<pre><code class="language-yaml">backoff:
  exponential:
    initial: 1s         # First retry after 1s
    multiplier: 2.0     # Second after 2s, third after 4s, fourth after 8s
</code></pre>
<p><strong>2. Linear</strong> - Delay increases by fixed increment:</p>
<pre><code class="language-yaml">backoff:
  linear:
    initial: 1s         # First retry after 1s
    increment: 2s       # Second after 3s, third after 5s, fourth after 7s
</code></pre>
<p><strong>3. Fibonacci</strong> - Delay follows Fibonacci sequence:</p>
<pre><code class="language-yaml">backoff:
  fibonacci:
    initial: 1s         # Delays: 1s, 1s, 2s, 3s, 5s, 8s, 13s...
</code></pre>
<p><strong>4. Fixed</strong> - Same delay for all retries:</p>
<pre><code class="language-yaml">backoff:
  fixed:
    delay: 5s           # All retries wait exactly 5s
</code></pre>
<p><strong>5. Custom</strong> - Specify exact delays:</p>
<pre><code class="language-yaml">backoff:
  custom:
    delays: [1s, 5s, 15s, 30s, 60s]
</code></pre>
<p><strong>Advanced Retry Configuration:</strong></p>
<pre><code class="language-yaml">- shell: "curl https://api.example.com/data"
  retry_config:
    max_attempts: 5
    backoff:
      exponential:
        initial: 1s
        multiplier: 2.0
    initial_delay: 1s           # Base delay before backoff
    max_delay: 60s              # Cap maximum delay
    jitter: true                # Add randomness to prevent thundering herd
    jitter_factor: 0.3          # ±30% random variance
    retry_budget: 300s          # Total retry time budget (5 minutes)
    retry_on:                   # Only retry specific error types
      - network                 # Network errors
      - timeout                 # Timeout errors
      - server_error            # HTTP 5xx errors
      - rate_limit              # Rate limiting errors
    on_failure: continue        # What to do after all retries fail
</code></pre>
<p><strong>Source</strong>: Test examples from src/cook/retry_v2.rs:582-659, backoff calculation from retry_v2.rs:283-305</p>
<p><strong>Backoff Strategy Comparison:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Strategy</th><th>Use Case</th><th>Delay Pattern</th><th>Example</th></tr></thead><tbody>
<tr><td><strong>Exponential</strong></td><td>Most scenarios, fast backoff</td><td>2^n × initial</td><td>1s, 2s, 4s, 8s</td></tr>
<tr><td><strong>Linear</strong></td><td>Steady load reduction</td><td>initial + (n × increment)</td><td>1s, 3s, 5s, 7s</td></tr>
<tr><td><strong>Fibonacci</strong></td><td>Gradual backoff</td><td>Fibonacci(n) × initial</td><td>1s, 1s, 2s, 3s, 5s</td></tr>
<tr><td><strong>Fixed</strong></td><td>Rate limiting, polling</td><td>constant</td><td>5s, 5s, 5s, 5s</td></tr>
<tr><td><strong>Custom</strong></td><td>Complex SLA requirements</td><td>user-defined</td><td>1s, 5s, 15s, 60s</td></tr>
</tbody></table>
</div>
<p><strong>Jitter Benefits</strong> (from retry_v2.rs:644-659):</p>
<ul>
<li>Prevents thundering herd when multiple agents retry simultaneously</li>
<li>Adds ±30% random variance by default (configurable via <code>jitter_factor</code>)</li>
<li>Example: 10s delay becomes 7-13s with 0.3 jitter factor</li>
</ul>
<p><strong>See Also</strong>: <a href="mapreduce/backoff-strategies.html">Retry State Tracking</a> for persistence and recovery</p>
<hr />
<h2 id="example-13-workflow-composition-preview-feature"><a class="header" href="#example-13-workflow-composition-preview-feature">Example 13: Workflow Composition (Preview Feature)</a></h2>
<blockquote>
<p><strong>Note</strong>: Workflow composition features are partially implemented. Core composition logic exists but CLI integration is pending (Spec 131-133). This example shows the planned syntax.</p>
</blockquote>
<pre><code class="language-yaml"># Import reusable workflow fragments
imports:
  - "./workflows/common/test-suite.yml"
  - "./workflows/common/deploy.yml"

# Extend base workflow
extends: "./workflows/base-ci.yml"

name: extended-ci-workflow
mode: standard

# Template for reusable command sets
templates:
  rust_test:
    - shell: "cargo build"
    - shell: "cargo test"
    - shell: "cargo clippy"

  deploy_to_env:
    parameters:
      - env_name
      - target_url
    commands:
      - shell: "echo 'Deploying to ${env_name}'"
      - shell: "curl -X POST ${target_url}/deploy"

# Use templates in workflow
steps:
  - template: rust_test
  - template: deploy_to_env
    with:
      env_name: "production"
      target_url: "${API_URL}"
</code></pre>
<p><strong>Source</strong>: Composition architecture from features.json:workflow_composition, implementation status note from drift analysis</p>
<p><strong>Planned Composition Features:</strong></p>
<ul>
<li><strong>Imports</strong>: Reuse workflow fragments across projects</li>
<li><strong>Extends</strong>: Inherit from base workflows with overrides</li>
<li><strong>Templates</strong>: Parameterized command sets for DRY workflows</li>
<li><strong>Parameters</strong>: Type-safe template parameterization</li>
</ul>
<p><strong>Current Status:</strong></p>
<ul>
<li>Core composition logic: ✓ Implemented</li>
<li>Configuration parsing: ✓ Implemented</li>
<li>CLI integration: ⏳ Pending (Spec 131-133)</li>
<li>Template rendering: ⏳ Pending</li>
</ul>
<p><strong>Workaround Until CLI Integration:</strong>
Use YAML anchors and aliases for basic composition:</p>
<pre><code class="language-yaml"># Define reusable blocks with anchors
.rust_test: &amp;rust_test
  - shell: "cargo build"
  - shell: "cargo test"

.deploy: &amp;deploy
  - shell: "echo 'Deploying...'"

# Reference with aliases
workflow:
  - *rust_test
  - *deploy
</code></pre>
<hr />
<h2 id="example-14-custom-merge-workflows"><a class="header" href="#example-14-custom-merge-workflows">Example 14: Custom Merge Workflows</a></h2>
<p>MapReduce workflows execute in isolated git worktrees. When the workflow completes, you can define a custom merge workflow to control how changes are merged back to your original branch.</p>
<pre><code class="language-yaml">name: code-review-with-merge
mode: mapreduce

# Environment variables available to merge commands
env:
  PROJECT_NAME: "my-project"
  NOTIFICATION_URL: "https://api.slack.com/webhooks/..."

setup:
  - shell: "find src -name '*.rs' &gt; files.json"
  - shell: "jq -R -s -c 'split(\"\n\") | map(select(length &gt; 0) | {path: .})' files.json &gt; items.json"

map:
  input: "items.json"
  json_path: "$[*]"
  agent_template:
    - claude: "/review-code ${item.path}"
      commit_required: true
  max_parallel: 5

reduce:
  - claude: "/summarize-reviews ${map.results}"

# Custom merge workflow (executed when merging worktree back to original branch)
merge:
  commands:
    # Merge-specific variables are available:
    # ${merge.worktree} - Worktree name (e.g., "session-abc123")
    # ${merge.source_branch} - Source branch in worktree
    # ${merge.target_branch} - Target branch (where you started workflow)
    # ${merge.session_id} - Session ID for correlation

    # Pre-merge validation
    - shell: "echo 'Preparing to merge ${merge.worktree}'"
    - shell: "echo 'Source: ${merge.source_branch} → Target: ${merge.target_branch}'"

    # Run tests before merging
    - shell: "cargo test --all"
      on_failure:
        claude: "/fix-failing-tests before merge"
        commit_required: true
        max_attempts: 2

    # Run linting
    - shell: "cargo clippy -- -D warnings"
      on_failure:
        claude: "/fix-clippy-warnings"
        commit_required: true

    # Optional: Custom validation via Claude
    - claude: "/validate-merge-readiness ${merge.source_branch} ${merge.target_branch}"

    # Actually perform the merge using prodigy-merge-worktree
    # IMPORTANT: Always pass both source and target branches
    - claude: "/prodigy-merge-worktree ${merge.source_branch} ${merge.target_branch}"

    # Post-merge notifications (using env vars)
    - shell: "echo 'Successfully merged ${PROJECT_NAME} changes from ${merge.worktree}'"
    # - shell: "curl -X POST ${NOTIFICATION_URL} -d 'Merge completed for ${PROJECT_NAME}'"

  # Optional: Timeout for entire merge phase (seconds)
  timeout: 600  # 10 minutes
</code></pre>
<p><strong>Source</strong>: Merge workflow configuration from src/config/mapreduce.rs:84-94, merge variables from worktree merge orchestrator, example from workflows/mapreduce-env-example.yml:83-94, test from tests/merge_workflow_integration.rs:64-121</p>
<p><strong>Merge Workflow Features:</strong></p>
<ol>
<li>
<p><strong>Merge-Specific Variables</strong> (automatically provided):</p>
<ul>
<li><code>${merge.worktree}</code> - Name of the worktree being merged</li>
<li><code>${merge.source_branch}</code> - Branch in worktree (usually <code>prodigy-mapreduce-...</code>)</li>
<li><code>${merge.target_branch}</code> - Your original branch (main, master, feature-xyz, etc.)</li>
<li><code>${merge.session_id}</code> - Session ID for tracking</li>
</ul>
</li>
<li>
<p><strong>Pre-Merge Validation</strong>:</p>
<ul>
<li>Run tests, linting, or custom checks before merging</li>
<li>Use Claude commands for intelligent validation</li>
<li>Use <code>on_failure</code> handlers to fix issues automatically</li>
</ul>
</li>
<li>
<p><strong>Environment Variables</strong>:</p>
<ul>
<li>Global <code>env</code> variables are available in merge commands</li>
<li>Useful for notifications, project-specific settings</li>
<li>Secrets are masked in merge command output</li>
</ul>
</li>
<li>
<p><strong>Timeout Control</strong>:</p>
<ul>
<li>Optional <code>timeout</code> field (in seconds) for the merge phase</li>
<li>Prevents merge workflows from hanging indefinitely</li>
</ul>
</li>
</ol>
<p><strong>Important Notes:</strong></p>
<ul>
<li>Always pass <strong>both</strong> <code>${merge.source_branch}</code> and <code>${merge.target_branch}</code> to <code>/prodigy-merge-worktree</code></li>
<li>This ensures the merge targets your original branch, not a hardcoded main/master</li>
<li>Without a custom merge workflow, you’ll be prompted interactively to merge</li>
</ul>
<p><strong>Simplified Format:</strong>
If you don’t need timeout configuration, you can use the simplified format:</p>
<pre><code class="language-yaml">merge:
  - shell: "cargo test"
  - claude: "/prodigy-merge-worktree ${merge.source_branch} ${merge.target_branch}"
</code></pre>
<p>This is equivalent to <code>merge.commands</code> but more concise.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="automated-documentation/documentation-versioning.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="troubleshooting/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="automated-documentation/documentation-versioning.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="troubleshooting/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
