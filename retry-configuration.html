<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Retry Configuration - Prodigy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="AI-powered workflow orchestration for development teams">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prodigy Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy/edit/main/book/src/retry-configuration.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="retry-configuration"><a class="header" href="#retry-configuration">Retry Configuration</a></h1>
<p>Prodigy provides sophisticated retry mechanisms with multiple backoff strategies to handle transient failures gracefully. The retry system supports both command-level and workflow-level configurations with fine-grained control over retry behavior.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Prodigy has two retry systems that work together:</p>
<ol>
<li><strong>Enhanced Retry System</strong> - Rich, configurable retry with multiple backoff strategies, jitter, circuit breakers, and conditional retry (from <code>src/cook/retry_v2.rs</code>)</li>
<li><strong>Workflow-Level Retry</strong> - Simpler retry configuration for workflow-level error policies (from <code>src/cook/workflow/error_policy.rs</code>)</li>
</ol>
<p>This chapter focuses on the enhanced retry system which provides comprehensive retry capabilities.</p>
<h2 id="retryconfig-structure"><a class="header" href="#retryconfig-structure">RetryConfig Structure</a></h2>
<p>The <code>RetryConfig</code> struct controls retry behavior with the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody>
<tr><td><code>attempts</code></td><td><code>u32</code></td><td><code>3</code></td><td>Maximum number of retry attempts</td></tr>
<tr><td><code>backoff</code></td><td><code>BackoffStrategy</code></td><td><code>Exponential</code></td><td>Strategy for calculating delays between retries</td></tr>
<tr><td><code>initial_delay</code></td><td><code>Duration</code></td><td><code>1s</code></td><td>Initial delay before first retry</td></tr>
<tr><td><code>max_delay</code></td><td><code>Duration</code></td><td><code>30s</code></td><td>Maximum delay between any two retries</td></tr>
<tr><td><code>jitter</code></td><td><code>bool</code></td><td><code>false</code></td><td>Whether to add randomness to delays</td></tr>
<tr><td><code>jitter_factor</code></td><td><code>f64</code></td><td><code>0.3</code></td><td>Amount of jitter (0.0 to 1.0)</td></tr>
<tr><td><code>retry_on</code></td><td><code>Vec&lt;ErrorMatcher&gt;</code></td><td><code>[]</code></td><td>Retry only on specific error types (empty = retry all)</td></tr>
<tr><td><code>retry_budget</code></td><td><code>Option&lt;Duration&gt;</code></td><td><code>None</code></td><td>Maximum total time for all retry attempts</td></tr>
<tr><td><code>on_failure</code></td><td><code>FailureAction</code></td><td><code>Stop</code></td><td>Action to take after all retries exhausted</td></tr>
</tbody></table>
</div>
<h3 id="duration-format"><a class="header" href="#duration-format">Duration Format</a></h3>
<p>All duration fields use the <code>humantime</code> format. Examples:</p>
<ul>
<li><code>1s</code> - 1 second</li>
<li><code>30s</code> - 30 seconds</li>
<li><code>5m</code> - 5 minutes</li>
<li><code>100ms</code> - 100 milliseconds</li>
</ul>
<h2 id="basic-retry-configuration"><a class="header" href="#basic-retry-configuration">Basic Retry Configuration</a></h2>
<p>The simplest retry configuration uses default values:</p>
<pre><code class="language-yaml">retry:
  attempts: 3
</code></pre>
<p>This will:</p>
<ul>
<li>Retry up to 3 times</li>
<li>Use exponential backoff (base 2.0)</li>
<li>Start with 1 second delay</li>
<li>Cap delays at 30 seconds</li>
</ul>
<h2 id="backoff-strategies"><a class="header" href="#backoff-strategies">Backoff Strategies</a></h2>
<p>Prodigy supports five backoff strategies for controlling delay between retries:</p>
<h3 id="fixed-backoff"><a class="header" href="#fixed-backoff">Fixed Backoff</a></h3>
<p>Same delay for every retry attempt:</p>
<pre><code class="language-yaml">retry:
  attempts: 5
  backoff: fixed
  initial_delay: 2s
</code></pre>
<p><strong>Delay sequence</strong>: 2s, 2s, 2s, 2s, 2s</p>
<p><strong>Use case</strong>: Simple retry logic when you want consistent delays.</p>
<h3 id="linear-backoff"><a class="header" href="#linear-backoff">Linear Backoff</a></h3>
<p>Delay increases by a fixed amount each retry:</p>
<pre><code class="language-yaml">retry:
  attempts: 4
  backoff:
    linear:
      increment: 2s
  initial_delay: 1s
</code></pre>
<p><strong>Delay sequence</strong>: 1s, 3s, 5s, 7s</p>
<p><strong>Use case</strong>: Gradual backoff when you expect quick recovery.</p>
<h3 id="exponential-backoff"><a class="header" href="#exponential-backoff">Exponential Backoff</a></h3>
<p>Delay doubles (or increases by <code>base</code> factor) each retry:</p>
<pre><code class="language-yaml">retry:
  attempts: 5
  backoff:
    exponential:
      base: 2.0
  initial_delay: 1s
  max_delay: 30s
</code></pre>
<p><strong>Delay sequence</strong>: 1s, 2s, 4s, 8s, 16s</p>
<p><strong>Use case</strong>: Most common strategy - backs off quickly to avoid overwhelming failing services. Default strategy.</p>
<h3 id="fibonacci-backoff"><a class="header" href="#fibonacci-backoff">Fibonacci Backoff</a></h3>
<p>Delay follows Fibonacci sequence:</p>
<pre><code class="language-yaml">retry:
  attempts: 6
  backoff: fibonacci
  initial_delay: 1s
</code></pre>
<p><strong>Delay sequence</strong>: 1s, 1s, 2s, 3s, 5s, 8s</p>
<p><strong>Use case</strong>: Smoother increase than exponential, good for distributed systems.</p>
<h3 id="custom-backoff"><a class="header" href="#custom-backoff">Custom Backoff</a></h3>
<p>Specify exact delays for each retry:</p>
<pre><code class="language-yaml">retry:
  attempts: 4
  backoff:
    custom:
      delays: [1s, 2s, 5s, 10s]
</code></pre>
<p><strong>Delay sequence</strong>: Exactly as specified</p>
<p><strong>Use case</strong>: When you need precise control over timing (e.g., aligning with rate limit windows).</p>
<h2 id="backoff-strategy-comparison"><a class="header" href="#backoff-strategy-comparison">Backoff Strategy Comparison</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Strategy</th><th>Attempt 1</th><th>Attempt 2</th><th>Attempt 3</th><th>Attempt 4</th><th>Attempt 5</th><th>Best For</th></tr></thead><tbody>
<tr><td>Fixed (2s)</td><td>2s</td><td>2s</td><td>2s</td><td>2s</td><td>2s</td><td>Simple retry</td></tr>
<tr><td>Linear (+2s)</td><td>1s</td><td>3s</td><td>5s</td><td>7s</td><td>9s</td><td>Gradual backoff</td></tr>
<tr><td>Exponential (base 2.0)</td><td>1s</td><td>2s</td><td>4s</td><td>8s</td><td>16s</td><td>Most failures</td></tr>
<tr><td>Fibonacci</td><td>1s</td><td>1s</td><td>2s</td><td>3s</td><td>5s</td><td>Distributed systems</td></tr>
</tbody></table>
</div>
<h2 id="jitter-for-distributed-systems"><a class="header" href="#jitter-for-distributed-systems">Jitter for Distributed Systems</a></h2>
<p>Jitter adds randomness to retry delays to prevent the “thundering herd” problem where many clients retry at the same time.</p>
<pre><code class="language-yaml">retry:
  attempts: 5
  backoff:
    exponential:
      base: 2.0
  initial_delay: 10s
  jitter: true
  jitter_factor: 0.5
</code></pre>
<p>With <code>jitter_factor: 0.5</code>:</p>
<ul>
<li>A 10s delay becomes a random delay between <strong>7.5s and 12.5s</strong></li>
<li>A 20s delay becomes a random delay between <strong>15s and 25s</strong></li>
</ul>
<p>The jitter range is calculated as: <code>delay ± (delay * jitter_factor / 2)</code></p>
<p><strong>When to use jitter</strong>:</p>
<ul>
<li>Multiple clients accessing the same service</li>
<li>Distributed systems with many workers</li>
<li>Rate-limited APIs</li>
<li>Preventing synchronized retry storms</li>
</ul>
<h2 id="conditional-retry-with-error-matchers"><a class="header" href="#conditional-retry-with-error-matchers">Conditional Retry with Error Matchers</a></h2>
<p>By default, Prodigy retries all errors. Use <code>retry_on</code> to retry only specific error types:</p>
<h3 id="network-errors"><a class="header" href="#network-errors">Network Errors</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  retry_on:
    - network
</code></pre>
<p>Matches errors containing: <code>network</code>, <code>connection</code>, <code>refused</code>, <code>unreachable</code></p>
<h3 id="timeout-errors"><a class="header" href="#timeout-errors">Timeout Errors</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 5
  retry_on:
    - timeout
  backoff:
    exponential:
      base: 2.0
  initial_delay: 2s
</code></pre>
<p>Matches errors containing: <code>timeout</code>, <code>timed out</code></p>
<h3 id="server-errors-http-5xx"><a class="header" href="#server-errors-http-5xx">Server Errors (HTTP 5xx)</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  retry_on:
    - server_error
</code></pre>
<p>Matches errors containing: <code>500</code>, <code>502</code>, <code>503</code>, <code>504</code>, <code>server error</code></p>
<h3 id="rate-limit-errors"><a class="header" href="#rate-limit-errors">Rate Limit Errors</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 5
  retry_on:
    - rate_limit
  initial_delay: 60s
</code></pre>
<p>Matches errors containing: <code>rate limit</code>, <code>429</code>, <code>too many requests</code></p>
<h3 id="custom-error-patterns"><a class="header" href="#custom-error-patterns">Custom Error Patterns</a></h3>
<p>Use regex patterns for custom error matching:</p>
<pre><code class="language-yaml">retry:
  attempts: 3
  retry_on:
    - pattern: "database connection|pool exhausted"
    - pattern: "ECONNRESET"
</code></pre>
<h3 id="multiple-error-types"><a class="header" href="#multiple-error-types">Multiple Error Types</a></h3>
<p>Retry on any matching error type:</p>
<pre><code class="language-yaml">retry:
  attempts: 5
  retry_on:
    - network
    - timeout
    - rate_limit
  backoff: fibonacci
  initial_delay: 1s
</code></pre>
<h2 id="retry-budget"><a class="header" href="#retry-budget">Retry Budget</a></h2>
<p>A retry budget limits the total time spent on retries to prevent indefinite retry loops:</p>
<pre><code class="language-yaml">retry:
  attempts: 10
  retry_budget: 5m
  backoff:
    exponential:
      base: 2.0
  initial_delay: 1s
</code></pre>
<p>In this example:</p>
<ul>
<li>Allows up to 10 retry attempts</li>
<li><strong>BUT</strong> stops retrying if total time exceeds 5 minutes</li>
<li>Useful for preventing workflows from hanging indefinitely</li>
</ul>
<p><strong>Without retry budget</strong>: Exponential backoff with 10 attempts could take hours
<strong>With retry budget</strong>: Guarantees workflow fails within 5 minutes</p>
<h2 id="failure-actions"><a class="header" href="#failure-actions">Failure Actions</a></h2>
<p>Configure what happens after all retries are exhausted:</p>
<h3 id="stop-workflow-default"><a class="header" href="#stop-workflow-default">Stop Workflow (Default)</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  on_failure: stop
</code></pre>
<p>Stops the entire workflow execution on final failure.</p>
<h3 id="continue-with-next-step"><a class="header" href="#continue-with-next-step">Continue with Next Step</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  on_failure: continue
</code></pre>
<p>Logs the failure but continues workflow execution.</p>
<h3 id="fallback-command"><a class="header" href="#fallback-command">Fallback Command</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  on_failure:
    fallback:
      command: "echo 'Primary command failed, using fallback'"
</code></pre>
<p>Executes a fallback command if primary command fails after all retries.</p>
<h2 id="complete-examples"><a class="header" href="#complete-examples">Complete Examples</a></h2>
<h3 id="retry-network-requests"><a class="header" href="#retry-network-requests">Retry Network Requests</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 5
  backoff:
    exponential:
      base: 2.0
  initial_delay: 1s
  max_delay: 30s
  jitter: true
  jitter_factor: 0.3
  retry_on:
    - network
    - timeout
    - server_error
  retry_budget: 2m
</code></pre>
<p><strong>Behavior</strong>:</p>
<ul>
<li>Retries up to 5 times on network/timeout/server errors</li>
<li>Exponential backoff: 1s, 2s, 4s, 8s, 16s (with jitter)</li>
<li>Total retry time limited to 2 minutes</li>
<li>Other errors (like syntax errors) fail immediately</li>
</ul>
<h3 id="retry-rate-limited-apis"><a class="header" href="#retry-rate-limited-apis">Retry Rate-Limited APIs</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  backoff: fibonacci
  initial_delay: 60s
  max_delay: 300s
  retry_on:
    - rate_limit
  retry_budget: 15m
</code></pre>
<p><strong>Behavior</strong>:</p>
<ul>
<li>Waits 60s, 60s, 120s between retries (Fibonacci sequence)</li>
<li>Only retries on rate limit errors (429, “rate limit exceeded”)</li>
<li>Gives up after 15 minutes total</li>
</ul>
<h3 id="retry-flaky-tests"><a class="header" href="#retry-flaky-tests">Retry Flaky Tests</a></h3>
<pre><code class="language-yaml">retry:
  attempts: 3
  backoff: fixed
  initial_delay: 500ms
  on_failure: continue
</code></pre>
<p><strong>Behavior</strong>:</p>
<ul>
<li>Quick retries with 500ms between attempts</li>
<li>Fixed delay (doesn’t increase)</li>
<li>Continues workflow even if test fails 3 times</li>
</ul>
<h3 id="retry-with-circuit-breaker"><a class="header" href="#retry-with-circuit-breaker">Retry with Circuit Breaker</a></h3>
<p>The <code>RetryExecutor</code> supports circuit breakers to prevent cascading failures:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use prodigy::cook::retry_v2::{RetryConfig, RetryExecutor};
use std::time::Duration;

let config = RetryConfig {
    attempts: 5,
    ..Default::default()
};

let executor = RetryExecutor::new(config)
    .with_circuit_breaker(
        3,                             // Open after 3 consecutive failures
        Duration::from_secs(30)        // Stay open for 30 seconds
    );

let result = executor
    .execute_with_retry(|| async {
        // Your operation here
        Ok("success")
    }, "my-operation")
    .await?;
<span class="boring">}</span></code></pre></pre>
<p><strong>Circuit breaker states</strong>:</p>
<ul>
<li><strong>Closed</strong>: Normal operation, requests pass through</li>
<li><strong>Open</strong>: Too many failures, immediately reject requests</li>
<li><strong>Half-Open</strong>: After timeout, test with limited requests</li>
</ul>
<h2 id="workflow-level-vs-command-level-retry"><a class="header" href="#workflow-level-vs-command-level-retry">Workflow-Level vs Command-Level Retry</a></h2>
<p>Prodigy has two retry systems that serve different purposes:</p>
<h3 id="command-level-retry-enhanced"><a class="header" href="#command-level-retry-enhanced">Command-Level Retry (Enhanced)</a></h3>
<p>Configured per command using <code>RetryConfig</code>:</p>
<pre><code class="language-yaml">commands:
  - shell: "curl https://api.example.com/data"
    retry:
      attempts: 5
      backoff: exponential
      retry_on: [network, timeout]
</code></pre>
<p><strong>Features</strong>:</p>
<ul>
<li>Rich backoff strategies (exponential, fibonacci, custom)</li>
<li>Jitter support</li>
<li>Conditional retry (error matchers)</li>
<li>Retry budget</li>
<li>Circuit breaker integration</li>
<li>Detailed retry metrics</li>
</ul>
<h3 id="workflow-level-retry-error-policy"><a class="header" href="#workflow-level-retry-error-policy">Workflow-Level Retry (Error Policy)</a></h3>
<p>Configured in workflow error policy from <code>error_policy.rs</code>:</p>
<pre><code class="language-yaml">error_policy:
  on_item_failure: retry
  retry_config:
    max_attempts: 3
    backoff:
      exponential:
        initial: 1s
        multiplier: 2.0
</code></pre>
<p><strong>Features</strong>:</p>
<ul>
<li>Simpler configuration</li>
<li>Workflow-level failure handling</li>
<li>Integrates with DLQ (Dead Letter Queue)</li>
<li>Circuit breaker support</li>
<li>Error metrics and pattern detection</li>
</ul>
<p><strong>When to use each</strong>:</p>
<ul>
<li><strong>Command-level</strong>: For specific commands that need sophisticated retry logic</li>
<li><strong>Workflow-level</strong>: For consistent retry behavior across all workflow items in MapReduce jobs</li>
</ul>
<h3 id="command-metadata-override"><a class="header" href="#command-metadata-override">Command Metadata Override</a></h3>
<p>Individual commands can override workflow-level retry settings:</p>
<pre><code class="language-yaml"># Workflow default
retry:
  attempts: 3

# Command override
commands:
  - claude: "/analyze ${item}"
    metadata:
      retries: 5  # This command gets 5 attempts instead of 3
</code></pre>
<p>From <code>src/config/command.rs:135</code>.</p>
<h2 id="retry-metrics-and-observability"><a class="header" href="#retry-metrics-and-observability">Retry Metrics and Observability</a></h2>
<p>The retry system tracks metrics for monitoring:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let executor = RetryExecutor::new(config);
// ... execute operations ...
let metrics = executor.metrics().await;

println!("Total attempts: {}", metrics.total_attempts);
println!("Successful: {}", metrics.successful_attempts);
println!("Failed: {}", metrics.failed_attempts);
println!("Retry history: {:?}", metrics.retries);
<span class="boring">}</span></code></pre></pre>
<p>Metrics include:</p>
<ul>
<li><code>total_attempts</code> - Total number of attempts made</li>
<li><code>successful_attempts</code> - Number of successful operations</li>
<li><code>failed_attempts</code> - Number of failed operations</li>
<li><code>retries</code> - Vec of (attempt_number, delay) pairs</li>
</ul>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="choosing-a-backoff-strategy"><a class="header" href="#choosing-a-backoff-strategy">Choosing a Backoff Strategy</a></h3>
<ol>
<li><strong>Use Exponential for most cases</strong> - Default strategy, works well for most failures</li>
<li><strong>Use Fibonacci for distributed systems</strong> - Smoother curve, avoids overwhelming services</li>
<li><strong>Use Linear for quick recovery scenarios</strong> - When failures are brief and predictable</li>
<li><strong>Use Fixed only for very specific cases</strong> - When you know exact timing requirements</li>
<li><strong>Use Custom for rate-limited APIs</strong> - Align retries with API rate limit windows</li>
</ol>
<h3 id="setting-appropriate-timeouts"><a class="header" href="#setting-appropriate-timeouts">Setting Appropriate Timeouts</a></h3>
<ul>
<li><strong>initial_delay</strong>: Start small (1-2s) for transient errors, larger (30-60s) for rate limits</li>
<li><strong>max_delay</strong>: Cap at reasonable time (30s for interactive, 5m for background jobs)</li>
<li><strong>retry_budget</strong>: Always set this to prevent infinite retry loops
<ul>
<li>Interactive operations: 1-5 minutes</li>
<li>Background jobs: 15-30 minutes</li>
<li>Critical operations: 1 hour</li>
</ul>
</li>
</ul>
<h3 id="using-jitter"><a class="header" href="#using-jitter">Using Jitter</a></h3>
<p>Enable jitter when:</p>
<ul>
<li>✅ Multiple clients/workers accessing the same service</li>
<li>✅ Distributed systems with parallel execution</li>
<li>✅ Rate-limited APIs</li>
<li>❌ Single client applications</li>
<li>❌ When exact timing is critical</li>
</ul>
<h3 id="conditional-retry"><a class="header" href="#conditional-retry">Conditional Retry</a></h3>
<p>Always use <code>retry_on</code> to avoid retrying permanent failures:</p>
<pre><code class="language-yaml"># ❌ BAD: Retries syntax errors forever
retry:
  attempts: 10
  backoff: exponential

# ✅ GOOD: Only retries transient failures
retry:
  attempts: 10
  retry_on: [network, timeout, server_error]
  backoff: exponential
</code></pre>
<h3 id="retry-budget-guidelines"><a class="header" href="#retry-budget-guidelines">Retry Budget Guidelines</a></h3>
<p>Set retry budgets based on operation criticality:</p>
<div class="table-wrapper"><table><thead><tr><th>Operation Type</th><th>Suggested Budget</th><th>Reasoning</th></tr></thead><tbody>
<tr><td>User-facing API calls</td><td>5-10 seconds</td><td>User is waiting</td></tr>
<tr><td>Background sync</td><td>5-15 minutes</td><td>Can afford patience</td></tr>
<tr><td>Critical data operations</td><td>30-60 minutes</td><td>Must complete</td></tr>
<tr><td>Non-critical tasks</td><td>1-5 minutes</td><td>Fail fast</td></tr>
</tbody></table>
</div>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="retries-taking-too-long"><a class="header" href="#retries-taking-too-long">Retries Taking Too Long</a></h3>
<p><strong>Problem</strong>: Workflow hangs during retries</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Add a <code>retry_budget</code> to cap total retry time</li>
<li>Reduce <code>max_delay</code> to speed up retry cycles</li>
<li>Reduce <code>attempts</code> to fail faster</li>
<li>Use <code>linear</code> or <code>fibonacci</code> instead of <code>exponential</code></li>
</ol>
<h3 id="not-retrying-when-expected"><a class="header" href="#not-retrying-when-expected">Not Retrying When Expected</a></h3>
<p><strong>Problem</strong>: Operation fails without retrying</p>
<p><strong>Causes</strong>:</p>
<ol>
<li>Error doesn’t match <code>retry_on</code> patterns</li>
<li>Already at max <code>attempts</code></li>
<li><code>retry_budget</code> exhausted</li>
<li>Circuit breaker is open</li>
</ol>
<p><strong>Debug</strong>:</p>
<ul>
<li>Remove <code>retry_on</code> to retry all errors</li>
<li>Check error message matches patterns (case-insensitive)</li>
<li>Increase <code>retry_budget</code> or <code>attempts</code></li>
<li>Check circuit breaker status</li>
</ul>
<h3 id="thundering-herd-problem"><a class="header" href="#thundering-herd-problem">Thundering Herd Problem</a></h3>
<p><strong>Problem</strong>: Many workers retry at the same time, overwhelming service</p>
<p><strong>Solution</strong>:</p>
<pre><code class="language-yaml">retry:
  attempts: 5
  jitter: true
  jitter_factor: 0.5  # 50% jitter range
  backoff: fibonacci   # Smoother than exponential
</code></pre>
<h3 id="rate-limit-issues"><a class="header" href="#rate-limit-issues">Rate Limit Issues</a></h3>
<p><strong>Problem</strong>: Keep hitting rate limits despite retries</p>
<p><strong>Solution</strong>:</p>
<pre><code class="language-yaml">retry:
  attempts: 3
  retry_on:
    - rate_limit
  backoff: custom
    delays: [60s, 120s, 300s]  # Align with rate limit window
  retry_budget: 15m
</code></pre>
<h2 id="related-topics"><a class="header" href="#related-topics">Related Topics</a></h2>
<ul>
<li><a href="./error-handling.html">Error Handling</a> - Overall error handling strategy</li>
<li><a href="./workflow-configuration.html">Workflow Configuration</a> - Workflow-level settings</li>
<li><a href="./mapreduce.html">MapReduce</a> - Retry in MapReduce workflows</li>
<li><a href="./dead-letter-queue.html">Dead Letter Queue</a> - Handling failed items</li>
</ul>
<h2 id="implementation-references"><a class="header" href="#implementation-references">Implementation References</a></h2>
<ul>
<li>Enhanced retry system: <code>src/cook/retry_v2.rs:14-461</code></li>
<li>Workflow error policy: <code>src/cook/workflow/error_policy.rs:91-129</code></li>
<li>Command metadata: <code>src/config/command.rs:135</code></li>
<li>Circuit breaker: <code>src/cook/retry_v2.rs:325-397</code></li>
<li>Error matchers: <code>src/cook/retry_v2.rs:100-151</code></li>
<li>Retry metrics: <code>src/cook/retry_v2.rs:399-422</code></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="composition.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="error-handling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="composition.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="error-handling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
