<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Composition Metadata - Prodigy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="AI-powered workflow orchestration for development teams">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prodigy Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/iepathos/prodigy/edit/main/book/src/composition/composition-metadata.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="composition-metadata"><a class="header" href="#composition-metadata">Composition Metadata</a></h2>
<p>Prodigy tracks metadata about workflow composition for debugging and dependency analysis. This metadata provides visibility into how workflows are composed, what dependencies exist, and when composition occurred.</p>
<blockquote>
<p><strong>Implementation Status</strong>: The composition metadata types and dependency tracking are fully implemented in the core composition system. These features are accessible programmatically via the WorkflowComposer API. CLI integration for viewing composition metadata in workflows is under development (Spec 131-133).</p>
</blockquote>
<h3 id="compositionmetadata-structure"><a class="header" href="#compositionmetadata-structure">CompositionMetadata Structure</a></h3>
<p>Every composed workflow includes metadata tracking all composition operations:</p>
<p><strong>Source</strong>: <code>src/cook/workflow/composition/mod.rs:153-170</code></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Metadata about workflow composition
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CompositionMetadata {
    /// Source files involved in composition
    pub sources: Vec&lt;PathBuf&gt;,

    /// Templates used
    pub templates: Vec&lt;String&gt;,

    /// Parameters applied
    pub parameters: HashMap&lt;String, Value&gt;,

    /// Composition timestamp
    pub composed_at: chrono::DateTime&lt;chrono::Utc&gt;,

    /// Dependency graph
    pub dependencies: Vec&lt;DependencyInfo&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Field Details</strong>:</p>
<ul>
<li><code>sources</code>: File paths of all workflow files involved in composition (as <code>PathBuf</code> objects)</li>
<li><code>templates</code>: Template names/sources used during composition</li>
<li><code>parameters</code>: Final parameter values applied to the workflow (as <code>serde_json::Value</code>)</li>
<li><code>composed_at</code>: ISO 8601 timestamp when composition occurred (UTC timezone)</li>
<li><code>dependencies</code>: Complete dependency graph with all imports, extends, templates, and sub-workflows</li>
</ul>
<h3 id="dependency-tracking"><a class="header" href="#dependency-tracking">Dependency Tracking</a></h3>
<p>Each dependency includes detailed information:</p>
<p><strong>Source</strong>: <code>src/cook/workflow/composition/mod.rs:172-183</code></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Information about workflow dependencies
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DependencyInfo {
    /// Source of the dependency
    pub source: PathBuf,

    /// Type of dependency
    pub dep_type: DependencyType,

    /// Resolved path or name
    pub resolved: String,
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Field Details</strong>:</p>
<ul>
<li><code>source</code>: Source file path of the dependency (as <code>PathBuf</code>)</li>
<li><code>dep_type</code>: Type of dependency (Import, Extends, Template, or SubWorkflow)</li>
<li><code>resolved</code>: Resolved file path or template name (as <code>String</code>)</li>
</ul>
<h3 id="dependency-types"><a class="header" href="#dependency-types">Dependency Types</a></h3>
<p>Prodigy tracks four types of dependencies:</p>
<p><strong>Source</strong>: <code>src/cook/workflow/composition/mod.rs:185-193</code></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Type of workflow dependency
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum DependencyType {
    Import,
    Extends,
    Template,
    SubWorkflow,
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Import Dependencies:</strong></p>
<pre><code class="language-yaml">imports:
  - path: "shared/utilities.yml"

# Creates DependencyInfo:
# dep_type: DependencyType::Import
# source: PathBuf::from("shared/utilities.yml")
# resolved: "/full/path/to/shared/utilities.yml"
</code></pre>
<p><strong>Extends Dependencies:</strong></p>
<pre><code class="language-yaml">extends: "base-config.yml"

# Creates DependencyInfo:
# dep_type: DependencyType::Extends
# source: PathBuf::from("base-config.yml")
# resolved: "/full/path/to/base-config.yml"
</code></pre>
<p><strong>Template Dependencies:</strong></p>
<pre><code class="language-yaml">template:
  source:
    registry: "ci-pipeline"

# Creates DependencyInfo:
# dep_type: DependencyType::Template
# source: PathBuf::from("registry:ci-pipeline")
# resolved: "~/.prodigy/templates/ci-pipeline.yml"
</code></pre>
<p><strong>SubWorkflow Dependencies:</strong></p>
<pre><code class="language-yaml">sub_workflows:
  - name: "tests"
    source: "workflows/test.yml"

# Creates DependencyInfo:
# dep_type: DependencyType::SubWorkflow
# source: PathBuf::from("workflows/test.yml")
# resolved: "/full/path/to/workflows/test.yml"
</code></pre>
<h3 id="viewing-composition-metadata"><a class="header" href="#viewing-composition-metadata">Viewing Composition Metadata</a></h3>
<blockquote>
<p><strong>Note</strong>: CLI commands for viewing composition metadata in workflow execution are under development. Currently, metadata can be accessed programmatically via the WorkflowComposer API (see <a href="#programmatic-access">Programmatic Access</a> below).</p>
</blockquote>
<p><strong>Future CLI Usage</strong> (planned):</p>
<pre><code class="language-bash"># Show composition metadata (planned feature)
prodigy run workflow.yml --dry-run --show-composition
</code></pre>
<p><strong>Expected Output:</strong></p>
<pre><code>Composition Metadata:
  Composed at: 2025-01-11T20:00:00Z

  Sources (3):
    - /path/to/workflow.yml
    - /path/to/base-config.yml
    - /path/to/shared/utilities.yml

  Templates (1):
    - registry:ci-pipeline

  Dependencies (3):
    [Import] shared/utilities.yml -&gt; /path/to/shared/utilities.yml
    [Extends] base-config.yml -&gt; /path/to/base-config.yml
    [Template] registry:ci-pipeline -&gt; ~/.prodigy/templates/ci-pipeline.yml

  Parameters (2):
    environment: "production"
    timeout: 600
</code></pre>
<h3 id="programmatic-access"><a class="header" href="#programmatic-access">Programmatic Access</a></h3>
<p>Access metadata in code using the WorkflowComposer API:</p>
<p><strong>Source</strong>: <code>src/cook/workflow/composition/composer.rs:21-37</code></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use prodigy::cook::workflow::composition::{WorkflowComposer, TemplateRegistry};
use std::collections::HashMap;
use std::sync::Arc;
use std::path::Path;

// Create composer with template registry
let registry = Arc::new(TemplateRegistry::new());
let composer = WorkflowComposer::new(registry);

// Compose workflow with parameters
let params = HashMap::new();
let composed = composer.compose(Path::new("workflow.yml"), params).await?;

// Access metadata
let metadata = &amp;composed.metadata;

// Inspect dependencies
for dep in &amp;metadata.dependencies {
    println!("{:?}: {} -&gt; {}",
        dep.dep_type,
        dep.source.display(),
        dep.resolved
    );
}

// Check composition timestamp
println!("Composed at: {}", metadata.composed_at);

// View final parameters
for (name, value) in &amp;metadata.parameters {
    println!("Parameter {}: {:?}", name, value);
}

// List source files
println!("Sources:");
for source in &amp;metadata.sources {
    println!("  - {}", source.display());
}

// List templates used
println!("Templates:");
for template in &amp;metadata.templates {
    println!("  - {}", template);
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Real-World Example</strong> (from <code>src/cook/workflow/composition/composer.rs:45-51</code>):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Metadata is created during composition
let mut metadata = CompositionMetadata {
    sources: vec![source.to_path_buf()],
    templates: Vec::new(),
    parameters: params.clone(),
    composed_at: chrono::Utc::now(),
    dependencies: Vec::new(),
};
<span class="boring">}</span></code></pre></pre>
<h3 id="dependency-graph-visualization"><a class="header" href="#dependency-graph-visualization">Dependency Graph Visualization</a></h3>
<p>Metadata enables dependency visualization:</p>
<pre><code>workflow.yml
├─ [Extends] base-config.yml
│  └─ [Import] shared/setup.yml
├─ [Import] shared/utilities.yml
└─ [Template] registry:ci-pipeline
   └─ [SubWorkflow] workflows/test.yml
</code></pre>
<h3 id="use-cases"><a class="header" href="#use-cases">Use Cases</a></h3>
<p><strong>Debugging Composition Issues:</strong></p>
<ul>
<li>Verify which files were loaded</li>
<li>Check parameter resolution order</li>
<li>Identify circular dependencies</li>
<li>Trace inheritance chains</li>
</ul>
<p><strong>Dependency Analysis:</strong></p>
<ul>
<li>Find all workflows using a template</li>
<li>Identify shared imports</li>
<li>Map workflow relationships</li>
<li>Audit composition complexity</li>
</ul>
<p><strong>Change Impact Assessment:</strong></p>
<pre><code class="language-bash"># Before changing base-config.yml, find all dependents
grep -r "extends.*base-config" workflows/

# View composition metadata programmatically
# (CLI integration for --show-composition is under development)
</code></pre>
<p><strong>Compliance and Auditing:</strong></p>
<ul>
<li>Track template versions used</li>
<li>Record composition timestamps</li>
<li>Document parameter sources</li>
<li>Verify configuration origins</li>
</ul>
<h3 id="metadata-in-composed-workflows"><a class="header" href="#metadata-in-composed-workflows">Metadata in Composed Workflows</a></h3>
<p>Composed workflows carry metadata through the composition process:</p>
<p><strong>Source</strong>: <code>src/cook/workflow/composition/mod.rs:143-151</code></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ComposedWorkflow structure
pub struct ComposedWorkflow {
    /// The composed workflow
    pub workflow: ComposableWorkflow,

    /// Metadata about the composition
    pub metadata: CompositionMetadata,
}

// Access metadata from composed workflow
let composed = composer.compose(source, params).await?;
println!("This workflow was composed from {} sources",
    composed.metadata.sources.len());
<span class="boring">}</span></code></pre></pre>
<h3 id="circular-dependency-detection"><a class="header" href="#circular-dependency-detection">Circular Dependency Detection</a></h3>
<p>Metadata enables circular dependency detection:</p>
<pre><code class="language-yaml"># workflow-a.yml
extends: "workflow-b.yml"

# workflow-b.yml
extends: "workflow-a.yml"
</code></pre>
<p><strong>Detection:</strong></p>
<pre><code>Error: Circular dependency detected
  workflow-a.yml -&gt; workflow-b.yml -&gt; workflow-a.yml

Dependency chain:
  1. workflow-a.yml (extends workflow-b.yml)
  2. workflow-b.yml (extends workflow-a.yml) &lt;- Circular!
</code></pre>
<h3 id="parameter-tracking"><a class="header" href="#parameter-tracking">Parameter Tracking</a></h3>
<p>Metadata tracks final parameter values applied during composition:</p>
<pre><code class="language-yaml"># workflow.yml
parameters:
  definitions:
    environment:
      type: string
      required: true
    timeout:
      type: integer
      default: 600
</code></pre>
<p><strong>Metadata captures:</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>metadata.parameters = {
    "environment": "production",
    "timeout": 600,
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>parameters</code> field in <code>CompositionMetadata</code> stores the final resolved parameter values as a <code>HashMap&lt;String, Value&gt;</code>. This enables reproducibility and debugging of composed workflows.</p>
<h3 id="caching-and-performance"><a class="header" href="#caching-and-performance">Caching and Performance</a></h3>
<p>Composition metadata enables future caching optimizations:</p>
<ul>
<li><code>composed_at</code> timestamp can be used for cache invalidation</li>
<li><code>sources</code> list enables dependency-based cache busting</li>
<li><code>dependencies</code> graph supports incremental composition</li>
<li><code>parameters</code> hash can detect identical compositions</li>
</ul>
<blockquote>
<p><strong>Note</strong>: Workflow caching is a planned feature. Currently, metadata is generated fresh on each composition.</p>
</blockquote>
<h3 id="data-structure-properties"><a class="header" href="#data-structure-properties">Data Structure Properties</a></h3>
<p>CompositionMetadata uses standard Rust types for broad compatibility:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CompositionMetadata {
    // All fields use standard types
    pub sources: Vec&lt;PathBuf&gt;,           // Cloneable
    pub templates: Vec&lt;String&gt;,          // Cloneable
    pub parameters: HashMap&lt;String, Value&gt;,  // Cloneable
    pub composed_at: chrono::DateTime&lt;chrono::Utc&gt;,  // Copy
    pub dependencies: Vec&lt;DependencyInfo&gt;,   // Cloneable
}
<span class="boring">}</span></code></pre></pre>
<p>The struct derives <code>Clone</code>, making it easy to share metadata across components without requiring explicit synchronization primitives.</p>
<h3 id="related-topics"><a class="header" href="#related-topics">Related Topics</a></h3>
<ul>
<li><a href="template-system.html">Template System</a> - Template caching and loading</li>
<li><a href="workflow-extension-inheritance.html">Workflow Extension</a> - Inheritance tracking</li>
<li><a href="best-practices.html">Best Practices</a> - Using metadata for debugging</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../composition/sub-workflows.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../composition/complete-examples.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../composition/sub-workflows.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../composition/complete-examples.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
